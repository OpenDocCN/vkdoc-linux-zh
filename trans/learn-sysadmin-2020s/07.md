# 7.监视

任何新的 Linux 系统在被贵组织的生产或现场环境接受之前，必须具备哪些最重要的特性？给出的常见答案是监控、日志记录和安全性。同样有充分理由的是，任何没有被监控、记录或保护的系统都只会导致灾难，并且几乎在每一种情况下都会被任何严肃的运营团队拒绝。

本章将深入探讨 Linux 系统应该具备的首要功能之一:监控。我们将讨论过去使用过的工具，以及大多数 Linux 发行版都有哪些现成的工具。然后，我们将看看过去五年中使用的一些更新的工具和趋势。

最后，我们将从监控的角度讨论开发人员和应用程序的要求，如何更好地监控应用程序，以及如何与开发人员讨论如何开发应用程序来支持这一点。本章不会给出所有不同监控用例的所有答案。它将告诉您可以做些什么，以及哪些工具可以帮助您解决当前的一些监控问题。它甚至会产生一些你没有意识到你需要问的问题。

## Linux 监控工具

几乎从 Linux 出现开始，就有工具可以监控系统上发生的事情。这些工具可以像“`top`”命令一样简单，也可以像使用 systemtap 一样复杂，以了解当一个新设备添加到您的系统中时内核正在做什么。

一旦你知道了如何使用 Linux 系统的基本知识，下一个合乎逻辑的步骤应该是知道如何确认你的系统是健康的，以及如何确保它保持健康。为此，有许多不同的工具可以显示您的系统状态。

### 程序控制

#### 默认过程命令，ps 和 top

默认情况下，在大多数(如果不是全部的话)Linux 发行版上，您会发现“`top`”和“`ps`”命令。它们不仅向您显示系统上运行的所有进程，还会给您进程 ID 号，该 ID 号可用于终止已失效或挂起的进程。

如果您不确定某个特定的进程是否正在运行，例如 apache web 服务，您可以运行类似下面的命令:

```sh
# ps -ef | grep httpd

```

也可以使用“top”或其他命令，但是您可能很难在列表中搜索您的流程。使用“`ps`”和“`grep`”将使输出更快更清晰。

Note

在第 [2](02.html) 章中，我们看了“top”和其他一些工具，它们可以用来查找系统中正在运行的进程。我们还讨论了如何杀死进程以及如何识别僵尸进程。

#### 查看进程

查看所有进程和每个进程的父进程的一个快速而好的工具是“pstree”命令。以下是 pstree 的基本输出，但输出有所减少:

```sh
# pstree
systemd─┬─ModemManager───3*[{ModemManager}]
        ├─NetworkManager───2*[{NetworkManager}]
        ├─abrt-dbus───2*[{abrt-dbus}]
        ├─3*[abrt-dump-journ]
        ├─abrtd───2*[{abrtd}]
        ... [reduced for length]
        ├─thermald───{thermald}
        ├─udisksd───4*[{udisksd}]
        ├─upowerd───2*[{upowerd}]
        ├─uresourced───2*[{uresourced}]
        └─wpa_supplicant

```

#### 资源密集型流程

“ps”命令有用还有另一个原因。我相信你经历过一个占用大量 CPU 或内存的过程。如果您试图弄清楚进程是如何从“top”或类似的命令中消耗资源的，那么发现有问题的进程有时会有点棘手。以下是两个“`ps`”命令，您可以使用它们来查找前五个 CPU 和内存密集型进程。

##### 内存密集型进程

```sh
# ps -auxf | sort -nr -k 4 | head -5

```

##### CPU 密集型进程

```sh
# ps -auxf | sort -nr -k 3 | head -5

```

Tip

有关使用 ps 的更多选项，请查看 ps 帮助和 ps 手册页。

### 磁盘和 IO

可能会出现磁盘性能缓慢或磁盘已满的情况。一些可以用于磁盘和 IO 监控的有用工具现在仍在使用，如"`iostat`、" "`iotop`、" "`du`、"`df`"

#### iostat 和 iotop

“`iostat`”和“`iotop`”是提供输入输出系统信息的基本工具:

```sh
# iostat
Linux 5.13.4-200.fc34.x86_64 (localhost.localdomain)       22/11/21      _x86_64_       (4 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
          28.17    0.06   12.21    0.11    0.00   59.46

Device             tps    kB_read/s    kB_wrtn/s    kB_dscd/s    kB_read    kB_wrtn    kB_dscd
dm-0              1.16         1.79        59.42        24.16   16712024  554638596  225476964
nvme0n1           1.15         1.79        59.43        24.24   16724756  554741532  226295700
zram0             0.20         0.16         0.64         0.00    1482776    6013392          0

# iotop
Total DISK READ:         0.00 B/s | Total DISK WRITE:    108.61 K/s
Current DISK READ:       0.00 B/s | Current DISK WRITE:    3.19 K/s
    TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO>    COMMAND
 733973 be/4 ken         0.00 B/s   57.50 K/s  0.00 %  0.00 % chrome --type=utility --utility-sub-type=network.mojom.NetworkService --field-trial-han~be2ad25, --shared-files=v8_context_snapshot_data:100 --enable-crashpad [ThreadPoolForeg]
 729143 be/4 root        0.00 B/s   51.11 K/s  0.00 %  0.00 % [kworker/u8:6-btrfs-endio-write]
      1 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % systemd rhgb --system --deserialize 51
      2 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [kthreadd]
      3 be/0 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [rcu_gp]
      4 be/0 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [rcu_par_gp]

```

#### 杜和 df

这些用于显示磁盘使用情况和磁盘安装位置:

```sh
# df -h
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs         12G     0   12G   0% /dev
tmpfs            12G  181M   12G   2% /dev/shm
tmpfs           4.7G  2.0M  4.7G   1% /run
/dev/dm-0       238G   93G  144G  40% /
tmpfs            12G   61M   12G   1% /tmp
/dev/dm-0       238G   93G  144G  40% /home
/dev/nvme0n1p1  976M  272M  638M  30% /boot
tmpfs           2.4G  216K  2.4G   1% /run/user/1000

# du -h /etc
0       /etc/.java/.systemPrefs
8.0K    /etc/.java/deployment
8.0K    /etc/.java
0       /etc/NetworkManager/conf.d
0       /etc/NetworkManager/dispatcher.d/no-wait.d
0       /etc/NetworkManager/dispatcher.d/pre-down.d
0       /etc/NetworkManager/dispatcher.d/pre-up.d
0       /etc/NetworkManager/dispatcher.d
0       /etc/NetworkManager/dnsmasq-shared.d
0       /etc/NetworkManager/dnsmasq.d
28K     /etc/NetworkManager/system-connections
32K     /etc/NetworkManager
... [reduced for length]
80K     /etc/gimp/2.0
80K     /etc/gimp
28K    /etc/pcp/derived
28K    /etc/pcp
37M    /etc/

```

### 中央处理器

可以使用发行版附带的许多工具和可以很容易安装的工具来检查系统上的 CPU 统计数据。下面是两个比较常用的工具。

#### 顶端

大多数 Linux 系统管理员会使用 top 命令并按“1”键。这将产生类似于以下内容的输出:

```sh
top - 23:56:10 up 108 days,  1:38,  1 user,  load average: 1.31, 1.73, 1.54
Tasks: 373 total,   2 running, 370 sleeping,   0 stopped,   1 zombie
%Cpu0  : 10.0 us,  2.3 sy,  0.0 ni, 87.0 id,  0.0 wa,  0.3 hi,  0.3 si,  0.0 st
%Cpu1  :  6.6 us,  7.9 sy,  0.0 ni, 83.8 id,  0.0 wa,  1.0 hi,  0.7 si,  0.0 st
%Cpu2  : 10.7 us,  3.3 sy,  0.0 ni, 85.3 id,  0.0 wa,  0.3 hi,  0.3 si,  0.0 st
%Cpu3  : 10.3 us,  3.6 sy,  0.0 ni, 83.4 id,  0.3 wa,  2.0 hi,  0.3 si,  0.0 st
MiB Mem :  23679.7 total,   3091.2 free,  13131.6 used,   7456.8 buff/cache
MiB Swap:   8192.0 total,   6207.6 free,   1984.4 used.   8940.7 avail Mem

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
   2021 ken       20   0 1448452 123008  73736 S  18.2   0.5 252:05.89 Xorg
 728039 ken       20   0  749048  52472  36696 S   6.9   0.2   6:54.61 gnome-system-mo

```

从前面的输出中，您可以看到我的笔记本电脑中有四个内核。可以看到平均负载大约为 1.33，这意味着我的四个 CPU 中大约有 1.33 个正在用于运行进程。

#### 系统的工具

另一个有用的 CPU 统计命令是 mpstat 命令。“`mpstat`”命令显示每个可用 CPU 的活动。

要查看每个 CPU 的所有统计信息，可以运行以下命令:

```sh
# mpstat -P ALL

```

### 记忆

检查系统内存的一些方法包括查看/proc/meminfo 文件或运行类似“free”或“top”的命令。以下是您可以在系统上做的一些事情，以便更好地了解它的内存。

#### 自由的

提供系统内存所需的所有信息的基本实用程序:

```sh
# free -h
        total    used    free   shared   buff/cache   available
Mem:     23Gi    12Gi   3.2Gi    1.2Gi        7.2Gi       8.8Gi
Swap:   8.0Gi   1.9Gi   6.1Gi

```

#### 页面大小

如果您需要了解系统的页面大小，可以使用以下命令:

```sh
# getconf PAGESIZE

```

#### 巨大的页面尺寸

在进行应用服务器调整时，可能会要求您启用或检查是否启用了大页面调整。您可以在/proc/meminfo 文件中检查这一点:

```sh
# cat /proc/meminfo |grep Hugepage
Hugepagesize:       2048 kB

```

#### 最不发达国家

另一个有用的工具是“`pmap`”实用程序。"`pmap`"报告一个进程的内存映射。`pmap`“可以很有用的找到内存瓶颈的原因。

### 虚拟内存

偶尔确实会发生需要研究虚拟内存或 slabinfo 相关问题的情况。“vmstat”工具对于这种调查很有用。

#### 显示虚拟内存状态

可以运行 vmstat 工具来提供关于您的系统的不同信息。

运行基本 vmstat 命令，如下所示:

```sh
# vmstat

```

将给出以下输出，在表 [7-1](#Tab1) 中有解释:

表 7-1

vmstat 输出说明

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"></colgroup> 
| 

vmstat 列

 | 

描述

 |
| --- | --- |
| `r` | 等待运行时的进程数 |
| `b` | 处于不间断睡眠状态的进程数 |
| `swpd` | 使用的虚拟内存 |
| `free` | 空闲内存 |
| `buff` | 用作缓冲区的内存 |
| `cache` | 用作缓存的内存 |
| `si` | 从磁盘换入的内存 |
| `so` | 内存交换到磁盘 |
| `bi` | 从块设备接收的块 |
| `bo` | 发送到块设备的块 |
| `in` | 每秒中断数 |
| `cs` | 每秒的上下文切换次数 |
| `us` | 运行非内核代码的时间百分比 |
| `sy` | 运行内核代码的时间百分比 |
| `id` | 空闲时间的百分比 |
| `wa` | 等待 IO 所用时间的百分比 |

```sh
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b  swpd     free     buff  cache    si  so  bi   bo  in  cs us sy id wa st
 0  0  2032024  2086144  1056  8923084   2   8  21  701  40  50 28 12 59  0  0

```

### 网络

当您需要排除故障或确认端口正在监听流量时，监控网络配置或流量的工具非常有用。以下是我过去用过的几个工具。

#### Netstat

当我需要检查端口是否在监听流量时，我倾向于使用的第一个工具是“`netstat`”命令。

“`netstat`”命令将显示网络连接、接口统计等。我用来检查哪些端口正在监听的最常用命令如下:

```sh
# nestat -nap | grep LIST
# netstat -planet

```

Note

Netstat 仍然是 net-tools 包的一部分，但在某个时候将被删除，因为 netstat 现在已经过时了；最好使用 ss 命令。

#### 悬浮物

要获得一些关于套接字统计的快速信息，可以使用“`ss`”命令。

要在带有 ss 的 Linux 系统上查看所有 TCP 和 UDP 套接字，可以使用以下命令:

```sh
# ss -t -a

```

#### 伊普鲁

如果您喜欢使用 initiative 工具来查看网络统计数据，您可以使用“`iptraf`”命令。“iptraf”可用于监控各种网络统计数据，包括 TCP 信息、UDP 计数、接口负载信息、IP 校验和错误以及其他有用信息的负载(图 [7-1](#Fig1) )。

![](../images/518154_1_En_7_Chapter/518154_1_En_7_Fig1_HTML.jpg)

图 7-1。

```sh
# iptraf-ng

```

图 [7-1](#Fig1) 是打开 iptraf-ng 时呈现给你的画面。

当我需要监控特定接口的流量时，这个工具帮了我不少忙。它不是默认安装的，但是如果你还没有安装的话，绝对值得使用。

从主屏幕，您可以选择监控 IP 流量；在那里，您选择想要监控的接口，然后观察该接口上的连通性。

#### Tcpdump

大多数(如果不是全部)网络工程师会使用 wireshark 来监控网络流量。“`tcpdump`”命令允许 Linux sysadmin 转储特定网络接口、所有接口或特定服务(如 DHCP 或 DNS)上的流量。

如果您想要监控接口 eth0 上所有向端口 80 发送流量的流量，对于 web 服务器，您可以运行类似的命令:

```sh
# tcpdump -n -i eth0 -s 0 -w tcpdumpoutput.txt src or dst port 80

```

然后可以使用 wireshark 工具打开前面命令的输出文件(图 [7-2](#Fig2) )。

![](../images/518154_1_En_7_Chapter/518154_1_En_7_Fig2_HTML.jpg)

图 7-2。

Note

一个有用的方法来寻找任何可能在您的网络上传输的明文。

#### 网虫

如果您在 Linux 系统上遇到网络负载的高突发，并且想知道谁应该对此负责，您可以尝试“nethogs”工具来查看哪个 PID 导致了带宽情况(图 [7-3](#Fig3) )。

![](../images/518154_1_En_7_Chapter/518154_1_En_7_Fig3_HTML.jpg)

图 7-3。

```sh
# nethogs

```

NetHogs 按进程名(如 Firefox 和 chrome)对带宽进行分组，如图 [7-3](#Fig3) 所示。

#### iftop

这是一个非常类似于“top”的简单命令，但用于界面信息(图 [7-4](#Fig4) )。

![](../images/518154_1_En_7_Chapter/518154_1_En_7_Fig4_HTML.jpg)

图 7-4。

```sh
# iftop

```

从图 [7-4](#Fig4) 中，您可以看到 iftop 的布局类似于常规的 top 输出，只是更侧重于网络数据。

### 图形工具

#### Gnome 系统监视器

像 Gnome 这样的 Linux 桌面并不是没有你可以使用的监控工具。熟悉 Windows 的人都知道“任务管理器”，这是一个简单的工具，可以让你大致了解正在运行的进程和系统的当前性能。Gnome 系统监视器并没有太大的不同。第一个选项卡给出了进程列表，第二个选项卡列出了正在使用的 CPU 和内存资源，最后一个选项卡给出了已挂载文件系统的明细(图 [7-5](#Fig5) )。

![](../images/518154_1_En_7_Chapter/518154_1_En_7_Fig5_HTML.jpg)

图 7-5。

从图 [7-5](#Fig5) 中，您可以看到当前在您的 Linux 系统上运行的所有进程。

#### 克西斯加德

如果 Gnome 工具对您不起作用，您还可以使用名为 ksysguard 的 KDE 工具。Gnome 系统监视器和 KDE ksysguard 工具的区别在于 ksysguard 有监视远程系统的能力。可以创建新的选项卡，并且可以监控来自远程系统的不同资源。对于快速简单的监控工具非常有用，只需很少甚至不需要真正的配置工作(图 [7-6](#Fig6) )。

![](../images/518154_1_En_7_Chapter/518154_1_En_7_Fig6_HTML.jpg)

图 7-6。

与 Gnome 系统监视器类似，您也可以查看系统上运行的所有进程，如图 [7-6](#Fig6) 所示。

### 历史监控数据

到目前为止，我们已经研究了一些可以在 Linux 发行版上使用的有用的监控工具，但是都有一个问题(可能除了 tcpdump)。这些工具都没有保存历史数据。显示的统计数据是当前时间来自系统的实时数据。一个简单的例子，想看看前一天的 CPU 负载情况。Top 和其他这样的命令没有任何用处。

这就是前面提到的工具用于当前系统活动和实时系统检查的原因。在问题发生后试图使用它们进行根本原因分析将会使您的选择有限。

#### 特别行政区

查询历史系统指标的一个有用工具是“`sar`”“`sar`”实用程序随 sysstat 软件包一起安装。除了“`sar`”，sysstat 包还有其他一些实用程序，比如 iostat、mpstat 和 nfsiostat。

“`sar`”实用程序将系统统计信息和指标存储在本地系统文件中，以后可以查询这些文件中的系统统计信息。sar 文件可在以下位置找到:

/var/log/sa/

表 [7-2](#Tab2) 中解释了常见的 sar 参数。

表 7-2

sar 选项

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"></colgroup> 
| 

转换

 | 

描述

 |
| --- | --- |
| `d` | 块设备统计 |
| `r` | 内存利用率 |
| `u` | CPU 利用率 |
| `F` | 文件系统统计 |

#### 性能副驾驶员

在我看来，一个比“sar”更好使用的工具是随 pcp 包一起安装的工具。pcp 包安装了一些用于指标查询和指标收集的有用工具。表 [7-3](#Tab3) 列出了与 pcp 包一起安装的工具。

表 7-3

电脑工具

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"></colgroup> 
| 

名字

 | 

描述

 |
| --- | --- |
| `pmstat` | 关于您的系统、CPU、内存等的实时信息。 |
| `pminfo` | 列出了可以查询的指标 |
| `pmval` | 查看度量数据 |
| `pmlogger` | 将度量数据存储到文件中，pmval 以后可以查询这些文件 |

#### vnstat

不要忘记网络指标，vnstat 工具是保存历史网络信息的另一个有用工具。vnstat 记录选定接口每小时、每天和每月的网络流量。

## 中央监视

现在对本地监控和指标收集工具有了很好的理解，我们现在可以转到开源世界中可用的中央监控工具。这些工具可用于从一个位置监控您的整个房产，并保留历史数据，以便日后进行潜在的根本原因分析。

### 纳吉奥斯

许多人可能知道并在某个时候开始使用的第一个工具是 Nagios。Nagios 是另一个递归的开源名称。纳吉奥斯的意思是“纳吉奥斯不会坚持要成为圣徒。”

#### 版本

Nagios 有一个社区和一个付费产品，可以安装在大多数 Linux 发行版上。然而，CentOS 和 RHEL 是企业级 Nagios XI 产品现阶段的支持平台。然而，Nagios Core 可以安装在许多不同的 Linux 发行版上。如果您决定使用付费产品，最好与供应商讨论这些选项。

##### 核心

Nagios 的社区支持版是核心版本，它提供了 Nagios 的基本监控功能，但是需要您使用社区论坛来获得帮助和支持。

##### 那吉乌斯十一世

Nagios 的企业或付费解决方案附带了标准核心组件以及更多。这还包括通过电话和电子邮件对产品的所有支持。

#### 基于代理的

Nagios 由一个服务器和基于代理的部署组成，带有一些可以使用的代理选项。

##### nrpe！nrpe

Nagios 远程插件执行器(NRPE)使用托管在客户端系统上的脚本。NRPE 可以监控磁盘使用、系统负载或登录用户总数等资源。Nagios 使用 check_nrpe 插件定期轮询远程系统上的代理。

NRPE 还可以与 Windows 代理插件通信，允许 Nagios 在远程 Windows 机器上执行脚本和检查指标。

Note

NRPE 已被弃用，在此仅供参考。

##### NRDP 的

NRDP 或 Nagios 远程数据处理器是您可以使用的另一个 Nagios 代理。NRDP 具有灵活的数据传输机制和处理器，允许 NRDP 轻松扩展和定制。NRDP 使用标准端口和协议(HTTP 和 XML ),可以用来代替 NSCA (Nagios 服务检查接受者)。

##### NSClient++

作为 Nagios 的 Windows 代理，NSClient++监听 TCP 端口直到 12489。用于从这个附加组件收集信息的 Nagios 插件称为 check_nt。

NSClient++类似于 NRPE，因为它允许 Nagios 监控内存使用、CPU 负载、磁盘使用等。

##### NCPA(全国大学生体育协会)

可以使用的最后一种试剂是 NCPA 试剂。NCPA 或 Nagios 跨平台代理是 Nagios Enterprises 维护的一个开源项目。

NCPA 可以安装在 Windows 和 Linux 上。与其他代理不同，NCPA 利用 API 为 Nagios 收集信息和度量。主动检查是通过“NCPA 监听器”服务的 API 完成的，而被动检查是通过“NCPA 被动”服务发送的。

#### Nagios Forks

也可以使用 Nagios 中的许多分支。Nagios 的一些分支如下:

*   伊辛加

*   守护进程

*   真肯

所有这些都与 Nagios 有相似之处，但随着时间的推移，它们已经发展成了自己的解决方案。例如，Icinga 十多年来一直在开发自己的功能。

#### 装置

Nagios 的安装可以通过几种方式完成，Nagios 文档站点上有很好的文档记录:

*   遵循官方文档，一步一步地运行。

*   构建虚拟机并运行自动化脚本。

*   提取 Nagios 容器映像并运行容器。

推荐的方法是使用像 Ansible 这样的自动化工具在专用系统中部署 Nagios，但是为了快速测试和运行，请使用容器。

### 普罗米修斯

Prometheus 是一个开源警报和事件监控系统，它将数据存储在一个时间序列数据库中。Prometheus 是存储度量数据的中心位置，通常与其他软件配合使用，以提供整体监控解决方案。

#### 出口商

出口商是普罗米修斯时间序列数据库的数据来源。在客户机或服务器系统上可以使用多个导出器。有专门的出口商用于不同的目的；在获取节点信息的情况下，有一个专用的 node_exporter，它将导出本地系统指标，如 CPU 或内存利用率。

#### 警报工具

任何与其重量相当的监控平台都必须有一种方法来告诉 Linux 系统管理员什么时候出现了问题。这通常是您的警报工具。一个有用的开源工具是 Alertmanager，它可以用来触发基于 Prometheus 指标的警报。

#### 仪表板

尽管 Prometheus 确实有一个可以用来查询指标的 web UI，但是将指标发送到仪表板工具更有意义。例如，Grafana 就是一个很好的选择，它是当今最流行的开源工具之一。

#### 查询语言

PromQL 是用于创建仪表板和警报的查询语言。

#### 装置

同样建议安装 Nagios，我会建议安装 Prometheus。文档非常清晰，并且经过深思熟虑。如果您想手动安装，安装步骤非常简单，但是我仍然建议您使用自动化方法。互联网上有很多可以为你做这件事的角色，或者，如果你愿意，也有一些容器映像可以用来部署一个容器。

##### 忽必烈还是 openshift

像 Kubernetes 或 OpenShift 这样的平台也可以在其上部署 Prometheus，但它们往往用于平台本身。您需要创建一个新的名称空间，并部署您自己的 Prometheus 和 Grafana 来用于外部系统监控。

#### 配置

一旦安装，普罗米修斯不需要太多的配置就可以开始。通常名为 prometheus.yaml 的简单 YAML 文件可用于所有配置。普罗米修斯官方网站的基本配置如下:

```sh
global:
  scrape_interval:     15s
  evaluation_interval: 15s

rule_files:
  # - "first.rules"
  # - "second.rules"

scrape_configs:
  - job_name: prometheus
    static_configs:
      - targets: ['localhost:9090']

```

##### 全球的

全局部分用于普罗米修斯全局配置。例如，告诉普罗米修斯多久刮一次。

##### 规则 _ 文件

rule_files 部分是我们希望 Prometheus 使用的自定义规则。这种情况下的示例配置没有任何 rule_files 可使用。

##### Scrape_configs

scrape_configs 部分告诉 Prometheus 要收集哪些指标。在配置示例中，将通过端口 9090 联系本地主机，并在/metrics 端点上搜索指标。

#### 启动普罗米修斯

通常，监控平台应该从服务启动，Prometheus 也可以配置为这样做。在启动 Prometheus 时，您至少应该指定一个参数，这就是您正在使用的 Prometheus 配置文件的名称。

要手动启动 Prometheus，可以从 Prometheus 安装目录运行以下命令:

```sh
# ./prometheus --config.file=prometheus.yml

```

### 谢谢你

Prometheus monitoring 本身就相当不错，可以从一个简单的监控平台提供您可能想要的一切，除了可能的长期历史数据或高可用性。

这就是可以利用灭霸的地方。灭霸旨在提供一个高度可用的解决方案，可以从多个 Prometheus 部署中保持无限制的指标保留。

灭霸是以普罗米修斯为基础的，要求在同一个网络中至少有一个普罗米修斯实例。灭霸通过一系列组件管理指标收集和查询。

#### 边车

sidecar 是允许灭霸连接到普罗米修斯实例的组件。然后，它可以读取数据进行查询或上传到云存储。

#### 商店网关

这允许查询云对象存储桶内的度量数据。

#### 压土机

这将压缩或压缩数据，并对存储在云存储桶中的数据应用保留。

#### 接收器

这是负责从 Prometheus 的远程写入功能接收数据的组件。接收者还可以公开指标或将其上传到云存储。

#### 尺子/规则

这用于根据灭霸的数据评估记录和警报规则。

#### 问题

这利用了 Prometheus 的 v1 API 从底层组件获取和查询数据。

#### 查询前端

通过使用 Prometheus 的 v1 API，查询前端可以一次评估所有实例的 PromQL 查询。

#### 灭霸基本布局

图 [7-7](#Fig7) 是各种灭霸组件如何相互通信的基本示意图。

![](../images/518154_1_En_7_Chapter/518154_1_En_7_Fig7_HTML.jpg)

图 7-7。

### 企业监控

对拥有不同团队的大型组织进行监控通常是一个有争议的话题，主要是因为不同的团队都希望使用更适合他们的工具。有一些优秀的专有 Windows 工具，也有相当好的开源 Linux 工具可以使用。因为这本书关注的是开源技术和 Linux 的采用，所以让我们简单看一下您可以使用的一些开源企业监控工具。

#### 扎比克斯

Zabbix 是一个很好的企业级监控工具，可以用来监控您的资产。Zabbix 引以为豪的是，他们可以监控从服务器平台到网络系统的任何东西。Zabbix 是一个基于服务器和代理的系统，但也可以在不使用代理的情况下监控一些设施。

##### 企业支持

Zabbix 有一个付费的支持设施，可以用于企业支持，或者你可以通过社区论坛来支持自己。

##### 装置

安装相对简单，在 Zabbix 网站上有很好的文档。他们有一种非常好的方式，通过一系列基于您的偏好的选择框来呈现安装步骤。

##### 有用的功能

Zabbix 可以提供一些非常好的特性。例如，直接通过 JMX 监控基于 Java 的应用程序的能力，使用 VMware 工具监控虚拟机的能力，以及与 Puppet 或 Chef 等系统管理工具集成的能力。

#### CheckMk

另一个很好的企业监控工具是 CheckMk。CheckMk 是一个像 Zabbix 一样的可扩展解决方案，可以监控从标准 Linux 平台到物联网设备的各种系统。

##### 企业支持

CheckMk 提供了一个免费版本和一个企业付费解决方案，免费版本具有无限的监控功能，您可以在其中支持自己，企业付费解决方案具有额外的功能。

##### 装置

支持主要的企业 Linux 发行版，CheckMk 文档中有关于您正在使用的发行版的详细步骤。

##### 有用的功能

CheckMk 一直着眼于未来构建他们的平台。他们内置了监控 Docker、Kubernetes 和 Azure 等工具。

整体解决方案是可扩展的，并且将在具有分布式布局(多个数据中心)的大型组织中很好地工作。自动化是确保配置和设置尽可能简单的主要开发点之一。

#### OpenNMS(打开 NMS)

我安装的第一个监控工具是 OpenNMS，那是很多年前我第一次接触开源技术的时候。在为这本书进行研究时，我印象深刻地看到，OpenNMS 不仅仍然是一个开发的产品，而且看起来也非常令人印象深刻。

##### 企业支持

像大多数企业平台一样，通常有两种选择:带有社区支持的“免费”版本和企业付费版本。

OpenNMS 版本如下:

*   Horizon:社区驱动和支持的版本

*   Meridian:基于订阅的服务，提供最新稳定的企业版

##### 装置

OpenNMS 的安装不像其他可用的工具那么简单，但同时安装起来也并不十分困难。官方文档足够清晰，并且会一步一步地指导您完成所有需要做的事情。如果你遇到困难，也有一个很好的社区论坛来回答问题。

##### 有用的功能

真正突出的一个特性是 OpenNMS 使用 Grafana 作为仪表板工具，在我看来，这是一个非常好的举措，这主要是因为当今越来越多的用户正在开发自己的仪表板。

OpenNMS 指标也可以通过多种方法收集，包括 JMX、WMI、HTML、XML 等等。

## 仪表盘

监控的一个方面几乎与收集的指标一样重要，那就是以有意义的格式查看指标的能力。这就是仪表板工具至关重要的地方。

这些年来，我遇到过一些监视工具，它们过去和现在都很好，但在浏览器中看起来很糟糕。对于一些应用程序监控工具，我还发现仪表板很难配置。调整窗口大小是一场噩梦，连接外部工具总是不可能。

似乎我不是唯一一个受这些工具困扰的人，一些聪明人已经开始开发专用的仪表板工具，可以与各种工具集成。

### 仪表板工具

表 [7-4](#Tab4) 列出了一些现在可以使用的仪表板工具。

表 7-4

仪表板工具

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"></colgroup> 
| 

名字

 | 

描述

 |
| --- | --- |
| `Grafana` | 当今最流行的仪表板工具。最初发布于 2013 年 |
| `Chronograf` | 如果您的大部分指标来自 InfluxDB 数据库，这将是一个非常好的工具 |
| `Netdata` | 一个基于插件的仪表板工具，支持度量显示的推拉架构 |
| `Kibana` | 主要与 Elasticsearch 和 Logstash 一起使用，以形成 ELK 堆栈 |

### 格拉凡娜

由于 Grafana 是当今最受欢迎的工具，因此值得探究 Grafana 提供了什么。

#### 格拉夫纳是什么

Grafana 是一个开源的基于插件的仪表板工具，具有广泛的数据源选项，可用于显示指标而无需复制任何数据。Grafana 几乎可以部署在今天使用的所有平台上，从 Windows 到 Debian(图 [7-8](#Fig8) )。

![](../images/518154_1_En_7_Chapter/518154_1_En_7_Fig8_HTML.png)

图 7-8。

Grafana 仪表板的基本示例如图 [7-8](#Fig8) 所示。

#### 使用 Grafana

有几种方法可以使用 Grafana:

*   在内部安装您自己的环境。

*   使用托管的 Grafana 云服务。

#### 云服务

如果您不想在本地运行自己的 Grafana 实例，可以在云中运行您的仪表板。免费的永久计划包括 Grafana，10K 普罗米修斯系列，50 GB 日志，等等。

#### 现场安装

Grafana 有几种部署方式:

*   按照 Grafana 文档页面上的官方文档进行手动安装。

*   使用 podman 提取预构建的 Grafana 容器映像，并运行 Grafana 容器。

Recommendation

使用像 Ansible 这样的自动化工具，并下载一个预构建的 Ansible 角色来为您进行部署。

#### 数据源

在创建仪表板之前，您需要有一个从中提取指标数据的源。这些是你的数据来源。在尝试创建仪表板之前，您需要创建一个数据源。Grafana 支持许多数据源，包括以下一些:

*   Alertmanager

*   AWS 云观察

*   Azure 监视器

*   弹性搜索

*   InfluxDB

*   关系型数据库

*   一种数据库系统

*   普罗米修斯

*   贼鸥

#### 仪表板创建

一旦有了数据源，就可以开始创建仪表板了。Grafana 能够创建许多不同的仪表板，当您首次登录时，可以从 Grafana 主屏幕创建这些仪表板。

如果您希望下载预构建的仪表板或希望共享您的配置，可以导入和导出仪表板。

##### 嵌板

一旦您有了第一个仪表板，您将想要开始创建您的指标可视化。为此，仪表板使用面板。可以使用多个面板来显示您从预配置的数据源中选择的指标。每个面板都有一个特定于面板中所选数据源的查询编辑器(图 [7-9](#Fig9) )。

![](../images/518154_1_En_7_Chapter/518154_1_En_7_Fig9_HTML.jpg)

图 7-9。

可以复制面板以进行快速配置，并且可以定制为您的时间序列数据使用不同的颜色，如图 [7-9](#Fig9) 所示。

##### 行

要排列所有面板，您需要创建行；行是所有面板的逻辑分隔线。为了便于组织，可以将面板拖到不同的行中。

##### 救援

当您添加了新的面板或行时，请始终记住保存您的仪表板。如果您碰巧打开了一个新的仪表板，您的更改将会丢失。

## 应用程序监控

应用程序监控是一种特殊的监控，它可能有点复杂，而且通常在资源和时间上都更昂贵。应用程序监控要求基础设施工具和开发应用程序的开发人员公开可以监控的指标。

### 跟踪工具

跟踪工具通过使用专门的日志记录来“跟踪”应用程序及其事务的执行路径。通常，开发人员使用这些来帮助确定特定问题发生的位置。

不应将跟踪与事件监控相混淆。事件监视主要由 Linux 系统管理员用于高级故障排除，通常不会太“嘈杂”在那里，用“追踪”噪声是好的。信息越多，故障排除就越能准确地缩小根本原因的范围。

现在有一些可以使用的跟踪工具。像 AppDynamics 这样的专有平台是具有丰富功能的优秀工具，但价格昂贵。幸运的是，也有开源的选择，因为我们主要关注的是开源的，我们可以跳过那些不开源的。

#### 贼鸥

Jaeger 最初由优步开源，其灵感来自于 OpenZipkin 和 Dapper 项目，用于监控和故障排除基于微服务的分布式系统。因此，耶格承诺帮助解决以下问题:

*   分布式事务监控

*   性能和延迟优化

*   根本原因分析

*   服务依赖分析

*   分布式上下文传播

#### 分布式跟踪

在 Jaeger 之前，Zipkin 是作为基于 Google Dapper 项目的开源项目开发的。Zipkin 是一个基于 Java 的应用程序，它为用户提供了一个界面来查看来自一系列数据后端的跟踪数据。Zipkin 支持 RabbitMQ 和 Kafka 这样的传输机制。

Zipkin 可以作为容器部署，也可以通过下载最新的二进制文件在本地运行。所有这些步骤在 Zipkin 官方网站上都有详细的记录。

### 公开指标

监控工具的好坏取决于它们所能收集的数据。对于标准平台监控，可以使用代理提取指标，这些代理反过来与运行它们的系统对话，以返回它们需要的数据。然而，应用程序需要从应用程序内部公开数据，以便监控代理可以将数据传递给监控平台。在那里，可以配置警报以及任何控制面板。

#### “开发者”怎么讲

作为 Linux 系统管理员，我们需要构建包含应用程序指标的监控系统；为此，开发人员需要确保编写的代码能够公开指标。开发可以使用 Jaeger 这样的追踪软件追踪的应用程序也是如此。

在尝试诊断问题时，与开发人员进行对话并构建概念验证应用程序来展示跟踪的好处以及公开的应用程序指标是至关重要的。随着您的应用程序组合的增长，拥有这些工具将大大减少潜在的停机时间和消防。尽早构建这些良好的实践比以后再尝试改进它们更值得。如果您的应用程序使用第三方，这可能会更加困难。

## 摘要

在本章中，向您介绍了以下内容:

*   什么样的监控工具可以从标准的 Linux 发行版中运行

*   可以从 Linux 桌面使用的图形替代监视工具

*   什么工具可以用来在标准 Linux 发行版上存储历史指标数据

*   Nagios、Prometheus 和灭霸等中央监控解决方案

*   企业监控开源工具，如 OpenNMS 和 CheckMk

*   可以用来以简洁的方式显示度量数据的仪表板工具

*   用于跟踪的应用程序监控工具，以及应用程序指标对资产管理的重要性