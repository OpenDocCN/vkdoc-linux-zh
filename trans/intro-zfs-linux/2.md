# 二、硬件

在为存储购买硬件之前，有几件事需要考虑。你需要多少磁盘空间？您的存储将服务多少个客户端连接(会话)？您将使用哪种协议？您计划提供什么样的数据？

## 不要着急

你应该永远记住的第一条建议是:不要操之过急。你将要投资你的金钱和时间。虽然您以后可以根据需要修改存储，但某些更改将要求您重新创建 ZFS 池，这意味着其上的所有数据都将丢失。如果您购买了错误的磁盘(例如，它们太小)，您将需要添加更多磁盘，并且可能会耗尽可用插槽或电源。

## 考虑

在开始确定存储范围之前，您应该问自己几个问题。您在此给出的答案将在以后的部署中发挥关键作用。

### 多少数据？

您希望存储的数据量将决定您需要购买的磁盘数量和大小。它还会影响其他因素，如服务器大小。要确定您的空间需求，您需要评估您当前拥有的数据量及其增长速度。考虑您要运行您正在构建的存储多长时间。可能你计划在三年内完全替换它，因此不必非常小心。您可能不知道何时会实施新的存储，因此需要增加一些利润。看看你的组织发展计划。你打算在三年内将办公室人员的数量增加一倍吗？都是要出数据吗？这意味着三年后，数据的增长速度将至少是现在的三倍。

### 有多少并发客户端？

并发客户端连接数决定了您需要的 RAM 数量。如果你考虑使用固态硬盘，你可以购买固态硬盘作为存储的二级缓存，放弃使用 SATA 硬盘。即使您要存储数百 TB 的数据，但只有少数客户机会使用它，而且不是非常集中，您也可以使用少量的内存。这也将决定服务器中网络接口的类型以及它应该连接的交换机的类型。

### 数据有多重要？

您的数据有多重要？如果是任务关键型的，可以考虑经认证的、可能更贵的硬件，众所周知，这些硬件性能良好，使用时间更长。数据的重要性还会告诉您应该使用哪个冗余级别，这会影响最终成本。我从各种数据中心获得的个人经验表明，SATA 磁盘的故障速度比 SAS 磁盘快得多。

### 什么类型的数据？

您将提供的数据类型可能会影响您的存储池的体系结构。为大量客户端传输视频文件或为虚拟机和数据文件提供服务很可能意味着您需要使用镜像，这将直接影响阵列的最终容量和最终成本。

### 什么样的范围？

首先，为本指南中的 SoHo 存储创建一个上限:

*   考虑到您当前的磁盘大小，单个节点中最多 12 个插槽，以及最多 30 TB 的原始容量。
*   内部 SAS 或 SATA 驱动器。
*   一个或两个插槽用于最终的固态硬盘，以加快读取速度。
*   可能是一个镜像 ZIL 设备，用于加速和连接对磁盘的写入。一个系统驱动器，可能是镜像的，尽管目前在 ZFS 上安装 Linux 系统并不容易，也不推荐从 ZFS 启动。
*   高达 128 GB 的内存，可能是 64。
*   具有四个或更多内核的 64 位 CPU。虽然在 32 位系统上运行 ZFS 是可能的，但肯定不推荐这样做。

如果您打算使用通过 SAS 或光纤通道连接的外部磁盘箱(JBODS ),这本书可能不适合您。可以手动设置和管理此类存储，许多人已经这样做了，但这可能涉及本指南中未涉及的其他步骤。如果您想运行几十或几百个磁盘，请帮自己一个忙，考虑免费 NAS 甚至付费支持的商业解决方案。跟踪系统性能、内存使用、磁盘、控制器和电缆健康状况可能最好由专业产品来管理。

## 硬件购买指南

硬件通常是一项长期投资。请记住以下几点。

### 同一供应商，不同批次

购买磁盘时，通常的做法是确保从相同的供应商和型号购买每个磁盘，以保持几何形状和固件相同，但来自不同的批次，这样可以最大限度地降低几个磁盘同时损坏的风险。我认为对于一个小买家(几个到 20 个磁盘)，最简单的方法是从不同的商店购买磁盘。这可能很麻烦，但是存储操作员已经多次看到磁盘批次同时出现故障。

### 买几件备用的

存储系统的寿命通常以年为单位计算，并且通常比磁盘型号更长，尤其是当您决定使用消费级 SATA 磁盘时。当其中一款几年后出现故障时，你可能会惊讶地发现，你再也买不到这款产品了。在池中引入不同的池总是有性能风险。如果发生这种情况，不要绝望。ZFS 允许您交换一个池中的所有磁盘。过去，当池变得不足时，这种技巧被用来增加池的大小。请注意，在已满且繁忙的系统上，更换 10 个磁盘的池中的所有磁盘可能需要数周时间。

### 正确确定电源范围

如果您的电源不稳定或不足，您可能会遇到神秘的故障(磁盘消失、磁盘连接断开或池的随机 I/O 错误)或根本无法使用您的磁盘。

### 考虑性能，规划内存

就性能而言，磁盘越多越好。磁盘越小越好。ZFS 线程在 vdevs 之间读写。vdevs 越多，读/写线程就越多。计划更多内存。ZFS 需要至少 2 GB 的内存才能正常工作，但对于任何实际使用，不要低于 8 GB。对于 SoHo 的存储系统，我建议考虑 64 GB 或更多。ZFS 非常积极地缓存数据，所以它会尝试使用尽可能多的 RAM。但是，当系统需要 RAM 来进行正常操作(比如运行新程序)时，它就会让步。所以你的记忆中能容纳的越多越好。

### 规划固态硬盘(至少三个)

你不需要预先购买它们。ZFS 是一个混合存储文件系统，这意味着它可以将 SSD 磁盘用于二级缓存。它会比你的内存慢得多，但它更便宜，而且仍然比你的盘片快得多。只需花 RAM 价格的一小部分，你就可以得到一个 512 GB 的固态硬盘，这应该可以进一步提高速度。这是一块固态硬盘。两个固态硬盘用于外部 ZFS 意向日志。文件系统不会一直将所有数据刷新到物理存储中。它将写入绑定在事务中，并同时刷新多个事务，以最大限度地减少文件系统碎片和对磁盘的实际 I/O。

如果你给 ZFS ZIL 的外部设备，它可以通过在刷新之前分组更多的数据来加快速度。这个额外的池设备应该被镜像，因为它是您可能丢失数据的地方。在电源故障的情况下，外部 ZIL 上的数据必须是持久的。有模拟小型 SSD 磁盘(即 ZeusRAM)的电池备份 DRAM 设备。它们有 8gb 和 16 GB 两种尺寸，这对于 ZIL 来说已经足够了。它们和内存一样快，但是很贵。你也可以考虑镜像你的 L2ARC(二级缓存)，但是丢失这个设备不会危及你的数据。

### 考虑 SATA

虽然 SAS 标准肯定会从您的磁盘获得更好的性能和预期寿命，但对于 SoHo solutions 来说，SATA 就足够了，尤其是当您考虑到有企业级 SATA 磁盘时。这种部署的价格差异应该不会很高。如果你不确定，在预算允许的情况下选择 SAS。

### 不要购买硬件和软件 RAID 控制器

虽然在过去，RAID 卡是卸载 CPU 单元和 RAM 所必需的，但这两种资源现在都很丰富而且便宜。你的 CPU 和内存对于工作负载来说是绰绰有余的，RAID 卡夺走了 ZFS 的一项重要功能。ZFS 通过直接与磁盘对话来确保数据安全:获取关于数据何时刷新到物理磁盘以及正在使用的块大小的可靠信息。

RAID 控制器介于两者之间，可以对 I/O 进行自己的“优化”,这可能会降低 ZFS 的可靠性。另一件事是，RAID 控制器在不同的供应商之间是不兼容的，甚至同一张卡，但不同的固件版本可能无法访问您的 RAID 磁盘阵列。这意味着在控制器出现故障的情况下，您会丢失整个设置，并且需要从备份中恢复数据。软突袭甚至更糟，因为它们需要特殊的软件(通常仅限于一个操作系统)才能实际工作。

ZFS 在所有这些方面都很优秀。它不仅可以使用您可以给它的所有处理能力和所有 RAM 来加速 I/O，而且池中的磁盘还可以在实现相同 OpenZFS 版本的所有软件平台之间迁移。此外，磁盘在磁盘插槽中的确切顺序并不重要，因为池会根据磁盘设备名称(即`/dev/sdb`)以及 ZFS 在创建池期间为其提供的磁盘 GUID 来记忆其配置。

### 至少 1 GB 速度的网卡

请记住，此服务器网卡的带宽将分布在所有同时使用存储的机器上。考虑 10 GB 是非常明智的，但是您还需要考虑其他网络设备—交换机、电缆等。请记住，网络在性能分析中起着重要作用，相当多的性能问题不是由存储本身引起的，而是由网络层引起的。对于办公室中的重要工作，我建议使用不低于 10GB 的网卡。在存储不会被广泛使用的非常小的环境中，1GB 是可以接受的。任何不足都会很快变得不方便。

### 冗余计划

一直都是。这意味着对于高速读取池，您需要考虑镜像存储，从而有效地将您购买的磁盘的总容量减半。RAIDZ 设置意味着您每创建一个 vdev，容量就会减少一个磁盘。对于 RAIDZ-2，它将是两个磁盘。

## 数据安全

您将使用 ZFS 存储来保存数据，并将其提供给公司中的不同人员。不管是两个人、十个人还是五十个人，都要花些心思来规划布局。各种存储不同种类、敏感度和可压缩性的数据的目录在将来会有所回报。设计良好的目录结构将简化组织方面的事情，如访问控制和技术方面，如启用或禁用压缩、时间选项等。

ZFS 文件系统的行为类似于目录。例如，为每个用户主目录创建一个单独的 ZFS 文件系统是很常见的，这样他们就可以拥有细粒度的备份策略、ACL 和压缩机制。

您需要考虑您的公司规模、访问存储的员工数量、增长前景、数据敏感性等。然而，无论你做什么，不要跳过这一点。我见过不少公司忽略了他们需要从自由发展的基础设施转变为工程化的基础设施的时刻。

### 中央情报局（Central Intelligence Agency）

有许多数据安全方法，其中之一，我认为是最经典的，使用缩写 CIA 来解释数据安全的各个方面。这代表机密性、完整性和可用性。虽然它更侧重于信息安全方面，但它也是存储管理的一个很好的视角。接下来的部分将从存储管理员的角度介绍这些概念。

#### 机密

数据必须只对受托人开放。没有被明确允许查看数据的任何人都不能访问数据。许多基础设施工具涵盖了这方面的安全性，从允许查看数据的人员应该阅读和签名的策略和 NDA，到网络访问隔离(VPN、VLANs、通过凭据的访问控制)。还有一些方面与存储本身直接相关:访问控制列表(ACL)、通过安全协议和在安全网络中共享、使用存储防火墙等。

#### 完整

必须保证数据是真实的，并且没有被不受信任的人更改。此外，如果不应该，改变不应该由软件或硬件有意或无意地引入。在整个数据生命周期中，只有拥有足够权限的人才能修改数据。无意的数据完整性破坏可能是破坏数据块的磁盘故障。虽然文本数据通常很容易被发现，但对于声音或视频等其他数据，就比较难了，因为与原始状态可能会有细微的差异。与安全性的所有方面一样，它也只是由存储部分管理。数据完整性由 ACL 覆盖，但也由 ZFS 校验和数据块来检测损坏。如果您的设置使用了任何冗余，ZFS 可以在很大程度上使用冗余集为您解决这些问题。

#### 有效

数据应该在需要和保证的任何时候都可用。这可能是存储最明显的方面之一。任何时候，只要您认为您的数据应该是可用的，数据就应该是可用的。通常，存储冗余在这里起作用(mirror、RAIDZ 和 RAIDZ-2)，但网卡中继、交换机堆叠和您使用的任何凭证检查解决方案的冗余也起作用(例如，Active Directory 服务器、主服务器和辅助服务器)。

## 工作量的类型

您将在存储上运行的工作负载将在您应如何规划池布局中发挥重要作用。

如果您将主要托管数据库，并且它们将成为该空间的主要消费者，L2ARC SSD 设备可能不会为您提供特殊的性能提升。数据库非常擅长缓存自己的数据，如果数据恰好适合数据库服务器 RAM，那么 ARC 就没有太多事情要做。另一方面，如果数据库中的数据经常变化，并且需要从磁盘中重新读取，那么无论如何，您都会有很高的未命中率，而且 L2ARC 设备也不会达到它的目的。

快照数据也将变得棘手。为了能够处理数据，数据库需要的不仅仅是文件系统的快照。这就是它们自带转储命令的原因——因为完整的工作备份通常包含比数据库文件中更多的内容。托管数据库通常意味着您在与 ZFS 相同的主机上运行引擎。同样，数据库将比文件系统本身更有效地使用 RAM。但是，请考虑一下，如果您将同一台服务器上的数据用于其他目的，比如 CIFS 或 NFS 共享。在这种情况下，数据库和文件系统缓存可能会争用 RAM。虽然这不会影响系统稳定性，但可能会对性能产生负面影响。

如果您为办公室工作人员存放文档和图片、程序之类的文件以及技术文档，L2ARC 设备是值得认真考虑的。因此，快照是在特定时间点捕获数据的可靠方式。如果您的数据不是一天 24 小时都被访问，并且您只有几秒钟的非工作时间，那么快照可以在指定的时间点可靠地承载您的数据。通常需要一秒钟来创建。您可以稍后装载此快照(记住它是只读的)并将其传输到备份位置，而不用担心数据完整性。

最重要的是，不要操之过急。如果性能测试不令人满意，您可以随时将 L2ARC 添加到您的池中。

## 要注意的其他组件

关注其他基础设施元素非常重要。该网络具有特殊的意义。在只有几个人的小公司中，将工作站改装成存储服务器的小型交换机可能不会有任何问题，但是一旦数据消费者的数量开始增长，这种网络可能很快就会成为瓶颈。开关可能不是唯一的限制因素。存储服务器中的网卡可能是另一个原因。此外，如果你从远程位置通过 VPN 提供你的数据，结果可能是链接太慢。在存储性能分析案例中，我们经常能够指出网络基础架构是故障元素。

## 硬件清单

不要着急。在购买硬件之前，坐下来用一张纸或你的笔记本电脑列一个清单。想想你需要多少空间，以及这种需求在几年后会如何增长。想想你的预算。能花多少钱？计算您将连接到存储的机器数量，并描述将要服务的流量类型。很多小文件？几千兆字节大小的大文件？计划一些测试，假设你需要几天时间来做。