# 3.媒体系统:整合电视和高保真音响

Abstract

任何家庭环境中最明显的部分是媒体系统。自从真正的壁炉不再流行，电视或立体声系统已经成为大多数客厅的焦点。电视和立体声系统也是我们花费最多时间与之互动的设备。因此，你必须了解这些设备的可能性。

任何家庭环境中最明显的部分是媒体系统。自从真正的壁炉不再流行，电视或立体声系统已经成为大多数客厅的焦点。电视和立体声系统也是我们花费最多时间与之互动的设备。因此，你必须了解这些设备的可能性。

与所有消费电子产品一样，功能集和价格每天都在变化。因此，我将主要关注这些机器的必要特征和内部工作原理，而不详述具体的品牌和型号，因为当你读到这篇文章时，其他的机器已经上市了。

## 数据链

简单的“播放专辑”行为在家庭自动化领域发生了重大变化。不仅媒体本身的位置不受限制，而且它还是你可以听它的地方。最近的例子是 iTunes，它允许你在几台不同的电脑上播放音乐，还有 Spotify，它提供音乐流媒体服务，允许你从家用电脑或手机上访问各种音乐曲目。 [<sup>1</sup>](#Fn1) 如果你对音乐的兴趣是随意的，或者是基于图表的，那么这些服务往往就足够了。但是许多人收藏的专辑要么很稀有，要么很模糊，不会出现在任何商业网站上。有些人可能更喜欢将他们的音乐数据存储在自己的电脑上，以免公司倒闭、改变服务条款或以其他方式失去连接。在这种情况下，我们需要提供一种方法将音乐从硬盘传到人耳中。这是数据链。

这个链条有四个步骤。第一步是数据本身。这是代表你收藏的音乐(或其他媒体)的 wav、MP3 或 ogg 的目录结构。该数据然后由服务器读取(这是第二步),然后被分发给(第三步)室内的一个或多个扬声器。第四步也是最后一步是当人类听到(或看到)媒体时。在便携式音乐播放器或台式电脑上播放音乐时，这种模式仍然适用，尽管对于台式电脑来说，所有的逻辑单元都放在一个物理盒中。

### 提取数据

通常称为翻录，这是将通常存储在 DVD 或 CD 上的媒体转换为计算机友好的数据格式，以备回放的过程。许多软件都是可用的，所以我将用一个例子来介绍它们。

#### 光盘

到目前为止，CD 是最简单快捷的格式，因为大多数组成部分都可以在 Linux 中找到。一个工具，如`abcde`，可以自动执行以下操作:

*   将音频提取为 WAV 文件
*   把它转换成 OGG·沃尔比斯
*   确定艺术家和专辑
*   自动下载并应用标签
*   相应地命名文件

接下来需要做的就是将文件复制到您的文件系统中。出于速度原因，我个人总是将我的 CD 解压到一个单独的(本地)文件夹中——在本地写入，然后一起复制会更快，因为这意味着当我可能想要传输其他内容时，我的服务器不会处理大量的小写入请求。这也给了我一个手动更改文件的机会，以防出现问题，因为有时专辑会超过标准的 74 分钟。 [<sup>2</sup>](#Fn2)

对于批量翻录，您可以编写一个简短的脚本，通过自动打开和关闭 CD 抽屉来节省时间。这听起来可能不多，但提取你的音乐收藏的最初障碍是心理上的；交换数百张 CD 并给每个文件重新命名和标记的想法令人望而生畏。因为音频是以 CD 或 DVD 驱动器的速度进行翻录的(与专辑的时间长度无关)，所以您可以在大约 5 到 10 分钟内提取整张光盘。通过在线曲目列表数据库(CDDB，它将每个曲目的开始时间和持续时间组合成一个整体的光盘 ID)，标记过程也是自动的。有时会有重复的 id，这需要手动干预，但大多数光盘可以使用`-N`标志自动处理，如下面的脚本所示。`abcde`脚本还支持参数，允许您指定文件名的格式(如果这对您很重要),以及用于处理多位艺术家的专辑的布局信息。

`#!/bin/bash`

`while :`

`do`

`echo Insert next disc...`

`read x`

`cdcd close`

`abcde -N`

`cdcd eject`

`done`

#### 数字影碟

随着 DVD 格式越来越复杂，业界一直坚持加密是必要的，DVD 的翻录有了额外的要求， [<sup>3</sup>](#Fn3) 即`libdvdcss2`。这是一个绕过加密光盘复制保护的库，大多数商业电影都使用加密光盘。它的合法性是不确定的，所以主要的 Linux 发行版在谨慎方面犯了错误，没有包含这个包。相反，该库必须单独下载，要么从另一个存储库下载，要么从编译源下载。当然，我必须采取同样的“安全”方法，并且只能告诉你如何安装它，如果你在某个网站上找到这些文件的话。

例如，在 Debian 上，通过在`/etc/apt/sources.list`文件中放置一行代码来添加一个额外的存储库:

`deb`[`http://www.debian-multimedia.org`](http://www.debian-multimedia.org/)T2】

接下来是以下传统流程:

`apt-get update`

`apt-get install libdvdcss2`

有时你必须手动下载并安装软件包。命令行调用如下所示:

`dpkg -i libdvdcss2_1.2.10-1_i386.deb`

或者，源安装将按照`INSTALL`文件进行，可能类似于以下三位一体:

`./configure`

`make`

`make install # as root`

一旦您可以使用 VLC 播放 DVD，您就知道该库已成功安装，因此可用于所有主要的媒体播放器应用程序，如`mplayer`、`totem`、`xine`等。

当翻录 DVD 时，您必须考虑您要用于收藏的硬盘空间量，您是否想要(或需要)DVD 菜单，以及它们在什么设备上播放。最终，有两个选择。

##### 按 ISO 格式翻录

Rip As ISO 制作整个光盘的原始副本，并将其存储为文件。这是最容易启动的过程，因为您只需调用以下内容:

`dd if=/dev/dvd of=TheOffice-series1.iso bs=1024`

这通常需要 4GB 到 8GB 的空间，包括所有的 DVD 菜单、标题、章节和字幕。像 VLC 这样的电影播放器将能够处理像菜单这样的交互式组件，但其他的则不行。对于不支持 DVD 徽标的设备尤其如此，因为它们没有 CSS 代码，对于较小的低功耗设备(如 MediaMVP)也是如此。在后一种情况下，您可以通过使用 VLC 远程转码电影来部分解决问题，但它仍然无法处理 DVD 菜单。

与所有磁盘映像一样，Linux 能够将它们挂载到一个目录中，这样就可以读取它们，也可以正常查询它们的文件。这可以通过桌面或以下方式自动完成:

`mount -t udf –o loop TheOffice-series1.iso dvdimage`

请注意，您不能将映像挂载到您通常的 DVD 位置(如`/dev/dvd`)，因为那是一个块设备，您只能将映像挂载到一个目录。

##### 翻录为电影文件

这种方法占据了“DVD 抓轨”软件的大部分，命令行和 GUI 都有许多可用的版本。尽管 GUI 版本提供了标题和章节的截图以及一系列可配置的选项，但它们(几乎毫无例外)只是一组标准后端工具的前端，比如`mencoder`。你可以通过直接找到金属来去除这个中间人所利用的资源和时间。

UnDVD ( [`http://sourceforge.net/projects/undvd/`](http://sourceforge.net/projects/undvd/) )是一个 Perl 脚本，它提供了一个简单的命令行方法来将 DVD 拆分成它们的组件标题，同时采用您想要的任何语言或字幕。使用英语音频翻录前三首曲目的典型调用可能如下:

`undvd -t 1,2,3 -a en`

可用轨迹的数量可通过相关工具`scandvd`确定。因为大多数家庭会说一种共同的语言，所以减少了完全 ISO 的必要性，使这成为一个一致的过程。以下脚本将光盘完整地翻录到它自己的子目录中。例如，它甚至可以通过家庭网页上的链接来触发。

`#!/usr/bin/perl`

`my $language = "en";`

`my $subtitles = "off";`

`my $output = `lsdvd`;`

`$output =∼ /Disc Title\:\s+(.*?)\n/s;`

`my $title = lc $1;`

`$title =∼ s/\b(\w)/\U$1/g;`

`$title =∼ s/_(\w)/ \U$1/g;`

`my $cmd = "undvd -t 1";`

`my $count = $output=∼s/\nTitle\://g;`

`foreach(2..$count) {`

`$cmd .= ",$_";`

`}`

`mkdir($title);`

`chdir($title);`

`$cmd .= " -a $language -s $subtitles -e 2";`

`system($cmd);`

`chdir("..");`

##### 电影的问题

有这么多可用的编解码器和播放器，您不可避免地会偶尔发现其中一个有问题，例如无法播放电影、中途崩溃、视频和音频之间失去同步、无法快进等等。即使是商业产品也有这些问题，所以它们不是开源社区独有的。事实上，因为我们主要使用基于软件的解决方案，我们有一个更好的交易，因为问题可以很快得到解决。以下是一些建议:

*   有时，您可以通过暂停和取消暂停视频来解决同步问题。
*   不会快进的电影往往没有组块索引，可以在用`mplayer -idx`开始电影的时候建立。
*   其他问题通常需要重新编码(或代码转换)。这可以通过较大的工具来处理，比如 VLC。

#### 蓝光(Blu-ray)

自 2006 年发布以来，蓝光一直是 Linux 的眼中钉，最近又是树莓派用户的眼中钉。这是因为没有官方的软件播放工具发布，使用的加密方法也比较苛刻。第一种情况之所以存在，是因为适用专利的许可由 One-Blue 控制，One-Blue 不能(不会？)许可给 Linux 开发者。因此，播放蓝光光盘(BD)的唯一方法是分离解码和回放部分，并将原始光盘转码为另一种格式。我们将很快找到解决方案。

第二种情况更麻烦，尤其是因为蓝光设计的一部分允许加密密钥在被破解时被更改。到目前为止，已经有几个密钥在网上发布了，但是不久之后，一系列新的密钥被引入以保持格式的封闭。这表明这个行业还没有从女权运动中吸取同样的教训，因此在可预见的未来，我们将陷入这种无休止的猫捉老鼠的游戏。

最简单的答案是完全放弃蓝光。但是，尽管很容易认为将 DVD 电影升级为蓝光电影没有什么意义，但新电影通常具有高质量和额外功能，值得购买。而且，对许多人来说，忽视所有面向 DRM 的媒体的基本观点是不切实际的(特别是因为这也包括许多在线音乐和 DVD)。因此，实用的观点是对所有 BD 进行代码转换，并将物理副本归档到某个安全的地方。

##### 翻录为 ISO 文件

一句话——不要！因为没有东西播放它们，所以它们只对创建一个稍后可以被翻录的 ISO 有用。因为你无论如何都要阅读光盘内容，所以你现在没有节省时间。由于单层 BD 大约需要 25GB(双层需要 50GB)，存储成本明显高于 DVD。如果你想知道有多少，一个 1TB 的驱动器可以容纳 40 个单层图像。如果驱动器成本为 100 美元，则该映像的成本为 2.50 美元。与价格约为 5 美分的转码版本相比，差异非常明显。

##### 翻录为电影文件

最直接的方法是利用“模拟洞”(但在数字意义上，即“数字洞”)。这需要一个带 HDMI 输出的播放器和一个带 HDMI 的显卡。第一个的输出被输入到第二个的输入中，并进行实时记录。尽管这种方法肯定有效，但我们知道更好的解决方案。

这里的首选是“MakeMKV”，可从 [`http://www.makemkv.com`](http://www.makemkv.com/) 的论坛部分下载，这是一个实用的抓轨软件选择。也就是说，它既不自由，也不开放。但鉴于选择有限，我们将使用它。幸运的是，当它处于测试阶段时，如果你使用 [`http://www.makemkv.com/forum2/viewtopic.php?f=5&t=1053`](http://www.makemkv.com/forum2/viewtopic.php?f=5) 的下载密钥，费用已经被移除。幸运的是，它自 2010 年以来一直处于测试阶段，尽管在这本书的制作期间将发布一个新的密钥副本，但人们希望新的测试密钥将允许该程序免费使用(如在啤酒中)。

按照论坛下载页面上的说明，你可以像翻录其他光盘一样翻录你的光盘。有些人注意到如果你打字

`touch tmp/eula_accepted`

在运行 make 程序之前，您可以安装软件，而不必阅读并同意 EULA。

一旦进入 MKV 格式，你可以自由地转换成任何其他格式。这可能是必要的，因为高清视频需要高清播放器，而一些(旧的)媒体流盒可能不支持它。然而，请注意，高清视频需要高清转码器，所以你需要最新的工具(如手刹)，因为许多旧的重型程序尚未升级以应对它。

#### 盒式磁带和乙烯基

是的，真的！有许多人拥有这些心爱的技术遗物，他们希望用电子方式保存它们。这些是速度最慢的媒体形式，因为它们必须实时完成。最显而易见的方法是将你的走带设备(磁带或唱片)的唱机输出连接到你声卡的线路输入。信号链中的元件应该尽可能少，如果你的转盘有前置放大器，那就更好了。否则，考虑你的声卡和走带设备的相对优点，让高质量的单元执行前置放大阶段。乙烯特别需要一个前置级 RIAA 均衡，以避免微小的声音。

一旦你连接了走带设备，找到音乐中最响的部分，在录音程序中监控音量，比如 Audacity。应该尽量大声，不削波。这可确保您充分利用 16 位分辨率，即最大可能的动态范围。然而，如果可能的话，这个音量应该来自前置放大器，因为功率放大器会引入噪声。

为了确保录制期间的最高质量，您还需要注意外部硬件元件。因此，不要在录音时使用微波炉，因为这会引入可能影响它的电噪声，不要摆弄连接器，等等。这也是一个好主意，将甲板插入高质量的 UPS 或电源平滑器，以限制电源电压波动引起的 wow 和颤振的数量。

同样的方法也适用于磁带，尽管大多数磁带播放器都有内置前置放大器，所以你别无选择。

目前市场上有一些一体化设备，它们将磁带或录音座与所有必要的放大器和转换器结合在一起，通过 USB 电缆为您提供数字输入。这些对于临时用户来说是理想的，但是因为它们是按价格制作的，而不是按质量制作的，所以你不会得到和手动设置一样好的结果。

一旦你将录音数字化，接下来的事情就是从名为`side_1.wav`的文件中提取单个的音轨，并对它们进行相应的编码。有一些工具可以自动做到这一点。Audacity 有自己的静音查找功能(在“分析”菜单中)，它会在录音中寻找合适的长间隔，并在它们旁边放置标记。然后，您可以根据需要调整这些标记，并选择“导出多个”以将这些标记之间的数据保存为单个文件。

然后，您可以对它们进行适当的编码。这里有一个例子:

`#!/bin/bash`

`LIST="$(ls *.wav)"`

`for FILE in "$LIST"; do`

`flac $FILE`

`done`

或使用以下内容:

`oggenc $FILE`

根据音乐和您对高保真音频的个人意见，您可以选择以一种或多种格式保存该音乐。最直接的方法是只保留 OGG 的文件，因为它们适合于随意的室内监听和一些相当复杂的批判性监听。对于更有眼光的发烧友来说，免费无损音频编解码器(FLAC)提供了与 WAV 相同的质量，但占用空间更小。有些人会将 FLAC 版本存储在单独的(离线)硬盘上，而日常使用 OGG 文件。这允许在以后有更好质量的编解码器可用时重新编码高质量的录音，而不需要重新剪辑数据。

真正的音响发烧友永远不会对电脑声卡感到满意，也不应该一开始就翻录音乐！

## 仓库

所有数据都必须存储在某个地方。在桌面计算中，这是一个内部硬盘。在家庭自动化领域，我们希望该硬盘在其他任何地方都可以使用。这通常意味着它必须在网络上，并由 Samba 之类的网络服务控制。

### 独立的 NAS 系统

实际上，网络可寻址存储(NAS)是一种通过网络电缆和 IP 地址而不是 ide、SCSI 或 SATA 电缆连接到外部世界的硬盘驱动器。这种方法有两个主要优点。首先，通过天生的网络感知能力，您可以在世界上任何地方使用这些文件，只需很少甚至不需要额外的配置。这包括你的办公室、你伴侣的办公室、卧室，甚至是花园里或火车上无线连接的笔记本电脑。第二，通过与主计算机分离，您可以将 NAS 驱动器藏在橱柜或阁楼中，从而整理您的主要工作区域。这有一个安全上的好处:任何偷你电脑的窃贼也没有偷你的数据。

自然，如果没有计算机来控制硬盘驱动器，就必须在数据链的某个地方有一个驱动程序来决定光盘格式、容量和网络连接。这可以存在于 NAS 单元本身中，也可以来自想要读取驱动器的服务器。有许多不同的版本可供选择。

#### 硬盘注意事项

任何 NAS 的主要卖点都是其存储能力。目前，少于 1TB 的硬盘很少见，幸运的是，由于逻辑块寻址(LBA)的 28 位寻址模式，许多老式 IDE 硬盘的容量限制为 137.4GB。如果制造商正在使用旧硬件，即使它支持外部 USB 驱动器，也要避免小于 137.4GB 的容量，因为这总是受到相同的限制。

伴随着磁盘空间的争论的是磁盘格式的概念。这通常以 FAT、FAT32、NTFS 或 ext2 给出，并限制可能的最大文件大小(如表 [3-1](#Tab1) 所示)。如果您需要在另一台机器上安装驱动器，该格式还决定了您能够恢复它的可能性。

表 3-1。

Filesystem Functionality

<colgroup><col> <col> <col></colgroup> 
| 文件系统 | 最大文件大小 | 最大卷大小 |
| --- | --- | --- |
| FAT16 | 2GB | 2GB |
| FAT32 | 4GB | 2tb 或 8TiB * |
| Windows NT 文件系统(NT File System) | 16EiB | 16EiB |
| ext2/ext3 | 16GB 至 2tb | 2tb 至 32TiB * |
| ZFS | 16EiB | 16EiB |

* Variation depends on cluster size when formatted.

因此，很明显，如果您希望 NAS 存储 DVD 映像，您将需要一个能够支持 4.7GB 文件的文件系统。这通常意味着基于 FAT 的系统是不够的，或者你将不得不删除 DVD 菜单，并将电影重新编码成另一种(更小的)格式。

恢复问题稍微复杂一些。如果您必须从 NAS 安装中取出硬盘，并将其放入标准 PC 中以恢复数据，您将需要一台能够读取 NAS 使用的任何文件系统的 PC。

NTFS 在 Linux 兼容性方面稍微好一点，但也差不了多少。虽然在 Linux 下可以读取 NTFS 分区，但是写回它们被认为是危险的，尽管有两个开源驱动程序(强制 NTFS 和 NTFS-3G)支持它。此外，有一个商业驱动程序(NTFS for Linux，Paragon)可以解决同样的问题。对于基本恢复，只读光盘就可以了，尽管在大多数情况下，不重新格式化就无法修复光盘。

自然的解决方案是对任何和所有 NAS 驱动器使用 ext2，因为这在 Linux 世界中得到最广泛的支持。许多 NAS 设备现在都支持这一点，所以多花一点钱买一个还是值得的，因为它符合所有的条件。如果你家里的主要台式机是 Windows，那么甚至还有 Windows 的 ext2 恢复工具比如 Linux Recovery from DiskInternals。

您存储的数据类型将决定您需要的备份计划的类型。如果是个人数据，如信件或照片，那么可以考虑内置 RAID 功能的 NAS。当插入第二个驱动器时，它们通常会自动配置自己，所以如果你插入一个用过的驱动器，以为会获得额外的空间，就要小心了！有几种类型的 RAID 配置可用，但在这种情况下最常见的是 RAID-1，它使用第二个驱动器来制作写入第一个驱动器的任何内容的相同副本。它自动且对用户透明地执行此操作，因此如果其中一个驱动器出现故障，另一个可以用来恢复数据。但是，您应该始终记住，RAID 不是备份！这只是降低了因磁盘故障而丢失数据的可能性。它不能防止控制器故障、火灾、洪水或盗窃造成的损坏。

Note

对于一些系统管理员来说，使用硬件 RAID 解决方案是一把双刃剑。它们无缝地工作，不需要任何设置和维护工作。但是，如果 RAID 系统出现问题并使用自定义磁盘格式，则可能无法恢复磁盘上的数据。您可以通过购买两个硬件来解决这个问题，并在将磁盘投入使用之前验证您可以交换磁盘而不会出现问题。或者，您可以向制造商核实所使用的磁盘格式是已知的还是附带了合适的软件恢复工具。

备份数据，如 DVD 或音乐片段，不需要(也不应该)RAID 尽管有一个没有坏处。因为这种类型的数据更改频率较低，所以您可以将外部 USB 硬盘插入您的台式机。然后，您可以运行您选择的备份软件(参见[第 6 章](http://dx.doi.org/978-1-4302-5888-9_6)了解此处的一些可能性),仅复制那些已更改的文件，然后拔出并存储驱动器。这延长了驱动器的寿命，值得付出额外的努力。

与所有备份一样，除非定期测试，否则它们毫无用处，所以请确保您确实测试了它们。有些人会每隔 6 到 12 个月将他们的备份拷贝到一个新的驱动器来测试它们。与花在抓取和组织数据上的大量时间相比，成本可以忽略不计。此外，每千兆字节的价格每年都在下降，使您可以在更小的尺寸中存储更多的数据。如果您迫切需要额外的空间，那么您可以在系统的其他地方重用旧的驱动器。虽然磁带备份系统是大多数企业的最爱，但 USB 硬盘驱动器的成本和便利性使它们在家庭市场上没有必要。

Note

硬盘要么在头几周出现故障，要么在你记得备份的前一天出现故障。所以买盘的时候，一定要在不同的厂家，不同的时间买，所以如果你拿到一个不良批次的盘(IBM 死星，挂你头！)，你就最小化了自己得到两个的机会。

#### 网络注意事项

在大多数情况下，NAS 的网络设置非常简单。通常，它会通过 DHCP 获得自己的 IP，并通过 CIFS/桑巴的服务提供对磁盘的访问。有时您需要一台 Microsoft Windows 机器来运行安装软件，但这种情况越来越少，因为配置是通过在 n as 上运行的网页来完成的。这里的主要警告是要注意那些没有 Samba 服务，而是依赖于诸如 ZFS 之类的东西的机器。

ZFS 是一个起源于 Sun Microsystems 的文件系统，是 Netgear SC-101 等 NAS 系统的特色。但是，尽管 ZFS 规范及其在大型商业系统中的使用，它还没有一个合适的内核驱动程序(因为许可证不兼容)。目前它只能与用户空间中的文件系统(FUSE)项目或提供的封闭 Windows 驱动程序一起运行。因此，如果只提供 ZFS 服务(例如前面提到的 SC-101)，则需要在每个想要从 NAS 读取数据的设备上安装特定的驱动程序。这使得它对 PC 用户来说很烦人，对 Squeezebox 等其他硬件来说是不可能的。

通过 Windows Vista [<sup>5</sup>](#Fn5) 控制 NAS 可能会有问题，因为一些 NAS 系统使用备用身份验证系统。这个问题可以通过以下注册表修改来解决:

`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa`

通过设置此选项:

`LmCompatibilityLevel = 1`

#### 额外功能

由于许多 NAS 驱动器比嵌入式 Linux 机器大不了多少，所以添加额外的软件是微不足道的...对于制造商来说。典型应用包括以下内容:

*   打印机服务器
*   BitTorrent 客户端
*   备份支持
*   iTunes 服务器

如果你想添加自己的软件，那么你通常是不走运的，除非你有一个已经被黑客攻击的变种，如 NSLU2，或者你有很多时间自己发现黑客！当计划一个大得多的家庭安装时，您可能只需要一个非常基本的 NAS 驱动器，因为您很可能很快就会升级到一个定制的 Linux 服务器，该服务器将支持您可能向它提供的所有额外功能，并且 NAS 服务是免费的。

当您购买第一个 NAS 时，不要担心额外的功能，而是担心它支持的存储空间，因为您可能没有足够的可用空间来保证在其上运行 BitTorrent 客户端。如此多的 NAS 机器以相当便宜的价格提供，以至于您不需要担心将所有东西都放在一个盒子里。将一个具有数 TB 空间的 NAS 用作 DVD 和 CD rips 的主要媒体存储区域，而将另一个用作辅助存储和功能服务器，这种情况并不少见。然后，第二个 NAS 充当您的台式 PC 和打印机服务器的每日备份。这些角色允许您在不需要时关闭一个 NAS(也许通过 X10)。

### 带媒体播放的 NAS

对某些人来说，这只是一个背面带有电视输出插座的 NAS。对其他人来说，它构成了一个范式的转变，因为它允许你把这个单元当作一个便携式录像机和视频库。和所有东西一样，它的价值取决于你打算如何使用它。

这些设备的一大卖点是它们可以从一个房间移动到另一个房间，甚至从一个房子移动到另一个房子，而不需要网络。这使得向您的家人和朋友展示您的照片和家庭视频变得更加容易，因为您只需将支持媒体的 NAS 设备插入任何电视，它就会工作。这也是一种引入(小级别)控制孩子们能看什么的方式，因为他们将被限制在硬件的内容上。

Note

有许多应用程序会阻止儿童安全观看内容。但正如育儿书籍告诉你的(或者，任何父母都知道的)，你不能完全靠技术来解决这些问题，因为这不是真正的技术问题。

如果您想将您的媒体扩展到一个房间之外，您需要一个支持以太网的版本，如 Freecom 的 MediaPlayer II 或 cineDISK NAS。这些是组合的 NAS 驱动器，通过 Samba 支持文件共享，以及向电视或 HiFi 播放文件的媒体流。它们的优势在于能够从本地磁盘进行流式传输，从而消除了任何网络延迟，并限制了独立媒体单元(如 MediaMVP)的成本。此外，通过在这些设备之间分发您的媒体，如果一个未备份的硬盘出现故障，您不会丢失所有东西。只需很少的努力，你就可以将文件分发到那些更有可能播放它们的机器上，比如客厅里的电影、卧室里的电视剧、书房里的 MP3，以及孩子房间里的动画片。如果您以这种方式分离介质，请注意潜在的存储升级。一些设备为外部硬盘驱动器或记忆棒提供了 USB 端口(尽管一些较便宜的机器只打算为记忆棒提供 USB 端口，不支持大磁盘大小)，因此请将这些机器放置在最有可能增加其磁盘占用空间的房间中。从个人经验来看，存储电视节目的磁盘填充得最快。

与所有嵌入式硬件一样，这类设备的问题来自于它们的升级路径，并非所有公司都会添加或发布带有最新编解码器的新固件或对旧固件的修复；许多设备太新，没有黑客社区来帮助。此外，与 MVPMC 不同，在这种情况下通常没有办法使用外部代码转换器。

此外，请仔细检查每个设备的规格，因为尽管包装盒上有“NAS”的名称，但并非所有设备都提供网络插座。一些制造商将声称它是“高清就绪”,而他们的意思是它将解码文件...但是只能以标准清晰度观看。此外，许多播放器没有硬盘，但需要硬盘，即使您只想通过网络传输媒体，如 Emprex 多媒体播放器。

然而，关注这些设备的市场总是值得的，它们通常会提供可以在软件中实现的新想法，例如“在电视上观看 YouTube”功能。

### 配置 Linux 机器

到目前为止，最灵活的 NAS 服务器是您为自己构建的服务器。任何机器都是合适的，因为处理能力不需要很大，所以它可以是一台旧的笔记本电脑，迷你 ITX 盒，或 NSLU2。唯一的要求就是要有网络兼容性。可选功能包括 USB 端口(用于附加驱动器)和带有 48 位 LBA 的现代 BIOS，因此它支持大于 137.4GB 的磁盘。这不仅仅适用于内部磁盘；如果您使用外部 USB 硬件，这也是必要的，因为它们通常依赖于机器来控制磁盘。

与以往一样，没有必要将所有媒体存储在一台机器上，也没有必要将一台机器仅用作文件服务器。如果您要将媒体分布在不同的物理磁盘上，那么最好将需要较高比特率的媒体(如电影)存储在内部驱动器上，将低比特率的媒体(如卡通或音乐)存储在外部驱动器或较慢的服务器上。

每台机器都需要按照你在第 1 章中看到的那样进行设置，但是如果有多台服务器或者你可能要移动这些单元，你需要注意你的命名约定。

#### 准备机器

由于每台机器都是基于 Linux 的，它们已经有了自己的文件系统(包括基于文件系统的商业设备)，所以这里您唯一的任务就是为您的文件提供一个位置。

对于内部硬盘，总是为您的媒体创建一个单独的 ext3 分区。使用了一个单独的分区，这样就可以单独安装它(这样在崩溃或断电的情况下更容易恢复)，ext3 提供了一个日志文件系统。此外，因为媒体分区很可能是第一个被填满的分区，所以如果您的 Linux 机器发现没有剩余的磁盘空间，它也不会遇到问题。通过向`/etc/fstab`添加一个文件来提供一个挂载点:

`/dev/sda7 /mnt/mediadisk auto user,noauto  0    0`

并从更方便的地方创建硬链接；我在服务器上使用一个名为`/media`的根文件夹:

`ln /mnt/mediadisk/media/tv /media/tv`

请注意，我没有将文件存储在`sda7`分区的根目录中，而是存储在`media/tv`文件夹中。如果磁盘的用途扩展到包括额外的功能，如备份，这种传统的目录结构将使我受益。

外部 USB 硬盘的工作方式相同，但在`/etc/fstab`中使用了不同的线路:

`/dev/sdb1    /mnt/usbdisk0 auto user,noauto   0    0`

在这两种情况下，磁盘都不会自动装载。这是个人偏好，因为它要求——也要求我——在重大电源故障或崩溃后检查磁盘，其他人可能会忽略或跳过这一步，从而损害文件系统。

外部 USB 设备的另一个变化是，由于目录位于不同的物理磁盘上，因此需要使用符号链接:

`ln -s /mnt/usbdisk0/media/tv /media/tv`

这些驱动器的一个额外功能是记录哪个物理硬盘用于存储内容。这是在驱动器损坏或即将损坏，并且您需要移除正确的驱动器时使用的。在以相反顺序安装两个 USB 驱动器的情况下，这也很有帮助。

为此，我只需切换到相关驱动器的根目录，并键入以下内容:

`touch THIS_IS_THE_SILVER_LACIE_500G_DRIVE`

`touch THIS_SHOULD_BE_MOUNTED_UNDER_SDB1`

这证明了不污染根部的另一个原因。如果你遵循了从不同制造商购买硬盘的建议，这些名字很容易挑选。

#### 准备文件系统

一旦机器准备就绪，就必须考虑媒体文件系统；你必须从全局的角度来考虑这个问题，包括每台服务器和整个房子。存储链有三个要素需要考虑:

*   机器名称
*   机器的物理位置
*   存储在该计算机上的媒体的共享文件夹名称

把这些整理一下，机器名称往往会由厂商提供，比如`cineDISK`。如果你有能力，将其重命名为`cineDISK1`，并在设备背面添加一个粘性标签来表明这一点。如果可能，请始终为设备添加一个递增的数字，因为这将使扫描、备份和维护脚本更容易编写，因为每个名称都是按逻辑创建的，没有任意的限制。

您可能想在不提及制造商的情况下命名设备，如`media_nas1`所示。这也很好，但是建议您注意这指的是哪个设备。我在家里的内部 wiki 上使用一个页面，其中包含所有连接到我的网络的硬件的设备、型号、MAC 地址、固件版本、网络论坛等等。我还用它来记录每台机器的物理位置。

共享文件夹的名称应该都遵循一个约定，比如`media_movies`、`media_tv`等等。如果你有孩子，并为他们提供网络访问，那么提供单独的文件夹，如`media_kids`可能是个好主意。将所有介质拆分到单独的共享文件夹中的原因是，每个介质都可以有不同的 Samba 访问权限(每个介质都有或没有密码),并且可以自行卸载，而不会影响系统的其余部分。如果只有根`media`文件夹是共享的，那么控制一个`media/movies`目录将会更加困难。

#### 准备主服务器

到目前为止，我们有许多服务器，有大量的技术信息和元数据。这些名字都是出于维护的目的。没有用户会想要或者需要知道这些卡通片在备用卧室的`media_children`下面的`media_nas2`上。家庭成员也不应该对你将`movies`文件夹分割成两个独立的磁盘 [<sup>6</sup>](#Fn6) 感兴趣，因为对于旧的驱动器来说太多了。为此，您应该指定一个主服务器。它可以是媒体服务器之一，也可以是完全不同的机器。建议这台主服务器运行家中最重要的服务，也是 24/7 全天候运行的服务。这允许它被用作 Node0，你将在第 4 章中了解到。

然后，这个 Node0 机器将每个共享文件夹从每个服务器挂载到它自己的目录结构中。正是这种共享的目录结构使得每个媒体流设备都可以访问媒体。

Note

乍一看，NAS1 连接到 Node0，然后再连接回 NAS1 似乎有些浪费，但要有效地向上扩展，在统一的环境中提供所有媒体，并支持媒体架构的动态变化，这是最好的方法。

我使用的目录结构将所有 Samba 共享放在一起，如下所示:

`/net/homenet/slug1/media_tv`

像这样的本地磁盘:

`/net/homenet/mediapc1/usb2/media/movies`

到`/net/homenet`下面的层次结构中，作为一些链接或 Samba 挂载。这将成为一份关于家庭媒体服务器布局的自记录报告。然后，我在`/net/media`目录下创建一系列链接来隐藏结构:

`ln -s /net/homenet/mediapc1/usb1/media/tv   /net/media/tv`

`ln -s /net/homenet/mediapc1/usb2/media/movies /net/media/movies`

`ln -s /net/homenet/itx1/usb1/media/mp3    /net/media/music`

`ln -s /net/homenet/slug1/usb1/media/videos  /net/media/videos`

然后，为每个目录添加 Samba 共享就很简单了:

`[media_tv]`

`comment = Media (TV)`

`path = /net/media/tv`

`browseable = yes`

`public = yes`

`writable = no`

`read only = yes`

`guest ok = yes`

如第 1 章中的[所示，我为家庭创建了只读的基本 Samba 共享，并为我创建了单独的受密码保护的读写共享。](http://dx.doi.org/978-1-4302-5888-9_1)

还要注意，我使用了我家的子域(`homenet`)作为与目录其余部分的分隔符，而不是将所有内容都放在`/net`中。作为一名软件开发人员，它允许我创建自己的子网，它不是一般家庭自动化网络的一部分，以防我需要做一些冒险或实验！

## 媒体扩展器

一旦你有了一个文件服务器来提供对你的媒体的访问，你就需要某种方式来将媒体以听觉或视觉的方式呈现给世界。这可能涉及独立的硬件、基于 Linux 的机器或两者的组合。

### 独立硬件

要符合这一类别，硬件必须连接网络，使用 DHCP 来确定其 IP 地址，然后将数据从文件服务器传输到物理连接的电视或扬声器。这些设备总是使用 Samba 作为文件服务器，因为安装特定的驱动程序(比如 ZFS)在现实世界中是不可能的。

#### Hauppauge MediaMVP

尽管该设备可追溯到 2002 年，但它可以通过网络传输音乐、标清视频和图片，并在电视上显示。零售单元相当便宜、小巧、安静，是理想的主机单元。它只有三个插座:电源、RJ-45 以太网和 SCART。(美国版本将最后一个插座扩展到 S-Video、复合视频和立体声音频。)

为了工作，MediaMVP 需要三个独立的服务: [<sup>7</sup>](#Fn7) DHCP，用于启动过程的 TFTP，以及用于数据的 Samba，因为它没有自己的存储设备。开箱即用，这些服务是由一个 Windows 软件提供的，该软件有许多限制，如缓慢的菜单系统。这台机器还会阻止你观看任何非 MPEG1 或 MPEG2 编码的视频。这是因为视频信号是由 MediaMVP 内部的自定义芯片解码的，该芯片仅支持这些早期的编解码器。幸运的是，MediaMVP 启动时使用的协议是标准的，这使得您可以将 Linux 用作服务器。然后，你可以通过替换在实际设备上运行的固件，让它连接到 VLC，将你的文件实时转码为 MPEG2，从而更进一步。

#### 创建服务器

MediaMVP 的启动过程是双重的。首先，它发送一个 DHCP 请求，请求它自己的 IP 地址和 TFTP 服务器的地址。其次，它使用这个 TFTP 服务器下载固件，固件最终在 MediaMVP 上运行，成为媒体设备。

首先将配置添加到`/etc/dhcpd.conf`:

`group {`

`next-server 192.168.1.2;     # IP address of your TFTP server`

`host mvp {`

`hardware ethernet 00:0d:fe:00:15:8D; # of the MediaMVP`

`fixed-address 192.168.1.98;`

`filename "dongle.bin";`

`}`

`}`

地址不必是固定的；然而，我在我的网络上采用了一种约定，表明我的子网上地址小于 100 的任何机器都是“内部设备”，如服务器或嵌入式硬件，不容易改变或移动，因此总是可用的。所有 100 或更大的都是一台随时可能从网络中移除或关闭的计算机。

从这里，控制被传递到 TFTP 服务器，以便 MediaMVP 可以请求固件，由文件名`dongle.bin`给出。

TFTP 代表普通文件传输协议，它是通常用于在机器之间复制文件的 FTP 的一个非常简化的版本。它按正常方式安装:

`apt-get install atftpd`

这将在`/etc/inetd.conf`和`/etc/default/atftp`中添加适当的行，指示文件传输的目录(通常是`/var/lib/tftpboot`)。在我看来，与 TFTP 的主要区别在于 TFTP 不能使用用户名和密码。虽然这可能会使程序员的原始工作变得非常简单，但这是以安全性为代价的，这意味着您不应该向世界开放 TFTP 端口(UDP 69)。

然后，您可以将`dongle.bin`文件复制到`/tftpboot`文件夹，并打开 MediaMVP。从这里开始，将`dongle.bin`替换为 MediaMVP 可用的其他固件(如 MVPMC)是一件简单的事情，以提供改进的功能，如实时视频代码转换或与 MythTV 连接。

#### MediaMVP 媒体中心

这可能是目前可用的功能最全的替代固件；可以从 [`http://www.mvpmc.org`](http://www.mvpmc.org/) 下载。它包括一个替换文件`dongle.bin`和一个配置文件。因为 MediaMVP 本身运行的是一个小版本的 Linux，所以这个配置文件只是一个包含 shell 命令的脚本，这使得修改固件映像而不重新构建它变得非常简单。至少，它应该包含将目录装入文件系统并调用主`mvpmc`程序的命令:

`mkdir /media`

`mount.cifs "//192.168.1.110/media" /media -o user=mvp,pass=mvppass,rsize=34000;`

`mvpmc &`

然后，您可以根据想要引入的额外功能向该命令添加参数。我现在将介绍其中的一些。

Note

在 MediaMVP 中也不能使用来自`mount.cifs`命令的匿名登录，所以在运行文件服务器的计算机上创建一个单独的 Linux 帐户(在本例中为 192.168.1.110)。因为此用户名/密码在配置文件中可见，并且此配置文件对任何具有 TFTP 访问权限的人都可见，所以您应该加倍确保它在您的网络之外不可见。

##### 天气预报

这些数据是从 Yahoo！天气服务，并通过图形从屏幕上的一个菜单选项中呈现。它需要知道你在世界上的什么地方，并且你可以访问互联网。对我来说，在伦敦，这需要以下替代路线:

`mvpmc --weather-location UKXX0085 &`

您可以通过访问 [`http://weather.yahoo.com`](http://weather.yahoo.com/) ，搜索您所在的城镇或城市，并抓取 RSS 提要来确定此代码。这将引导您进入如下 URL:

[T2`http://weather.yahooapis.com/forecastrss?p=UKXX0085&u=c`](http://weather.yahooapis.com/forecastrss?p=UKXX0085u=c)

您会注意到城市代码(`p=UKXX0085`)和单位(`u=c`)，允许您以摄氏度或华氏度来表示数据。

##### 视频转码

硬件解决方案的最大问题是缺乏升级途径。虽然 MediaMVP 提供了一种改变固件的方法，但是 MVP 硬件没有使用足够强大的处理器来允许固件实时解压缩视频。不要将您过去的所有 DVD 片段转换成合适的格式，而是可以在您观看它们时即时转换格式(称为转码)。这需要配置 MediaMVPMC 和运行 VLC 的代码转换服务器。

首先，您需要添加适当的参数，告诉 MVPMC 代码转换服务器的地址。

`mvpmc --vlc 192.168.1.110 --vlc-vopts dvd &`

自然，就像我们见过的其他服务器一样，服务器只涉及软件，可以与 DHCP 或 TFTP 服务器存在于同一台物理机器上。但是，由于需要增加处理能力，您可能希望在单独的机器或桌面上运行转码软件。这允许你有一个小的，低功耗的服务器来运行你家的主要系统，只有在必要的时候才使用“大铁”。

Tip

代码转换服务器只需要一个具有合理规格的 CPU，这意味着一个旧的精简版 P3 或 P4 就足够快了。利用你的桌面通常是一个好主意，因为转码不会降低你的工作速度，因为那时你正在看电影！

根据转码服务器的速度，您可能无法管理最高质量的图像。通过将`–vlc-vopts`修改为 SVCD 或 VCD，您可以将合成质量分别降低到超级视频 CD 格式或标准视频 CD 格式。

Note

MediaMVP 设备本身只有输出标清图像的硬件。如果你一直将蓝光光盘翻录为高清文件，那么你需要使用 VLC 将它们转码为标清格式。

还建议您使用`--use-mplayer`命令行开关，如果 VLC 不能正确理解文件格式，它将切换到`mplayer`转码。

使用代码转换服务器的最大注意事项是，MVPMC 客户端软件播放的文件名必须与 VLC 在服务器上看到的完全相同。这可以通过小心使用符号链接来安排，因为我的媒体安装在磁盘的其他地方，我不想改变它。因此，我在我的服务器根目录下创建了一个特殊的文件夹，其中包含适当的链接:

`mkdir /mvpmc_media`

`ln -s /media/mp3 /mvpmc_media/mp3`

`ln -s /media/movies /mvpmc_media/movies`

`ln -s /media/videos /mvpmc_media/videos`

然后，我在 MediaMVPMC 上复制了这些文件，创建了自己的`mvpmc_media`目录，并通过网络挂载这些文件夹:

`mkdir /mediamount`

`mkdir /mvpmc_media`

`mount.cifs "//192.168.1.110/media" /mediamount -o user=mvp,pass=mvppass,rsize=34000;`

`ln -s /mediamount/videos /mvpmc_media/mp3`

`ln -s /mediamount/videos /mvpmc_media/movies`

`ln -s /mediamount/videos /mvpmc_media/videos`

如果您愿意，您可以在 MVPMC 运行时通过动态应用挂载指令来测试它们，因为您可以`telnet`进入 MediaMVP 硬件(用户名:root，无密码)并直接发出命令。

这个过程还有另一个好处，因为 MVPMC 上的文件系统浏览器非常简单；一个名为`vids`的目录对于创建它的极客来说可能已经足够好了，但一个更具描述性的标题，比如充满大写字母和空格的`Music Videos`，会受到其他家庭成员的欢迎。因此，您可以使用全名重复前面的过程来实现这个目标，而不违背您的 Linux 命名约定。

Note

虽然 DVD VOB 文件可以在此系统上播放，但不支持 DVD 菜单。

##### 其他功能

MVPMC 中可用的其他功能包括:

*   从 MythTV 或 ReplayTV 获取数据
*   VNC 观察报
*   流媒体直播网络电台

它们的设置要求非常简单，在线文档中也有介绍，所以我不会在这里介绍。

#### 极端

这是通过电视或 HiFi 系统播放媒体文件的几种设备之一。它的低价位和包含的 HDMI 使它成为进军媒体流的好机会。它是一个很好的测试单元，因为它支持从其内部磁盘、外部驱动器或网络(有线和无线)播放媒体。这使得它适合尝试不同的配置，而无需购买额外的盒子。除了音乐和电影，它还支持图像预览、天气预报以及来自 YouTube、Picasa 和 Flickr 的直播。

#### 手风琴

该设备于 2003 年推出，是 MediaMVP 的纯音频版本之一，具有类似的“黑客能力”它也适用于客户机/服务器结构。本例中的服务器是一组运行在 Linux、Mac OS X 和 Windows 上的开源 Perl 脚本，名为 SqueezeCenter(以前的 SlimServer)。这为客户端提供了本地存储音乐的音频数据，并提供了一种连接到外部源(如互联网收音机或 MP3tunes music locker)的方式。它还能够通过向客户机发送命令来控制它们。服务器本身不播放音频，尽管您可以在同一台物理机器上运行软件客户端来透明地实现相同的结果。

然后，您需要一台或多台客户机(即主机)在远程房间播放音乐，通过有线或无线网络连接。该头单元可以如下:

*   Squeezebox Classic，带显示和输出到 HiFi 放大器
*   Squeezebox 接收器，无显示器，遥控
*   Squeezebox 吊杆，带显示器、内置放大器和扬声器
*   Transporter，据报道是一个更高质量的播放引擎
*   软件客户端

使用适当的遥控器，您可以将 Squeezebox 实例链接在一起，以便它们都能播放相同的音乐，从而提供完整的全屋音频系统。

##### 服务器软件

Linux 下的安装非常简单，通过使用软件客户端，您可以测试环境，而无需购买任何硬件。首先，转到`/etc/apt/sources.list`，在文件的任意位置添加以下内容:

`deb`[`http://debian.slimdevices.com`](http://debian.slimdevices.com/)T2】

接下来，执行以下操作:

`apt-get update`

`apt-get remove --purge slimserver  # in case of an old install`

`apt-get install squeezeboxserver`

并且，在确保您的音乐收藏为(新)SqueezeCenter 用户设置了适当的读取和执行权限后，您可以连接到它的 web 服务器(在端口 9000 上)并配置服务器。

##### 其他软件

SoftSqueeze 是 Squeezebox 硬件的软件仿真，可从 [`http://softsqueeze.sourceforge.net`](http://softsqueeze.sourceforge.net/) 获得；它支持 Linux、Mac OS X、Windows 和大多数具有良好 Java 实现的平台。这对于测试新服务器和用作标准媒体播放器来说是很好的；但是，由于过分热衷于模拟双线 LCD 仿真，导航有点令人厌倦。然而，如果你愿意，你可以使用 SqueezeCenter 软件——通过其网络界面——来控制播放列表。当然，通过打开适当的端口，您可以远程完成这项工作。

Videobox ( [`http://videobox.sf.net`](http://videobox.sf.net/) )是一种使用(硬件)Squeezebox 将其红外信号传回服务器的方法，因此它可以触发外部脚本和代码。给出的一个例子是在服务器上开始电影回放，以便可以在屏幕上观看。

#### 霸王龙 ME1

这款现代设备诞生于 2007 年，是目前可用的几种媒体播放设备之一。它声称支持高清输出，但缺少 HDMI 端口；因此，它通过 720 便士或 1080 英镑的高档 via YPbPr 提供其最高品质。它也可以作为一个 AV 记录器，但只能通过复合输入。该单元使大多数用户受益的地方在于它的低成本和本地存储支持。这可以通过 IDE 硬盘(或 SATA 硬盘，最新版本也可以将存储空间从 500GB 增加到 750GB)或 USB 进行，无论是记忆棒还是 USB 硬盘。

与许多技术一样，建议使用最新的固件；它现在支持 NTFS(默认文件系统是选择不当的 FAT32，它限制了最大文件大小)，并且内部硬盘也存在稳定性问题。幸运的是，在后来的固件上，内置磁盘是可选的，允许你使用一个连接到 USB 的磁盘。

当然，该设备也可以从网络上读取电影文件，你也可以用它来删除 ME1 的本地存储上录制的电影，以便在其他地方存档。这个方法在(非常)低流量的网页 [`http://emprex-me1.blogspot.com`](http://emprex-me1.blogspot.com/) 上有详细介绍，还有他们的谷歌群列表。

### 只有 Linux

这些年来，GNU/Linux 操作系统出现在如此多的发行版中，很难跟上它们的步伐。许多人在职业生涯早期就接受了一个，并且从未改变。当使用 Linux 机器作为媒体播放器的基础时，这些规则需要重新考虑，因为对桌面有好处的不一定对媒体播放有好处。因此，我将考虑一个合适的 Linux 发行版的必要的好处和特性，并且只提到细节作为例子，因为在硬件的情况下，这个领域发展得太快，不能给出明确的“最佳”答案。

#### 操作系统

从真正的意义上来说，操作系统由内核、驱动程序、模块和相关软件组成。这些组件打包在发行版中，以便于安装。因此，在选择合适的分布时，需要考虑的变量很少。

首先，也是最显而易见的，您需要获得为所提供的内核构建的健康的驱动程序。硬件，尤其是图形等高端领域，需要高性能和特定的驱动程序来确保其得到有效利用。虽然大多数显卡没有加速板载视频解压缩，但它们有许多其他功能的硬件加速，这将显示视频性能的显著改善。

第二，你应该考虑启动时间。例如，xPUD 需要大约 10 秒钟，使它看起来像一个真正的机顶盒，而不是一台小型计算机。XBMC，正如你在[第二章](http://dx.doi.org/978-1-4302-5888-9_2)中看到的，也在这个范围内。

最后，需要确定分布的总大小。这总是最后一个考虑因素，因为它可以不费吹灰之力解决，也就是说，在更大的硬盘或固态存储卡上多花几分钱。后者对于大多数媒体流机器来说是更好的，因为你可以更快地从它们启动，它们持续更长时间(因为更多的操作是内存读取，而不是内存写入，并且没有移动部件)，并且它们允许更小的外形尺寸。如果您正在构建自己的专门用于媒体流的 Linux 机器，那么请确保它能够支持从压缩闪存或 USB 记忆棒启动。

#### 软件

一个好的媒体播放器发行版主要不是取决于操作系统，而是取决于软件。毕竟，它是你将要与之互动的软件。大多数媒体流开始时都是媒体播放器。这些对于一个流光来说是完全错误的。考虑这样一个基本场景:你坐在椅子上看着 2 到 3 英尺外的显示器，桌面上有一个由鼠标和键盘控制的媒体播放器。唉，大多数软件都是在台式电脑上开发和测试的，细微的差别可能会被忽略。请记住考虑以下几点:

*   视觉效果:你通常会坐在舒适的椅子上从很远的地方使用这个界面。因此，按钮和字体需要大而清晰，放在一个整洁的屏幕上，对比度适中，有抗锯齿功能。
*   屏幕:除非你的客厅里有最新的 LCD 技术，否则你的电视质量通常会比你的显示器低得多，所以小细节(尤其是细水平线)会丢失或在屏幕上无法分辨。
*   控制:毫无例外，任何没有远程控制选项的家庭影院电脑都会失败。没有人会离开舒适的椅子去按机器上的按钮，或者想要一个键盘或鼠标放在他们的腿上。
*   可导航的界面:与控件一起，必须有一个清晰的方式在菜单选项之间移动。只有在初始化期间，才可以用键盘输入服务器 IP。

所有这些点都被归类为一种被称为“10 英尺用户界面”的方法这并不是说这些规则是金科玉律或不可改变的，但是在一个软件中发现几个违背这些规则的地方可能是一个线索，表明这个项目还不是特别成熟，在现实世界中很少使用。

##### 神话电视

在所有的 Linux PVRs 中，最著名的可能是 MythTV ( [`http://www.mythtv.org`](http://www.mythtv.org/) )。这由两部分组成——后端(`mythback`)允许你将电视卡上的节目录制到本地硬盘上，前端从`mythback`服务器上播放媒体文件。通过这种方式，您可以拥有一个功能强大的单一服务器，其中包含许多电视卡和软件，这些软件可以协调用这些电视卡录制频道的最佳方式，还有许多放置在房间各个角落的小型前端设备，它们都从服务器获取数据。这也提供了一种在房子周围流式直播电视的方式。

除了媒体播放，MythTV 还支持替代皮肤和插件模块，允许前端单元显示天气、显示照片库、玩游戏和上网冲浪。

如果你正在寻找一个 PVR 独立的外形，你可以将`mythback`和`mythfront`整合到同一台机器中，只要它足够强大。带有硬件编码的电视卡(如较新的 Hauppauges)有助于减小该机器的尺寸和功耗，让您可以使用无风扇系统。

PVR 的软件方法总是胜过硬件，因为可以更有效地添加新功能，并且可以迎合编解码器的变化。我现在将简要介绍一些例子。

##### 弗利普

Freevo ( [`http://freevo.sourceforge.net`](http://freevo.sourceforge.net/) )是一款以恶名昭彰的硬件 PVR 的名字命名的名为 TiVo 的游戏。 [<sup>8</sup>](#Fn8) 它是一种一体化的方法，在同一个软件中实现视频捕捉、录制和回放。(但在引擎盖下，它有一个单独的电视服务器部分。)这使得它更接近于 Xtreamer 类型的设备，尤其适合于更受控制的安装。

像 MythTV(和大多数软件 PVR，如果我诚实的话)一样，它也可以支持皮肤界面和插件，尽管大多数已经被折叠到软件的稳定版本`freevo1`中，所以任何改变都需要比平时更大的重新编译。这使得临时开发人员更难做出更改。这些插件包括常见的天气预报、X10 控制(通过`heyu`)、Skype 和 Flickr。

它也有 LiveCD 版本的图像(老实说，和大多数软件 PVR 一样)，所以你不用在你的硬件上安装就可以测试它。

##### 播放器

这是提醒跳过[第二章](http://dx.doi.org/978-1-4302-5888-9_2)的人回去看一下！XBMC 支持和运行的非 Xbox 平台比 Xbox 平台多。它支持常见的插件阵列，并有一个 LiveCD 版本。

##### 视频磁盘记录器项目

在 [`http://www.tvdr.de`](http://www.tvdr.de/) 的项目是为大多数动手开发者准备的，因为它还包括一个建议的硬件组件。这个硬件是这个项目的主要吸引力，因为它基于 DVB-S 卫星接收器(它的主要关注点，因为模拟和数字电视是由插件提供的)和使用 PIC 芯片的定制遥控器。尽管在当今世界，这种级别的定制硬件很大程度上是不必要的，但它工作得很好，给了用户一个额外的理由来对他们的 VDR 充满热情。它使用的规格也低于当前大多数系统。软件方面，它有一个像样的(如果稍微有点小)界面，看起来像星际迷航:下一代 LCARS 系统和比大多数 PVR 更广泛的插件，包括游戏，电子邮件和网页浏览。

## 远程控制和 UPnP

在很大程度上，媒体流及其类似物是非常本地化的服务。您可以通过网络传输数据，但是控制器和显示器的物理位置很近。即使你有一个应用程序来控制设备(如 WDRemote 应用程序，或许多 VLC 变种之一)，它也只是取代了你通常使用的红外遥控器。你还在把流光和它的遥控器绑在一起。进化的下一步是正式分离这些单元，并建立允许它们通信的开放协议，以及可以随意替换的单个组件。正如你可能猜到的，从标题到这一节，这是可用的 UPnP。

### UPnP 简史

通用即插即用(UPnP)于 2008 年 12 月随着覆盖网络设备的 ISO/IEC 29341 标准的发布而正式开始。主导原则是，支持 UpnP 的设备可以在没有任何人工干预的情况下进行连接——更重要的是，进行配置。通过消除对设备驱动程序的需求，将逻辑转移到协议中，然后将这些协议视为阶段，每个阶段都有围绕每个阶段的限制的规则，这才成为可能。基本堆栈分为六个区域。

#### 网络寻址

正如在第 1 章的[寻址部分所述，网络最好使用由 DHCP 分配的动态 IP 地址。所有的 UPnP 设备都使用 DHCP 来确定其本地地址，因此准备这样一个网络的(短)时间投资被认为是非常值得的。在这种服务不可用的情况下，UPnP 应该退回到链接本地地址，这可能不在您的预期范围内。(它将始终位于一个私有的内部网地址上，但可以与您设置的其他地址不同，因为 169.254/16 范围是首选，这意味着设备将不可见。)](http://dx.doi.org/978-1-4302-5888-9_1)

有了路由器提供的开箱即用功能，即使是偶尔涉猎 HA 的人也可以确保轻松的 UPnP 体验。自然，当 UPnP 设备是软件设备时，IP 由主机提供。

#### 发现

与其他服务(如蓝牙)能够发现其网络上的兼容设备一样，它通过简单服务发现协议(SSDP)工作，其行为类似于 DHCP 或 DNS。因此，端口 1900 充满了寻找这些设备的流量。您不太可能想要(或需要)本地 intranet 之外的发现服务，因此没有必要向外界开放这个端口。此外，由于这是一个多播请求，您将无法通过 wifi 使用它，因为默认情况下，大多数 wifi 路由器禁用多播。

#### 描述

这是一个 XML 文件，通过 HTTP 返回，描述整个设备。它不控制设备本身，但它解释了如何这样做。该文件的一个示例如下:

`<?xml version="1.0" encoding="utf-8"?>`

`<root >`

`<specVersion>`

`<major>1</major>`

`<minor>0</minor>`

`</specVersion>`

`<device>`

`<deviceType>urn:schemas-upnp-org:device:BinaryLight:1</deviceType>`

`<friendlyName>Kitchen Lights</friendlyName>`

`<manufacturer>OpenedHand</manufacturer>`

`<modelName>Virtual Light</modelName>`

`<UDN>uuid:cc93d8e6-6b8b-4f60-87ca-228c36b5b0e8</UDN>`

`<serviceList>`

`<service>`

`<serviceType>urn:schemas-upnp-org:service:SwitchPower:1</serviceType>`

`<serviceId>urn:upnp-org:serviceId:SwitchPower:1</serviceId>`

`<SCPDURL>/SwitchPower1.xml</SCPDURL>`

`<controlURL>/SwitchPower/Control</controlURL>`

`<eventSubURL>/SwitchPower/Event</eventSubURL>`

`</service>`

`</serviceList>`

`</device>`

`</root>`

(来自 [`http://developer.gnome.org/gupnp/unstable/server-tutorial.html`](http://developer.gnome.org/gupnp/unstable/server-tutorial.html) )

#### 控制

描述了该设备将响应的控制之后，远程控制应用程序就有可能向该设备发送消息。这些都用简单对象访问协议(SOAP)包装，这意味着您将看到大量的 XML！

#### 事件通知

控制层用于接收传入的消息，只有 even notify 层能够发送它们才有意义。当设备上的状态改变时，就会发生这种情况。这些事件的细节因设备而异，因此当“控制点”第一次订阅设备时，会发回一个列表(同样是 XML 格式的)，其中详细列出了控制点可以监听的事件。然后，它请求订阅这些事件，从而启动设备和控制器之间的推送机制。

#### 陈述

最终，有一个层，其中两个设备同意在特定 URL 的媒体想要被播放，并且它应该在特定设备上被播放。在规范中没有给出表示层应该支持哪些媒体格式，因此哪些文件是兼容的。这是“有意为之”，这是数字生活网络联盟已经解决的问题。(有关这方面的更多信息，请参阅本书后面的内容。)

因为表示层与控件和服务器是分离的，所以该架构为我们提供了一个非常巧妙的内置优势！也就是说，很容易将一个信号流式传输到两个不同的表示组件。从表面上看，这提供了一个基本的“全屋音频”系统，或者说是一种在客厅观看同一节目并在厨房继续观看的手段。的确，这是可能的。但是由于演示组件在功能上不需要匹配，这意味着您可以在休息室拥有一台支持 UPnP 的电视，但在厨房只有一组合适的扬声器。通过这种方式，你可以继续听节目，而不会被画面分散注意力——如果你在厨房工作，这可能是有益的。

#### 证明

这是我们六层堆栈中的第七层。即...没有认证！尽管这说明了我们不开放端口和使用本地网络地址的决定，但它确实引入了一个问题。在这种情况下，这不是一个技术问题，而是一个管理问题。如果本地网络上的任何人都可以访问您的媒体，您能信任网络上的人吗？在大多数情况下，这些是你的家庭成员，他们(应该)遵守必要的社会规范和强制措施，以阻止他们滥用这种权利。但是，您只有一个大的粒度控制机制，也就是说，如果这个机制失败，就完全删除他们的网络访问。

有对 UPnP 的扩展(例如设备安全服务和 UPnP-UP(用户配置文件))和协议仍然没有得到广泛支持。

但是，如果您需要身份验证，并且您不能确定您的小孩是否会对您的证书 15/18/X 级电影感兴趣，那么您可能需要借助 Samba，在您的媒体分发中使用密码保护区。与 UPnP 相比，它没有得到很好的支持，也没有那么灵活，但它会让人安心。

### UPnP 的高级分离

鉴于内部协议基于堆栈的安排，最终用户也了解这一概念也就不足为奇了，因为系统各部分的功能是分离的。这种分离非常自然，包括:

*   服务器—向网络上的其他设备提供媒体
*   控制器—在任何给定设备上启动/停止媒体
*   渲染器—显示媒体，可以是视频、图片或音频流

这种分离意味着您可以在任何给定的设备上实现任何(或所有)功能层。如果他们生活在一个单一的设备，你有一个标准的媒体播放器。当服务器分离时，典型的媒体流设置是 NAS 扮演服务器的角色，而流媒体工具是控制器和呈现器的组合。当它们都独立时，您可以从任何地方使用任何媒体控制任何设备。这进一步扩展，以便您可以在一个设备(或渲染器)上开始观看节目，使用控制器，并向不同的渲染器发送命令以继续观看。

这也意味着你需要安装三个软件。

#### 计算机网络服务器

这里有几个选项，选择哪一个取决于运行它的机器的大小。

##### 迷你 DNA

对于微型需求，如树莓派，我们有恰当命名的 minidlna。这是一个微型的尺寸和外观，但是它提供了标准的音频、视频、字幕和图片功能。最大的缺点是缺乏代码转换，但是对于基于 Linux 的 HA 解决方案，媒体呈现器能够处理几乎任何格式，这是对 CPU 周期的不必要消耗。

它可以从 [`http://sourceforge.net/projects/minidlna/`](http://sourceforge.net/projects/minidlna/) 下载，或者，对于那些使用 ArchLinux 的用户，在 [`https://www.archlinux.org/packages/?name=minidlna`](https://www.archlinux.org/packages/?name=minidlna) `.`作为一个包检索。大多数其他发行版还没有包含它，所以你通常需要编译它。您将始终需要包含它所依赖的 AV 库的开发版本:

*   libavcodec 公司
*   libavformat
*   滑鹌
*   利贝西夫

此外，根据版本的不同，您可能需要修改 metadata.c 来处理 AV 头文件中的更改。具体来说，转到第 715 行附近，显式添加:

`#define AV_DICT_IGNORE_SUFFIX 2`

因此它在函数定义之前:

`#define AV_DICT_IGNORE_SUFFIX 2`

`sqlite_int64`

`GetVideoMetadata(const char * path, char * name)`

`{`

配置服务器需要您编辑基本配置文件，以指示端口、媒体文件的适当位置以及日志文件。该文件为 minidlna.conf，应修改为:

`# port for HTTP (descriptions, SOAP, media transfer) traffic`

`port=8200`

`# set this to the directory you want scanned.`

`media_dir=A,/net/media/mp3`

`media_dir=/net/media/movies`

`# set this if you would like to specify the directory where you want MiniDLNA to store its log file`

`log_dir=/var/log`

多行 media_dir 是完全可以接受的,“A”标志确保只包含音频文件。这很方便，因为一些较新的专辑包括数字曲目和音乐视频以及它们的音频对应物。

在这里，您可以使用以下用户帐户将服务器作为守护程序启动:

`minidlna -f minidlna.conf`

此时，它将扫描所有文件的指定媒体目录，尽管服务器将在扫描完成前开始。因此，随着扫描过程的继续，一些媒体播放器将需要刷新(或者，在最坏的情况下，重新启动)来拾取文件。它还将在内核中安装一个 inode 通知程序，以自动在媒体目录中查找新文件，尽管为引入新媒体而对配置文件进行的任何更改都需要您重新启动守护程序。有一个命令可以强制进行这样的刷新:

`minidlna -R`

尽管这种选择的成功程度变化很大。

如果您打算在`/etc/init.d`中的启动脚本中包含 minidlna(或任何其他 UPnP 服务器),那么在序列的末尾包含它，以确保 RAID 等文件系统服务完全启动。

默认情况下，媒体文件的缓存存储在`/tmp`中。如果您希望这种情况更持久，例如，在重新引导之间，则在配置文件中添加一行以实现这种效果:

`db_dir=/var/cache/minidlna`

虽然没有 web 管理工具，但您可以通过将 web 浏览器指向端口 8200 或安装 webmin 来检索基本统计信息。然而，在现实中，几乎不需要管理，因为它旨在通过像 VLC 这样的控制者来实现无头运行。

##### 格里利

作为一个媒体服务器，Rygel ( [`https://live.gnome.org/Rygel`](https://live.gnome.org/Rygel) )在 minidlna 概念功能的基础上加入了它的主要遗漏——代码转换。自然，这需要一台比 minidlna 性能更高的机器，但该软件仍然保留了其在无头机器上使用的重点。

与 minidlna 一样，Rygel 可以由本地用户运行，并通过指定媒体的 URL 进行配置:

`# In ∼/.config/rygel.conf`

`uris=/net/media/movies,/net/media/mp3`

然而，与 minidlna 不同，Rygel 似乎要等到扫描完整个目录后才开始。所以在执行之后:

`rygel`

有的是时间去喝杯咖啡！

##### XBMC(外部网路)

自然，像 XBMC 这样的巨型媒体系统既可以作为服务器，也可以作为呈现器。如果您有一个主媒体盒，而其他媒体盒被视为不能同时访问的从属(或从属)单元，这是一个理想的解决方案。当 XBMC 服务器为其他渲染器提供数据时，它可能没有足够的处理能力来支持自己的本地渲染器以及其他请求，因此使用单独的从服务器是一个可行的解决方案。

向其他设备共享 XBMC 内容非常简单，只需要在“通过 UPnP 共享视频和音乐库”标题下启用它根据 XBMC 的版本，这是在设置➤网络➤服务(版本 11，又名伊甸园)，或设置➤服务➤ UPnP(版本 12，又名弗罗多)。然后，您可以像往常一样从控制器中发现媒体。

Note

XBMC 是一个非免费的包，所以一些发行版(比如 Debian)的用户需要添加额外的库来通过他们的标准包管理器使用它。

在 Raspberry Pi 上，XMBC 可以通过使用自定义安装(目前有三个)或将其添加为 Raspbian 发行版的标准包( [`www.raspbian.org/RaspbianXBMC`](http://www.raspbian.org/RaspbianXBMC) )来安装。

安装程序可在:找到，更多信息见第 9 章[。尽管 XBMC 和 Raspberry Pi 的这种组合在与任何连接到 USB 的设备(例如，外部驱动器，尤其是 DVD)配合时并不是最完美的匹配，但在这一领域已经做了很多工作，因此人们期待着改进！](http://dx.doi.org/978-1-4302-5888-9_9)

*   [T2`http://wiki.openelec.tv/index.php?title=Installing_OpenELEC_on_Raspberry_Pi`](http://wiki.openelec.tv/index.php?title=Installing_OpenELEC_on_Raspberry_Pi)
*   [T2`www.raspbmc.com/wiki/user/os-x-linux-installation/`](http://www.raspbmc.com/wiki/user/os-x-linux-installation/)
*   [T2`http://xbian.org/download/`](http://xbian.org/download/)

with more information given in

#### 渲染器

几乎所有的传统媒体播放器都可以被认为是渲染。虽然最初它们仅限于从本地驱动器重放媒体，但这慢慢扩展到通过网络(通过 Samba)处理文件，现在扩展到 UPnP。由于篇幅有限，我有机会简要介绍其中的几个。

##### 可见光通讯

作为媒体播放的坚定支持者，VLC 几乎拥抱了每一项新技术。UPnP 也不例外，在验证新配置的 UPnP 服务器时，它是最容易使用的。

首先，打开工具➤首选项菜单。从这里，选择“全部”以获得配置选项的完整树形视图。然后，您可以打开播放列表分支，并勾选“服务和发现”部分中的“通用播放”选项。您现在已经在 VLC 上启用了 UPnP。

要播放 UPnP 内容，您需要选择本地网络分支，然后它会显示包含 UPnP 的网络上的各种可用服务。过一会儿，就会收到发现消息，您可以像平常一样浏览树。

##### 图腾

Totem 是许多 Linux 发行版的默认媒体，由于 Coherence 插件和控制器的缘故，它在大多数发行版上提供没有配置的 UPnP。要确保可以找到 UPnP 服务器，只需使用“编辑➤Plugins”菜单项，并确保 Coherence DLNA/UPnP 客户端已启用。然后可以从包含“播放列表”的同一个下拉列表中使用它

Note

Coherence 也可以作为一个独立的应用程序，能够充当媒体服务器。

##### XBMC(外部网路)

当作为一个媒体渲染器时，XBMC 按照最初的设想，播放音乐和视频。XBMC 不需要特定的配置，所以你可以直接进入视频➤文件➤添加视频并浏览到相关的 UPnP 服务器。

##### 真实硬件

由于 UpnP 支持 DLNA(见本书后面)，并且 DLNA 得到许多现实生活中的制造商的支持，找到支持 UPnP 的硬件相对容易。这包括索尼、三星和其他公司的电视、Playstation 3、Xbox 360 以及各种智能手机。

此外，大多数配备 Windows 7 或 Windows 8 的电脑将自动运行 UPnP 服务器，提供对用户媒体和一般机器媒体的访问。

#### 控制点

非正式地称为控制器，控制点浏览服务器上的数据，并命令渲染器显示数据。与 UPnP 控制器采用的“一刀切”的方法不同，通过控制点访问媒体具有自动解析元数据的优势，因此您可以按流派、专辑、艺术家或播放列表自动浏览您的收藏。

控制点分为两大类:

*   与现有玩家或控制器通信的那些
*   需要中间服务器的应用程序

在第一个类别中，你有一系列 iOS 和 Android 控制应用程序，如 XBMC 命令、VLC 远程等等。这些有时需要您在服务器上打开特定的 HTTP 端口。

其他的，比如 jfcontrol ( [`www.digitalsirup.com/jfcontrol/index.html`](http://www.digitalsirup.com/jfcontrol/index.html) )和 Minerva 应用，都需要一个连接 wifi 的机器上的中介服务器。然后，控制点连接到服务器，服务器在传递消息之前对消息进行适当的格式化。虽然严格来说不是 UPnP 控制点，但它们经常被用来控制它们，因此在这里值得一提。

对于命令行爱好者来说，可以通过以下请求来控制 XBMC:

`curl -i -X POST -H "Content-Type: application/json" -d '{"jsonrpc": "2.0", "method": "Player.GetActivePlayers", "id": 1}'` `http://xbmc:www@192.168.0.21:8080/jsonrpc`

这将返回正在播放的媒体流(音频、视频、图片)列表。URL 照常分解为[用户名]:www @[IP 地址]:[端口]。更多命令可在 [`http://wiki.xbmc.org`](http://wiki.xbmc.org/) 找到，强烈推荐，因为 XBMC 的 v11 和 v12 之间的结构已经改变。

#### 开发新的 UPnP 应用

由于 UPnP 是一个影响如此深远的标准，人们很想转换现有的应用程序来利用它的功能，并将其扩展到当前可用的许多设备中。编写这种应用程序的范围超出了本书的范围，所以我将把您引向一些使任务变得更容易的资源。

GUPnP 是一个构建 UPnP 应用程序的框架。它的意图很简单，只提供框架元素，排除任何 DLNA 细节，并要求您实现任何类似高级媒体服务器的功能( [`http://gitorious.org/gupnp/pages/Home`](http://gitorious.org/gupnp/pages/Home) )。

dLeyna 是一个相对较新的项目，旨在为 UPnP 应用提供伞式服务，在 [`https://01.org/dleyna`](https://01.org/dleyna) 中有详细介绍。

如果你有兴趣从头开始编写自己的 UPnP 设备，而不使用中间件或助手库，那么前往 [`http://upnp.org`](http://upnp.org/) 并从 [`http://upnp.org/specs/arch/UPnP-arch-DeviceArchitecture-v1.1.pdf`](http://upnp.org/specs/arch/UPnP-arch-DeviceArchitecture-v1.1.pdf) 访问基本规范。

在 [`www.upnp-hacks.org/upnp.html`](http://www.upnp-hacks.org/upnp.html) 也可以找到好的信息。

#### UPnP—封闭版本

自然，对于任何好的技术，一个(或多个)公司都会在其上构建自己的专有版本。两个著名的是 DLNA(数字生活网络联盟)和 AirPlay。

##### dlna！dlna！dlna

作为索尼 2003 年的一项倡议，它已经被纳入一个非盈利的贸易组织，现在有 200 多家不同的成员公司，每个公司都加入了自己的观点。因此，有超过 9000 种不同的设备符合 DLNA，使其成为可用的最普遍的媒体分发技术之一，特别是在计算对资深技术极客和 SWMBO 都有吸引力的硬件设备数量时。

尽管 DLNA 和 UPnP 的协议非常接近，但当涉及到内容呈现时，它们的规范是分开的，因为 DLNA 对可以分发的媒体进行了限制。这些限制以文件格式、编码和屏幕分辨率的形式出现。尽管这确保了任何 DLNA 将“正常工作”,并真正实现 UpnP 的“零配置”梦想，但是，因为 DLNA 是许多年前开始的，并且电影编解码器(相对而言)经常改变和升级，这意味着 DLNA 不支持今天广泛使用的许多格式(如 MKV)。要解决这个问题，您可以在服务器或渲染器上解决问题。在服务器端，您可以在流式传输之前将电影转码为可接受的 DLNA 格式。尽管这很昂贵，但在大多数相当强大的桌面系统上实时完成是可能的。(但是，如果涉及多个流和/或一个 Raspberry Pi，您还不如将文件复制到 USB 记忆棒，然后带着它走到您的设备上！)从呈现器方面来说，许多现成的媒体流将支持规范中没有包括的格式，以消除兼容性和代码转换的问题。

根据你的观点，DLNA 要么是“UPnP 做错了”，要么是“UPnP 做对了”我将把争论留给你去决定！

DLNA 遵循 UPnP 的理念，将不同的媒体功能分成不同的类型。就 DLNA 而言，它们是:

*   数字媒体服务器。DMS 的作用类似于 NAS，它存储内容并使网络上的其他设备可以使用这些内容。
*   数字媒体播放器。DMP 从 DMS 中提取内容，以便回放和显示。
*   数字媒体控制器。DMC 列举 DMS 上的内容，并向媒体呈现器发送“播放”请求。
*   数字媒体呈现器。DMR 按照控制器(DMC)的指示，接受由 DMS 推送给它的内容。
*   数字媒体打印机。DMPr 在 DLNA 相当于一台自我标榜的网络打印机。它可以被认为是一个“只写”DMR，工作到 DMC 或 DMP 的控制。

与 UPnP 一样，一些设备将两个或多个功能组合在同一个物理盒中。

大多数基于软件的 UPnP 设备也是 DLNA 兼容的，但还没有支付许可费来获得正式许可。

##### 空中播放

最初在 2004 年被称为 AirTunes，这是苹果公司开发的 UPnP 和 DLNA 的等价物，允许所有兼容设备之间的媒体流。然而，作为苹果公司，只有当你拥有苹果设备和软件或者进入市场的少数第三方授权产品之一时，这样的流媒体才有可能。因此，它在开源世界中很少被采用，甚至像 ShairPort 这样试图模仿机场快线的项目也失败了。

在基于 Linux 的家庭中使用 AirPlay 的唯一好处是为孩子们提供了一个访问媒体的封闭网络。你可以为主卧室和客厅提供一个开放的 UPnP 环境(观看习惯可以受到社会监督)，为孩子们提供一个 AirPlay 环境。

## 分配

这是我们数据链的第三步。一旦我们提供并解码了媒体数据，我们就剩下一个 AV 信号，可以随时插入电视或高保真音响。但是我们还有选择。

### 本地处理与远程处理

前面提到的设备都是本地加工的。也就是说，我们在与电视或 HiFi 物理连接的位置解码数据。这种情况很常见，因为它为我们提供了更高的保真度，并意味着控制该单元更容易，但在某些情况下，远程处理更好，只发送合成的 AV 信号。

### AV 发行

几乎所有媒体播放设备的输出都是我们的第一站。这通常包括用于立体声音频或复合视频、S-Video、EIA 接口、SCART 等的 RCA 唱机插座。这可以将低功耗的模拟信号短距离传输到放大器，无论是电视还是高保真音响。因为这些信号总是需要一个功率放大器，我们称之为主动分配。

以这种方式提供分布需要各种互连和许多电缆。这些电缆的长度没有上限，因此扩展和配电箱是可能的，允许在多个地方观看同一图像。自然地，作为一个模拟信号，音频(或图像)会随着远离信号源而变得更柔和。只有你能决定什么样的质量损失是你可以接受的。

如果你想在你的房子周围分发高清图像，那么你目前必须考虑更昂贵的选择，如矩阵切换器，因为目前的作物主要集中在 RCA 插座上。

#### 转换

最便宜的必要设备是一个 AV 开关盒，或 AV 源选择盒。这为您的各种设备(DVD、PVR、VCR 等)提供了多个输入，并将其中一个路由到电视输出。大多数设备让你选择使用 S-Video、RCA 或 SCART 输入。这自然要求电视始终设置为接收来自机顶盒的输入，而不是其内部调谐器。有许多开关盒可用，因此需要考虑的特性包括:

*   红外遥控:这是必需品，真的。因为这个盒子代替了你的电视频道转换器，它必须具有你所期望的电视功能...它至少是一个遥控器。
*   有源或无源设备:有源设备中有一个小放大器，因此需要电源。这些确保了强信号，但代价是廉价机型的质量较低，因为它们的内部放大器不如 DVD 播放器或电视上的放大器好。无源设备没有这种放大功能，更有可能缺少红外遥控器。
*   输入连接:虽然有些盒子为每个输入提供 S-Video、RCA 和 SCART，但它们可能不会互连。也就是说，RCA 输入插座可能只连接到 RCA 输出插座，而不连接到 S-Video 或 SCART。因为您只有一个输出到电视，所以这需要您进行补偿，以使您的互连适应最常见的外形，并将所有其他输入转换为相同类型的插头(大多数电子商店都有转换器)。然后使用等效的输出。规范的这一部分通常没有很好的记录，所以先检查商店的退货政策。
*   输入的数量:数一数你拥有的设备，加上你想购买的设备的数量，再加两个更好的衡量！一旦超过这个限制，你就别无选择，只能买一个更大的开关盒。您可以将它们链接起来，这很麻烦，会降低质量，或者您可以在电视上为每个开关盒使用单独的 EXT 输入，这同样很烦人，但信号链中的电子元件较少。

入门级开关盒上最大的遗漏是在立体声音频和 5.1 环绕声之间切换的功能。因此，您需要一套单独的电缆，将 DVD 的 5.1 输出(控制 5.1 扬声器)和 DVD 的立体声输出连接到您的开关盒。

#### 拆分和合并

一旦您准备好 AV 信号，您可能需要将其分离，以便信号的视频部分进入电视，而音频进入 HiFi 的线路输入。有两种主要方法可以实现这一点。第一种是简单的方法，如果您的电视有自己的立体声输出插座，就可以使用，因为它们可以从电视直接连接到 HiFi，没有任何问题。另一种方法是将开关盒输出的信号分成两路(或更多路)输出，一路用于电视，一路用于高保真音响。这种方法意味着您将无法使用 HiFi 来放大使用电视内置调谐器选择的任何电台，但这可以通过仅通过接收器(如有线调谐器或 digibox)或 VCR 观看电视来纠正，该接收器已插入开关盒。这可以通过多种方式实现。最便宜的是使用两根 Y 形电缆(也称为 Y 形适配器)，左右音频信号各一根。这些从一个输入提供两个相同的输出，不需要电源。这些在分离音频信号时工作良好，但在用于视频信号时由于阻抗问题可能不太令人满意。如果质量不够好，那么你需要一个更复杂的分线盒。

分线盒的作用类似于 Y 形电缆，但通常有一个放大器来阻止信号衰减。这也使它能够以很少的额外成本提供更多的输出，允许您将一对单独的电缆接入厨房和餐厅。

如果这两种方法都不适用，您可以通过布设多条扬声器电缆，在放大级之后分离输出。

### 布线织机

布线织机携带强大的信号(双关语！)通过电缆来驱动你房子周围的各种无源扬声器。因此，我们称之为被动分配。您应该为房子中可能听到相同音频内容的每个区域创建一个织布机，因为这里的本地控制更困难(除非您有带音量控制的扬声器或想要自己黑一个)。在如图 [3-1](#Fig1) 所示的房间布局中，你在客厅和餐厅之间几乎没有隐私，所以它们会和厨房在同一个织布机上，因为你可能想在不错过音乐或电视输出的情况下进出。相比之下，如果像阳光房或书房这样的扩展被添加到房子的后部，它会被认为是一个具有不同生活方式目的的独立区域，不会在同一个织机上。相反，任何音乐都应该通过 IP 提供。

![A978-1-4302-5888-9_3_Fig1_HTML.jpg](img/A978-1-4302-5888-9_3_Fig1_HTML.jpg)

图 3-1。

A standard downstairs plan

布线机中的第一个组件是主功率放大器，它的输入来自我们之前讨论过的配电盘。通常，这将驱动一组扬声器，尽管一些放大器为其他组提供额外的输出。在同一台织布机上很少有两个以上的房间，甚至更少有两个以上的房间，所以你通常不需要更多的设备。

在需要更多输出的情况下，您可以在链中添加扬声器控制盒。这需要一个单一的扬声器输出，并分成许多。这些额外的扬声器电缆可以延伸到其他房间，并直接连接到其他扬声器，无需电源。这是这种方法的主要优点；也就是说，电缆更容易铺设(孔更小，因为末端没有笨重的插头)，附近也不需要电源插座，使你能够在媒体播放器不实用或不可能的浴室中添加音乐。

Note

浴室使用的特殊防水扬声器是必要的，它们有密封的锥体和篮子，因此可以应对水和湿度。有各种型号，包括可以安装在天花板上的嵌入式。

如果您使用质量合理的扬声器电缆，信号将不会在所涉及的距离上消散。

Note

如果您的放大器有两个输出，但想要控制三组扬声器，那么将控制盒连接到第二个输出，将主扬声器(您更有可能在第一个输出上进行挑剔聆听)连接到第二个输出。如果你不需要这样做，那么在链条中增加一个步骤是没有意义的。

### 无线 AV 分发

铺设电缆并不困难，但应小心操作，避免钻穿电力电缆、水管和煤气管。考虑到这一点，现在有一些硬件可用，比如你在第一章中看到的 AV 视频发送器，用于无线分发音频信号。

在很大程度上，它们提供了一个方便的解决方案，但景观扬声器，这是建立在外面，看起来像岩石(例如)，提供了唯一实用的解决方案。它们也必须由电池供电。

### 矩阵开关

对于大多数家庭应用，一个标准的开关盒足以控制您的 AV 设置。如果您有蓝光播放器或其他高清设备，您通常会使用 HDMI 将其直接插入电视，因为这消除了信号链中的所有其他组件。唉，我见过的价格合理的开关盒都不支持 HDMI。 [<sup>9</sup>](#Fn9)

此外，如果你想把你的两个输入设备(如 PVR 或 DVD)分配到两个不同的地方，那么你会发现你不能，因为交换机只提供单一输出。

这两种限制都可以用矩阵开关来克服。它们具有更宽的输入范围(通常包括 VGA ),可以将输入信号从(比如)八个输入中的任何一个发送到任何(或所有)输出，输出通常为四个或更多。这使得最强大的 AV 控制方法成为可能，所有的硬件都位于一个地方，结果通过电缆传送到房子的每个房间。还有，因为这是专业级的设备，一般都自带串口，便于电脑直接控制。

在您的设置中使用矩阵切换器是一个巨大的进步，不仅仅是经济上的。为了充分利用设备，您需要将您的 AV 设备放在切换器附近。此外，你不仅会有通常的混乱的电缆进入切换器，而且你还会有额外的混乱的电缆离开它——每个房间一套。而且，在大多数情况下，矩阵开关并不小。因此，把它们放在客厅是不切实际的。相反，你需要考虑一个房间或一个隐藏的橱柜，可以放置切换器和 AV 设备。现在设备被隐藏起来，购买一个红外继电器或网关来转发红外信号到机柜内的设备是必不可少的。这将是矩阵切换器所需要的，并可能成为软件包的一部分，所以第二次购买！

矩阵开关的输出连接器各不相同。有些以 AV 信号的形式提供输出，如 S-Video 或其他家用格式，使将其他接收器连接到您的家庭并使其工作变得非常简单。另一些则是为酒店和会议中心设计的，将每个输入编码成专有协议，以便输出可以通过以太网传输。在这种情况下，每个房间都需要一个额外的接收器单元，从而节省了在您的房子周围铺设特定 AV 电缆的工作量。由于数据通过现有的 Cat5 电缆传输，您通常可以用同样的方式发送红外线控制数据，从而节省了经常需要的红外线继电器。

Note

如果您的大部分源媒体存储在硬盘上，那么您可能根本不需要矩阵切换器，因为它可以通过 Cat5 传输到使用软件流解决方案(如 VLC)的小型 Linux 主机。

对于那些生活在地下火山的邪恶天才来说，矩阵切换器提供了一个任务控制室的场景，只需要很少的额外费用！毕竟，你可以将一组输出连接到一排小型廉价的电视机上，同时观看多个信号源。

## 控制

拥有在每个房间播放音乐的能力是一回事。能够控制每个房间的音乐是另一回事。这是链条中的下一步，但并不总是必要的。再看图 [3-1](#Fig1) 中的房屋布局。这不需要复杂的控制系统，因为客厅是本地控制的，厨房音频流通常在你开始准备晚餐时打开，在你吃完后关闭。因此，被迫从客厅控制 AV 不成问题。

用扬声器控制盒将几个房间(例如，主卧室、浴室和书房)连接在一起并让它们一直开着也不是什么难事。在这种情况下，很可能尽管三个房间中的两个在一天的大部分时间里可能是空闲的，但是当其中一个房间被使用时，其他房间被排除在外，使得没有必要花费成本或精力来为每个房间提供单独的控制。

### 本地控制

能够从设备本身控制设备(如扬声器或立体声放大器)是最合理的解决方案，幸运的是，大多数主机都自动提供了这一功能。例如，一个本地放大器或一组有源扬声器的前面有一个音量控制和一个改变源输入的装置。因此，任何使用 AV 或 Cat5 电缆的配电系统都将内置控制。

为了影响无源扬声器(可能是从远程扬声器控制盒馈电的扬声器)的音量，您需要一个与扬声器串联的衰减器。对于低功率解决方案，可以将双对数电位计直接安装到扬声器支架上。(您需要对数，因为这是音量的工作方式，并且您需要双对数来控制立体声音量。)这不会给你特别好的保真度，因为设备内部的两个轨道不会很好地相互匹配，并且产生的一些频率会丢失，但它会很便宜。一个更好的解决方案是，在一个基本的墙壁单元中提供定制的衰减器，并提供一个更好看的质量更好的控制机制。如果您的扬声器不是壁挂式的，那么您将不得不在墙壁空腔内或外部轨道中布设一套额外的电缆。因此，电缆从扬声器控制箱连接到开关，然后连接到扬声器。最好在铺设其他电缆之前考虑这种方法。除了浴室(这种衰减器需要防水)，这种控制方法通常是不切实际的，最好使用主动式头部装置或根本没有任何形式的局部控制。

### 遥控方法

你的房子会随着音乐的声音而活跃起来。除非你生活在每个房间都有音乐的环境中，否则你无法想象这有什么不同。能够改变音量很好，但不是必须的，因为每张专辑都被标准化为内部一致。然而，如果你随机播放音轨，音量会有很大的变化，这就需要本地音量控制。如果你要引入这样的功能，你通常会想要更多的本地控制来跳过那些你不想听的随机音轨。这样的功能需要更多的硬件。

#### 直接控制

标准 HiFi 设备总是配有红外遥控器，因此可以在每个房间放置一个红外中继接收器，并将其发射器与设备上的接收器眼对齐。小型接收器可以安装在墙内，与电灯开关并排，或者代替电灯开关，由电池供电。富有冒险精神的开发人员可以利用廉价的一体化遥控器，将其工作原理与红外继电器和替换开关一起集成到他们自己的墙壁单元中。

#### 继电器控制

虽然很少有消费类产品不附带 IR，但这并不意味着你必须用 IR 来控制它，只要在两者之间有某种东西理解这两种协议。

例如，蓝牙在所有当前的移动电话上都可以找到，尽管它有点耗电，但有许多免费或几乎免费的应用程序可以与适当配置的 PC 接口。因为许多人总是随身携带手机，这提供了一种非常容易实现的控制方式。

所有蓝牙通信都需要蓝牙地址。这看起来像传统网络场景中的 MAC 地址，可以通过以下方式发现:

`hcitool scan`

请注意，在扫描该区域的设备时会有轻微的延迟，当它消失时，会有进一步的延迟！因此，虽然这个程序可以用来确定蓝牙信号何时回到范围内(因此当你回家时)，但最好使用`bluemon`对单个手机进行定向扫描。

蓝牙控制应用分为两部分，一部分用于 PC，一部分用于移动设备。移动端通常是基于 Java 的，但是，尽管有“写一次就可以在任何地方运行”的口号，由于移动开发的不确定性，通常需要一个特定于你的手机的版本。发送的消息通常采用接收 PC 应用程序可以处理的协议。然后将其配置为向相关设备发送合适的红外信号，该信号可能用于控制当前在 PC 上运行的媒体播放器，或者在蓝牙信号超出范围时锁定桌面屏幕。 [<sup>10</sup>](#Fn10) Vectir 为 Windows 用户提供了这样的功能，而 Linux 社区的用户可以选择软件包 [<sup>11</sup>](#Fn11) 如 Remuco、Amarok 或 RemoteJ。还有其他允许在手机和 PC 之间传输文件的包，比如`obexftp`，但是这些包适合同步应用程序，因此不在本书的讨论范围之内。

X10 为中继控制提供了类似的机制。利用手持发射机模块(如 HR10U)，您可以向 RF-to-X10 网关发送 X10 消息(如灯 E10 打开),该网关将数据放在电力线上。然后，您的电脑可以通过重新发送红外信号或影响基于电脑的软件来监听此特定消息并控制媒体播放器。我将在第 7 章中讲述 Cosmic 的具体机制，它支持所有的附加功能。

#### 服务器控件

涵盖的所有中继方法也可用于控制运行软件的服务器，如媒体播放器。事实上，这通常是更可取的，因为它限制了可能出现问题的地方的数量，并且通常在大多数媒体以数字形式存储在硬盘上的情况下使用。

当服务器向外部位置提供介质时，所有设备都应配置为客户端/服务器。这提供了比以前更明显的分离，以前播放的音乐由远程放大器控制，但扬声器音量由本地控制。采用完整的客户机/服务器方法有许多好处，尤其是因为它统一了系统。这里，每条消息(如“暂停音轨”或“提高音量”)都是由客户端使用任何合适的协议(X10 或蓝牙)发送的。然后，服务器监听所有这些消息，并将它们翻译成正确的 Linux 命令。无论其输出连接到哪里，都可以听到这些命令的效果。此外，当全尺寸 PC 可用于服务器处理时，可以使用更复杂的协议。

##### 网络界面

传统的 LAMP (Linux、Apache、MySQL、PHP/Perl)安装提供了一种很好的方法，通过现代最普遍的界面 web 浏览器来控制你的房子。几乎每个设备，包括游戏机、手机和嵌入式触摸屏，都内置了某种网络浏览器。

构建或破解自己的触摸屏也不再是问题。您可以从当前包含触摸屏的笔记本电脑和笔记本电脑系列(如 Eee PC T91)开始，或者对旧笔记本电脑进行改造(如 Acer Aspire 或 Dell Inspiron Mini)。这些套件包括一个触摸屏膜，从外部连接到显示器屏幕和一个 USB 插头，使屏幕像外部鼠标一样工作。

这些机器体积小，功能强大，可以放在任何地方，包括冰箱上，但你可以通过使用一部旧手机(如诺基亚 7710)并自己安装它来进一步减少占地面积。

软件自然是 Linux。一些精简的发行版提供了浏览器作为其唯一的软件，如 Webconverger。这些是可以形成压缩闪存的实时系统，被称为 kiosk 系统。由于零安装和非常短的启动时间，这些非常适合偶尔使用的家庭终端。

##### 短信

SMS 是所有手机都可以使用的短消息系统，是标准基础设施的一部分。智能家居可以通过两种方式利用它。第一种是将移动电话连接到 Linux 机器上，并使用 Gnokii、SMS 服务器工具或一些类似的软件与之接口。这个软件现在支持很多手机，尽管最初它只支持诺基亚手机。Gnokii 为 SMS 消息提供双向通信，允许您的 PC 阅读和解释它们，或者发送提醒或状态更新。

Note

如果可能的话，当大部分通信是向外的时候，使用预付费电话，以免软件错误或黑客造成大量的发送消息和非常大的电话账单。然而，这并不总是入站通信的最佳选择，因为一些运营商(特别是在北美)也对预付费手机上的入站短信收费！

第二种方法是订阅 SMS 服务提供商，比如 mBlox，它会为您提供电话号码、登录凭证和 API 这允许与任何机器进行双向通信，就像它是移动电话一样。你应该向服务提供商咨询是否有可能在出现问题时限制账户上的花费金额。

随着 G3 网络接入成本的下降，SMS 解决方案最近已经失宠，但它仍然为那些将旧手机传给孩子的家庭提供了一种相当廉价的控制手段。

## 结论

尽管家庭自动化系统有许多组件，但您已经看到它们都不是特别复杂或者超出了标准 Linux 机器的范围。只有你的极客欲望需要(不，要求！)更多设备。但即使这样，一个稳定的服务器也是一个基础，尽管随着家庭自动化系统的发展，包含更多的定制硬件变得不太合适。尽管 DVD 播放器和 PVR 的成本正在下降，但在每个房间更换每件套件的体积/费用是很麻烦的。此外，你不能在家里分享媒体，还会不断地问，“谁最后拿到了星球大战的 DVD？”大多数系统的目标是将一台非常强大的计算机藏在某个地方，并在不同的房间里安装许多较小的(低功率、低成本)主机，能够播放所有类型的媒体。包含这台功能强大的计算机的区域被称为节点零，我将在下一篇文章中介绍它。

Footnotes [1](#Fn1_source)

通过手机访问需要付费的高级服务。

  [2](#Fn2_source)

您必须终止挂起的进程并手动标记文件。

  [3](#Fn3_source)

您可能还需要 Win32 编解码器包(`w32codecs`)。

  [4](#Fn4_source)

从技术上来说，以更高的速度播放磁带和唱片是可能的(使用高速配音磁带播放器或将录音机切换到 45 rpm)，并通过软件中的音高变换来补偿。但是不值得为此付出努力或损失质量。

  [5](#Fn5_source)

这同样适用于 Windows XP SP3、Windows 7、Windows 2003 Server 和 Windows 2008 Server。

  [6](#Fn6_source)

如果您是一个热心的系统管理员，可以使用逻辑卷管理(LVM) 2 来动态增加 Linux 系统上分区的大小。

  [7](#Fn7_source)

在此上下文中，服务器一词用于表示一个物理硬件，而服务则是指提供对服务器上的数据或资源的访问的软件元素。令人困惑的是，这些服务最常见的名称是电子邮件服务器、web 服务器等等。

  [8](#Fn8_source)

它甚至创造了自己的术语“tivoization ”,来涵盖任何使用自由软件运行的设备，但阻止你通过硬件欺骗来行使修改和重用它的权利。

  [9](#Fn9_source)

现在市场上出现了一些 HDMI 开关盒，但这些开关盒只包含 HDMI 开关，如在 http: / / www。电视电缆。co . uk/CGI-bin/TV cables/HDMI-matrix-switch-4x 2html 。它们仍然非常昂贵，所以现在现实的选择是要么在本地处理数据，要么只在家里分发标准清晰度的照片。

  [10](#Fn10_source)

这是`bluemon`一揽子计划的预定目标之一。

  [11](#Fn11_source)

这里不可能列出一个完整的清单，但备选方案包括 [`http://tuxmobil.org/bluetooth_cell_apps.html.`](http://tuxmobil.org/bluetooth_cell_apps.html)