# 13.文件共享和打印

By Dennis Matotek

最常见的办公功能之一是共享/打印文档和文件。在这一章中，我们将向您展示如何使用 Linux 来实现这一点。Linux 提供了许多共享信息的方法。它可以使用名为 Samba 的集成工具与 Microsoft Windows 客户端或 macOS 共享信息。它还可以使用一种叫做网络文件系统(NFS)的工具在 Linux(和其他 Unix)主机之间共享文档。

在异构环境中，将文档管理和存储转移到基于云的提供商变得越来越普遍。这些服务非常普遍，与传统的文件共享相比具有几个关键优势，如版本控制、多设备支持、协作功能和一些支持工作流。企业现在希望这种访问文档的便捷性，而 Samba 和 NFS 都不太适合这项工作。

除了基本的文件共享，我们还将向您介绍不同的平台，这些平台对于文档管理来说既便宜又有效。我们将为此给出一个可能的替代方案列表。

最后，我们将向您展示如何在您的 Linux 主机上配置打印和打印服务。我们将演示如何从您的主机打印，以及如何让您的主机充当打印服务器。在 Linux 上打印很容易实现，CentOS 和 Ubuntu 共享一个通用的工具集，使得它很容易实现和管理。

## 与桑巴和 NFS 共享文件

文件共享是在用户之间共享文档的能力。我们将公司文档集中在一个地方，并允许员工以受控和安全的方式访问它们，而不是每个人都将公司文档保存在自己的台式计算机上，并通过电子邮件等方式传递。这样做的好处是巨大的，因为它减少了每个人桌面上一个文档的多个副本的激增，并使限制访问和备份文档变得更加容易。某些应用程序需要文件共享才能被桌面客户端访问，文件共享可用于此目的。

在您的台式机上，您可以安装网络驱动器。当您通过运行登录脚本的域控制器或在需要时手动登录主机时，可以分配文件共享。您还可以在 Linux 桌面上挂载文件共享。Linux 桌面可以很容易地挂载一个 Samba 或 NFS 共享；但是，如果不做一些修改，它们就无法运行 Windows 可执行文件。

Note

使用 Wine 开发的软件( [`www.winehq.org`](http://www.winehq.org) )运行一些 Windows 应用程序可能会取得一些成功。这个开源社区致力于集成一组选定的 Windows 应用程序，以便在 Linux 操作系统(或 macOS)上运行。还有一个由姐妹组织 CodeWeavers 提供的支持版本( [`www.codeweavers.com`](http://www.codeweavers.com) )。

使用 Linux 可以通过多种方式实现文件共享，这取决于您对访问、安全性和您必须支持的客户机的需求。Linux 可以为传统的文件共享提供一个很好的平台，因为它使您能够在客户机主机上安装网络驱动器。这允许访问由中央文件服务器主机共享的公共数据。实现这一点的两个主要工具是用于微软 Windows 桌面的 Samba 和用于 Linux 或 Unix 主机的 NFS(MAC OS 可以使用其中任何一个)。

Samba 可以为文件共享和打印机服务提供用户认证。NFS 本身不提供任何用户身份验证，但是它可以集成到 Kerberos 域中进行身份验证。这种设置很复杂，我们不会在本书中涉及。

接下来，我们让你近距离看看桑巴。

## 桑巴舞

Samba 是用于 Linux 的文件共享和打印服务。它以标准的客户机-服务器模式运行，带有一个接受网络客户机请求的守护进程。它基于通用 Internet 文件系统(CIFS)和服务器消息块(SMB)协议，这些协议处理 Microsoft 产品上文件系统的主机间通信，使 Samba 与 Microsoft Windows 桌面客户端和 Microsoft Windows 域服务兼容。

目前有两个受支持的 Samba 版本，3.x 版和 4.x 版。您想要达到的目标将决定哪一个最适合您。4.x 版是模拟 Active Directory (AD)，而 3.x 版更像 NT 4。3.x 版支持轻量级目录访问协议(LDAP)集成，而 4.x 版中的 LDAP 集成仍处于试验阶段。此外，Samba 4 目前最多支持 Windows Server 2012 R2，但 2012 服务器需要 Windows 2008 服务器首先加入 Samba AD。Windows Server 2012 或 2012 R2 目录架构目前处于试验阶段。请参见 [`https://wiki.samba.org/index.php/Joining_a_Windows_Client_or_Server_to_a_Domain`](https://wiki.samba.org/index.php/Joining_a_Windows_Client_or_Server_to_a_Domain) 了解支持哪些客户端以及如何加入 Windows 客户端和服务器(2008 和 2012)的域。

在本例中，我们将向您展示如何实现 Samba 的 4.x 版本，并在我们的 macOS 主机上安装一个驱动器。我们向您展示了如何使用 Samba 建立一个简单的文件，它将允许您与同事共享文档。您还将学习如何设置 Samba AD 域服务器，以便您的用户可以进行身份验证，以及如何设置部门共享，您也可以将该共享挂载到您的桌面上。

此外，在本例中，需要注意的是我们将创建一个`samba.example.com`域名系统(DNS)子域。这是因为 Samba 将管理这个子域，这将与我们的`example.com`域冲突。我们还只设置了一个域控制器，并让它充当我们的文件服务器。Samba 文档建议这种设置不适合生产使用，而是应该有一两个 Samba 广告和几个挂广告的文件服务器。拥有多个 AD 有利于维护(您可以在一个 AD 上执行维护，同时仍然使用另一个 AD)、可靠性和可用性。

首先你需要安装软件。CentOS 和 Ubuntu 都需要相同的包来启动和运行 Samba。

在 CentOS 上，您发出以下命令:

```sh
$ sudo yum install samba-client samba-common samba winbind

```

但是，CentOS 7 没有提供我们配置 Samba AD 所需的 samba-tool 二进制文件。您可以将 Samba 配置为经典的 NT4 服务器，也可以从 [`https://www.sernet.de/en/samba/samba/`](https://www.sernet.de/en/samba/samba/) 为 CentOS 购买 Samba 软件订阅。我们建议你使用 Samba 和 Ubuntu。

在 Ubuntu 上，发出以下命令:

```sh
$ sudo aptitude install samba-client samba-common samba winbind

```

### 配置 Samba 广告

我们将在我们的 Ubuntu 服务器上安装 Samba。为此，我们需要做几件事。

*   设置主机名
*   更新设备
*   更新 DNS

一旦这些任务完成，我们就可以配置 Samba 了。

首先，我们需要确保主机名设置正确。我们将使用主机名`dc1.samba.example.com`，它在我们的域中是唯一的。要完整了解桑巴命名建议，请阅读 [`https://wiki.samba.org/index.php/Active_Directory_Naming_FAQ`](https://wiki.samba.org/index.php/Active_Directory_Naming_FAQ) 。我们的主机需要符合以下配置:

```sh
$ hostname –s
dc1
$ hostname –d
samba.example.com

```

将`dc1.samba.example.com`添加到您的`/etc/hosts`文件中也是一个好主意。

```sh
127.0.0.1   localhost dc1 dc1.samba.example.com

```

此外，因为我们将让 Samba 管理它自己的 DNS 子域，所以我们需要允许它访问绑定配置。`bind9`服务器必须与 Samba AD 服务器在同一个服务器上，因为它需要访问某些目录。因为我们使用的是 Ubuntu 服务器，所以我们需要对 Apparmor 进行一些修改，以允许`bind9`服务访问 Samba 目录。记住，我们在第 12 章[中谈到过 Apparmor 它是一个安全模块，描述对系统资源(如端口和文件)的安全访问。](12.html)

我们将以下内容添加到我们的`/etc/apparmor.d/local/usr.sbin.named`文件中，记住我们将本地主机更改添加到`/etc/apparmor.d/local`目录中:

```sh
# Samba4 DLZ and Active Directory Zones
/var/lib/samba/lib/** rm,
/var/lib/samba/private/dns.keytab r,
/var/lib/samba/private/named.conf r,
/var/lib/samba/private/dns/** rwk,

```

保存这个文件后，我们需要将它加载到 Apparmor 中，如下所示:

```sh
$ sudo apparmor_parser -r /etc/apparmor.d/usr.sbin.named

```

为了配置我们的`bind9`服务，为我们的 Samba 配置做准备，我们将把以下内容添加到我们的`/etc/bind/named.conf.options`文件的底部:

```sh
include "/var/lib/samba/private/named.conf";

```

我们需要用以下内容重新加载我们的`bind9`配置:

```sh
$ sudo rndc reload

```

现在是时候配置 Samba 了。Samba 提供了一个名为`samba-` `tool`的工具来帮助配置 Samba 服务器。您可能需要删除或复制系统中任何现有的`/etc/samba/smb.conf`文件，因为以下命令将为您创建一个新文件。

在清单 [13-1](#Par40) 中，我们在交互模式中使用了`samba-tool`(`--interactive`)。关于您可以在命令行上提供的选项的完整列表，请参见`samba-tool provision --help`。我们已经提供了`--use-rfc2307`选项，它告诉 Samba 将用户和组信息存储在内部 LDAP 目录中。这对于跨域成员维护一致的用户 id/组 id(uid/GID)很有用，并且有一些相关的好处；`https://wiki.samba.org/index.php/Setting_up_RFC2307_in_AD`见。我们还提供了我们的首选主机名(`--host-name`)，`dc1`。

```sh
$ sudo samba-tool domain provision --use-rfc2307 --host-name=dc1 --interactive
Realm [SAMBA.EXAMPLE.COM]:
 Domain [SAMBA]:
 Server Role (dc, member, standalone) [dc]:
 DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) [SAMBA_INTERNAL]: BIND9_DLZ
Administrator password:
Retype password:
Looking up IPv4 addresses
More than one IPv4 address found. Using 192.168.0.10
Looking up IPv6 addresses
No IPv6 address will be assigned
Setting up secrets.ldb
Setting up the registry
Setting up the privileges database
Setting up idmap db
Setting up SAM db
Setting up sam.ldb partitions and settings
Setting up sam.ldb rootDSE
Pre-loading the Samba 4 and AD schema
Adding DomainDN: DC=samba,DC=example,DC=com
Adding configuration container
Setting up sam.ldb schema
Setting up sam.ldb configuration data
Setting up display specifiers
Modifying display specifiers
Adding users container
Modifying users container
Adding computers container
Modifying computers container
Setting up sam.ldb data
Setting up well known security principals
Setting up sam.ldb users and groups
Setting up self join
Adding DNS accounts
Creating CN=MicrosoftDNS,CN=System,DC=samba,DC=example,DC=com
Creating DomainDnsZones and ForestDnsZones partitions
Populating DomainDnsZones and ForestDnsZones partitions
See /var/lib/samba/private/named.conf for an example configuration include file for BIND
and /var/lib/samba/private/named.txt for further documentation required for secure DNS updates
Setting up sam.ldb rootDSE marking as synchronized
Fixing provision GUIDs
A Kerberos configuration suitable for Samba 4 has been generated at /var/lib/samba/private/krb5.conf
Setting up fake yp server settings
Once the above files are installed, your Samba4 server will be ready to use
Server Role:           active directory domain controller
Hostname:              dc1
NetBIOS Domain:        SAMBA
DNS Domain:            samba.example.com
DOMAIN SID:            S-1-5-21-295742502-4045385941-247307200
Listing 13-1.Configuring Samba with samba-tool

```

在交互模式下，我们在`[]`括号中得到默认值，我们选择了`Realm`、`Domain`和`Server Role`的默认值。`Server Role`设置为`dc`，代表域控制器，意思是我们是 Samba Windows 域的权威，`SAMBA`。

对于 DNS，我们有选项`SAMBA_INTERNAL`、`BIND9_FLATFILE`、`BIND9_DLZ`和`NONE`。我们选择了`BIND9_DLZ`，这将告诉 Samba 通过我们之前包含在`named.conf.options`文件中的特殊 Samba 模块来动态管理我们的 DNS 子域。Samba 将在设置过程中创建所有必需的 DNS 记录。如果您想让 Samba 拥有并管理您的 DNS 设置，那么`SAMBA_INTERNAL`也是合适的。`BIND9_FLATFILE`不是推荐选项，如果想完全管理自己的 DNS，应该选择`NONE`。

您将被要求提供管理员密码。密码需要八个或更多字符，并且需要符号、字母和数字。一旦输入，Samba 的设置就很快完成了。一旦完成，我们可以开始我们的服务。

```sh
$ sudo systemctl start samba-ad-dc

```

这将启动 Samba 服务，您可以使用`systemctl status samba-ad-dc`命令来检查它是否已经正常启动。另外，记得在开机时用`systemctl enable samba-ad-dc`启用它。

### 测试 Samba

现在，我们可以测试我们是否可以针对服务进行身份验证。为此，我们使用`smbclient`命令，这是用于与 Samba 服务交互的工具。

```sh
$ smbclient –L dc1 -U Administrator
Enter Administrator's password:
Domain=[EXAMPLE] OS=[Windows 6.1] Server=[Samba 4.3.9-Ubuntu]

    Sharename       Type      Comment
    ---------       ----      -------
    netlogon        Disk
    sysvol          Disk
    IPC$            IPC       IPC Service (Samba 4.3.9-Ubuntu)
Domain=[EXAMPLE] OS=[Windows 6.1] Server=[Samba 4.3.9-Ubuntu]

    Server               Comment
    ---------            -------

    Workgroup            Master
    ---------            -------
    WORKGROUP            DC1

```

这里，我们从我们的`dc1` Samba 服务获得了一个清单(`-L`)，使用`Administrator`用户(`-U`)进行认证。如果你在这里得到错误，那么你在你的设置中有一个错误。这里有一个故障排除页面可能会帮到你: [`https://wiki.samba.org/index.php/Samba_AD_DC_Troubleshooting`](https://wiki.samba.org/index.php/Samba_AD_DC_Troubleshooting) 。

从测试中可以看到，我们有两个磁盘共享(`netlogon`和`sysvol`)和一个`IPC$`(用于与 Samba 通信的进程间连接)。我们可以运行`ls`命令(`-c`)来获得`netlogon`共享的列表，再次测试我们可以列出`netlogon`共享。

```sh
$ smbclient //localhost/netlogon -UAdministrator -c 'ls'
Enter Administrator's password:
Domain=[EXAMPLE] OS=[Windows 6.1] Server=[Samba 4.3.9-Ubuntu]
  .                                   D        0  Sat Sep 24 14:02:06 2016
  ..                                  D        0  Sat Sep 24 14:02:15 2016

        10098468 blocks of size 1024\. 7667640 blocks available

```

#### 测试 DNS

我们现在也可以测试我们的 DNS 响应。对于充当域控制器的 Samba，它必须响应以下文本记录请求:

```sh
$ host -t SRV _ldap._tcp.samba.example.com.
_ldap._tcp.samba.example.com has SRV record 0 100 389 dc1.samba.example.com.
$ host -t SRV _kerberos._udp.samba.example.com.
_kerberos._udp.samba.example.com has SRV record 0 100 88 dc1.samba.example.com.
$ host -t A dc1.samba.example.com.
dc1.samba.example.com has address 192.168.0.10

```

在这里，我们已经测试了我们可以解析 LDAP 服务记录、Kerberos 服务记录和`dc1.samba.example.com`的 A 记录。如果这个解析正确，那么 Samba 可以正确地使用我们的`bind9` DNS 服务。

如果这不起作用，从`/var/log/syslog`开始检查绑定服务是否有错误。

#### 测试 Kerberos

Kerberos 是一种网络身份验证协议，可用于将 Active Directory 服务连接在一起，并对用户和机器进行身份验证。Kerberos 是作为 Samba 自动安装的一部分安装的。因为我们只有一个 Samba 服务器，所以实际上并不需要它，除非我们加入另一个 Active Directory 域控制器，或者我们希望通过 Samba 服务作为单点登录机构来验证我们的 Linux 用户帐户。

在测试我们的 Kerberos 配置之前，我们首先需要创建一个符号链接。清单 [13-1](#Par40) 中的输出告诉我们 Kerberos 配置文件已经生成并放在了`/var/lib/samba/private/krb5.conf`中。我们将把它符号链接到`/etc/krb5.conf`。

```sh
$ sudo ln –sf /var/lib/samba/private/krb5.conf /etc/krb5.conf

```

看一下这个文件，我们可以看到它是这样的:

```sh
[libdefaults]
    default_realm = SAMBA.EXAMPLE.COM
    dns_lookup_realm = false
    dns_lookup_kdc = true

```

`dns_lookup_`选项决定了我们是否对 SRV 记录使用 DNS 查找。我们已经测试了 SRV 记录(`host -t SRV _kerberos._udp.samba.example.com`)。)在我们的 DNS 测试之前，并已确认它是为我们的 KDC (Kerberos 域控制器)工作。

现在让我们测试实现，以确保它工作正常。我们将获得一个 Kerberos 票证，然后验证它。

```sh
$ kinit administrator@SAMBA.EXAMPLE.COM
Password for administrator@SAMBA.EXAMPLE.COM:
Warning: Your password will expire in 41 days on Mon 07 Nov 2016 11:04:17 PM UTC

```

您确实需要为域指定大写字母。现在让我们看看我们的票:

```sh
$ klist
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: administrator@SAMBA.EXAMPLE.COM

Valid starting       Expires              Service principal
09/26/2016 23:34:37  09/27/2016 09:34:37  krbtgt/SAMBA.EXAMPLE.COM@SAMBA.EXAMPLE.COM
    renew until 09/27/2016 23:34:30

```

这证明 Kerberos 工作正常。我们现在都准备好创建一个共享了。

Note

Kerberos 可能是一个非常复杂和令人畏惧的话题。你可能喜欢读下面的温柔介绍: [`www.roguelynn.com/words/explain-like-im-5-kerberos/`](http://www.roguelynn.com/words/explain-like-im-5-kerberos/) 。

### 配置 Samba 共享

要访问 Samba 共享，我们需要做几件事:

*   将共享添加到`smb.conf`
*   创建目录并添加权限
*   创建任何必要的系统用户
*   将 Samba 用户添加到 Samba

让我们从查看我们将要使用的 Samba 配置文件开始。这是由供应过程创建的。

配置文件可以分成两部分，一部分是[ `global` ]配置选项，另一部分是特定的配置选项，比如[ `netlogon` ]、[ `sysvol` ]等等(见清单 [13-2](#Par74) )。[ `global` ]部分，顾名思义，定义了影响整个服务器的配置选项，[ `netlogon` ]和[ `sysvol` ]中的具体配置只影响它们试图定义的那些服务。

```sh
# Global parameters
[global]
    workgroup = SAMBA
    realm = SAMBA.EXAMPLE.COM
    netbios name = DC1
    server role = active directory domain controller
    server services = s3fs, rpc, nbt, wrepl, ldap, cldap, kdc, drepl, winbindd, ntp_signd, kcc, dnsupdate
    idmap_ldb:use rfc2307 = yes

[netlogon]
    path = /var/lib/samba/sysvol/samba.example.com/scripts
    read only = No

[sysvol]
    path = /var/lib/samba/sysvol
    read only = No

Listing 13-2.Samba /etc/samba/smb.conf File

```

我们来看一下[ `Global` ]部分。首先你会看到选项`workgroup`。如果您是 Windows 用户，应该对这个选项很熟悉。它是将出现在网上邻居中的工作组名称。工作组是共享信息的计算机的集合。通常，在工作组中，计算机没有中央身份验证，工作组中的每台主机负责自己的身份验证。换句话说，您维护一个可以访问每台主机的用户列表。

当工作组中的一台主机成为主域控制器(PDC)时，就实现了集中身份验证。主机加入域，然后使用 PDC 验证用户对其资源的访问。如果主机不是域的一部分，它仍然可以共享资源，但它必须维护自己的身份验证和访问列表。

在此设置工作组并不会使我们的主机成为 PDC，而只是工作组的一部分。我们将它设置为我们的域名，`EXAMPLE`。

```sh
workgroup = SAMBA

```

接下来，您需要配置 NetBIOS。NetBIOS 是一种本地广播协议，用于处理主机之间的连接信息。NetBIOS 信息用于将名称与 WINS 服务器中的互联网协议(IP)地址进行匹配，有点像 DNS。NetBIOS 协议本身用于名称服务、会话服务和数据报服务器。正如您在清单 [13-2](#Par74) 中看到的，我们正在将`netbios name`选项设置为`dc1`，我们将能够使用这个 NetBIOS 名称来引用我们的主机。

Note

如果你对 NetBIOS 的进一步解释感兴趣，请阅读 [`http://en.wikipedia.org/wiki/NetBIOS`](http://en.wikipedia.org/wiki/NetBIOS) 。

`server role`指令被设置为`active directory domain controller`。这显然意味着我们正在经营一个广告 DC。如果您要使用传统的域控制器，您应该在这里设置它(`NT4`)。`server services`指令定义了该服务器支持的服务。您可以在这里用+或-添加或删除服务，就像`-kdc`。

通过使用`hosts allow`选项指定哪些主机可以访问您的服务，您可以进一步控制对 Samba 服务的访问。在我们的配置中，我们指定了环回网络和 192.168.0。网络。符号`127.`和`192.168.0.`相当于分别指定网络掩码 127.0.0.0/8 和 192.168.0.0/24。在这里，您还可以使用完整的 IP 地址来指定单个主机，并使用`EXCEPT`子句来排除某些主机。例如，如果我们希望允许访问 192.168.0 上的所有主机。除了地址为 192.168.0.15 的恶意主机，我们将在`hosts allow`中使用以下内容:

```sh
hosts allow = 127\. 192.168.0\. EXCEPT 192.168.0.15

```

您还可以使用完全限定的域名(FQDNs)如`headoffice.example.com`或`gateway.example.com`来指定单个主机。我们没有在这里显示，但`hosts deny`允许您列出您不想访问此服务的主机和网络。

我们将让网络 192.168.0.0 到 192.168.30.0 访问此 Samba 服务，因此我们将指定以下内容，这将允许 192.168.0.0/16 范围内的任何地址进行连接:

```sh
hosts allow = 127\. 192.168.

```

Samba 认为一些服务是“特殊的”，这些服务以`[]`括号开始划分。具体来说，`[global`、【打印机】和`homes`描述特殊服务。Samba 对待这些服务的方式不同于[`sales`或[`tmp`]共享。

例如，如您所料，当 Samba 通过[ `printer` ]服务接收到一个文件时，它会以不同于通过用户定义的[ `tmp` ]服务接收到的文件的方式来处理它。Samba 具有只与这些“特殊”服务中的定义相关联的功能。在本例中，[【T2]]中的路径定义定义了一个假脱机目录。当您的打印机通过[ `printer` ]服务将您的打印输出假脱机到这个路径时，Samba 会自动将其传递给 CUPS 进行打印。在另一个服务中设置`path`的值不会触发此行为。这种特殊行为也适用于`[homes]`，如果需要的话，Samba 将动态创建主目录。您可以在`smb.conf man`页面的“特殊章节”部分了解更多信息。

当您定义自己的服务时，您使用一组特殊服务和用户定义的服务通用的指令。在表 [13-1](#Tab1) 中，我们列出了我们将在示例中使用的指令。您可以使用这些指令来改变或创建您自己的服务。

表 13-1。

Samba Service Directives

<colgroup><col> <col></colgroup> 
| 管理的 | 描述 |
| --- | --- |
| `path` | 定义您正在描述的共享的路径(例如，`/tmp`)。 |
| `browseable` | 描述共享在浏览器共享列表中是否可见。 |
| `comment` | 给出共享的描述。 |
| `writable` | 表示共享可以写入，而不是只读。 |
| `readonly` | 表示共享是只读的。 |
| `printable` | 允许创建假脱机文件并提交到共享。仅适用于打印。 |
| `guest ok` | 表示共享不需要密码。默认为否。也称为`public`。 |
| `valid users` | 指定允许使用此服务的用户列表。 |
| `write list` | 指定可以读取/写入共享的用户/组列表，而不管`readonly`设置如何。 |
| `force user` | 将默认用户分配给到此共享的所有连接。 |
| `force group` | 将默认组分配给到该主机的所有连接。 |
| `force create mode` | 对创建的文件强制 Unix 权限。 |
| `force directory mode` | 对创建的目录强制 Unix 权限。 |
| `create mask` | 对创建的文件设置 Unix 权限。 |
| `directory mask` | 对创建的目录设置 Unix 权限。 |

您可以使用这些服务指令来定义共享的路径和访问权限。还有更多可用的指令，您可以在`man smb.conf`页面中找到对它们的全面解释。

[`netlogon`]共享在 Samba 中没有被归类为特殊服务，但它是许多默认的`smb.conf`文件中的标准服务，并且默认包含在 Ubuntu 和 CentOS Samba 包中。这个和`[sysvol]`是作为默认配置过程的一部分创建的。`[netlogon]`服务用于验证 Windows 客户端，可以包含登录脚本和其他信息。每个域控制器都需要`[sysvol]`服务，它是在其他域控制器上复制的文件夹。

我们将在文件末尾的部分添加以下内容，以建立一个供`sales`组成员共享的`sales`共享:

```sh
[sales]
        comment = shared sales directory
        path = /data/staff/sales
        readonly = yes
        public = no
        browseable = yes
        valid users = +SAMBA\sales
        write list = jsmith, bsingh
        force create mode = 0770
        force directory mode = 2770
        create mask = 0770
        directory mask = 2770
        force group = sales
        force user = exbackup

```

我们添加了一个名为[ `sales` ]的共享。这份股票仅供我们的销售人员使用。我们已经决定将我们的员工共享文档放入`/data/staff`目录，而`sales`目录将位于该目录下。我们已经指定默认情况下它应该是只读的(`readonly = yes`)。这将阻止非预期用户写入此目录。我们也拒绝公众或客人用户(`public = no`)。它是可浏览的(`browserable = yes`)，所以它将出现在这个 Samba 服务器的共享浏览器列表中。我们还在这里指定了一个有效的用户列表，它被设置为 sales 组(`valid users = +SAMBA\sales`)。+指示 Samba 查看本地 Unix 用户/组列表。`sales`组中的人将对[ `sales` ]共享具有只读访问权限。然后，我们具体指定我们希望谁拥有读/写访问权限，`jsmith`和`bsingh`。我们也可以在这里使用组列表。如果我们有一个名为`sales_admins`的组，我们可以添加`write list = @sales_admins`。

最后一部分确保使用正确的所有权、组和权限创建文件和目录。我们不希望用户在整个目录树中拥有自己的文档，然后当他们想要与他人共享这些文档时，不得不找人更改他们的权限或所有权。我们希望所有者始终是`exbackup`,这样我们将始终能够使用我们的备份脚本访问共享，并且我们希望共享根据其部门组拥有组所有权。我们希望文件是可读和可写的，对于目录，我们应该给指定的用户和组完全的访问权限，但不允许普通公众访问。

```sh
force create mode = 0770
force directory mode = 2770
create mask = 0770
directory mask = 2770
force group = sales
force user = exbackup

```

正如您在第 [4](04.html) 章中看到的，这里的权限是对所有文件和目录的读、写和执行/访问。对于您的需求来说，这可能太宽松了，但是它给了您一个如何使用权限的想法。您可能希望创建仅具有 0660 权限的文件，这是完全合理的，但可能需要一些管理开销。

Samba 应该自动加载您的新配置，而不需要重启服务；但是，如果看不到您的配置，您可以使用以下命令重新启动该服务:

```sh
$ sudo systemctl restart samba-ad-dc

```

Samba Variable Substitutions

Samba 有一些标准的变量替换，我们将在这里看一下。以下列表是`man`页面上列出的可用变量的一部分:

*   `%U` : Session username(客户端需要的用户名，不一定是得到的用户名)。
*   `%G`:主组名`%U`。
*   `%S`:当前服务的名称，如果有的话。
*   `%L`:服务器的 NetBIOS 名称。这允许您根据客户端对您的调用来更改您的配置。你的服务器可以有双重人格。
*   `%M`:客户端机器的互联网名称。
*   `%D`:当前用户的域名或工作组名。
*   `%H`:由`%u`给出的用户的主目录。

这里我们没有显示所有的变量；有关变量的完整列表，请参见`man smb.conf`页。

### 向 Samba 添加用户

我们现在有了一个基本的 Samba 配置。如果您认为合适，可以将您自己的共享添加到此配置中。我们现在需要对主机做几件事，以便为用户做好准备。我们很快将通过`samba-tool`命令创建我们的 Samba 用户和组，一旦完成，我们将创建我们的目录并分配权限。

我们设置 Samba 的方式要求在 Samba 主机上管理用户帐户。Samba 为`samba-tool`提供了一个子命令来管理 Samba 主机上的用户帐户。工具`samba-` `tool`使用以下语法:

```sh
$ sudo samba-tool user --help
Usage: samba-tool user <subcommand>

User management.

Options:
  -h, --help  show this help message and exit

Available subcommands:
  add          - Create a new user.
  create       - Create a new user.
  delete       - Delete a user.
  disable      - Disable an user.
  enable       - Enable an user.
  list         - List all users.
  password     - Change password for a user account (the one provided in authentication).
  setexpiry    - Set the expiration of a user account.
  setpassword  - Set or reset the password of a user account.
For more help on a specific subcommand, please type: samba-tool user <subcommand> (-h|--help)

```

让我们列出我们现有的用户。

```sh
$ sudo samba-tool user list
Administrator
dns-dc1
krbtgt
Guest

```

您可以看到，我们有四个当前用户，它们是由 Samba 供应创建的。我们将再添加两个用户，`jsmith`和`bsingh`，他们是销售团队的成员。

```sh
$ sudo samba-tool user create jsmith
New Password:
Retype Password:
User 'jsmith' created successfully

```

我们添加了一个名为`jsmith`的新用户。我们将为`bsingh`做同样的事情。密码至少要有 8 个字符，并且要复杂。

不幸的是，`tbear`刚刚离开公司，他的 Samba 帐户需要禁用。为此，我们禁用`tbear`的详细信息，如下所示:

```sh
$ sudo samba-tool user disable tbear
Disabled user tbear

```

如果我们想完全移除他，我们会使用`samba-tool user delete`。

接下来我们将创建我们的`sales`组，然后我们将添加`jsmith`和`bsingh`到其中。我们通过`group`子命令再次使用`samba-tool`。发布`help`显示我们的选项。

```sh
$ sudo samba-tool group
Usage: samba-tool group <subcommand>

Group management.

Options:
  -h, --help  show this help message and exit

Available subcommands:
  add            - Creates a new AD group.
  addmembers     - Add members to an AD group.
  delete         - Deletes an AD group.
  list           - List all groups.
  listmembers    - List all members of an AD group.
  removemembers  - Remove members from an AD group.
For more help on a specific subcommand, please type: samba-tool group <subcommand> (-h|--help)

```

如您所见，它类似于`user`子命令。首先让我们添加`sales`组。

```sh
$ sudo samba-tool group add sales
Added group sales

```

这很简单，您还应该添加组`staff`。我们现在可以将我们的用户添加到`sales`组。

```sh
$ sudo samba-tool group addmembers sales jsmith,bsingh
Added members to group sales

```

我们现在可以列出`sales`组的成员了。

```sh
$ sudo samba-tool group listmembers sales
jsmith
bsingh

```

我们可以通过以下方式删除组和移除组成员:

```sh
$ sudo samba-tool group removemembers sales tbear
Removed members from group sales

```

我们已经将用户`tbear`从`sales`组中删除；我们也可以用下面的内容删除`fails`组:

```sh
$ sudo samba-tool group delete fails
Deleted group fails

```

Samba 将对我们的用户进行身份验证，并为他们提供对他们有权访问的任何共享的访问。Samba 将使用 Winbind 为我们认证和映射用户和组。但是，我们仍然需要创建一个 Linux 系统用户。这个用户将拥有这些文件，因此需要存在于每个 Samba 服务器上。该用户将是我们的备份用户。我们将在第 [14](14.html) 章中向您展示如何在我们的备份策略中使用该用户。

```sh
$ sudo useradd –u 903 exbackup

```

接下来，我们需要创建目录`/data/staff/sales`。我们将使`exbackup`成为`/data/staff`中文件和目录的所有者。我们需要确保适当的组可以访问我们定义的共享，我们将很快做到这一点。

```sh
$ sudo mkdir –p /data/staff/sales
$ sudo chown exbackup –R /data/staff

```

Note

这些用户和组 id 都是任意的，它们可能已经在您的主机上使用了。您可能需要为您的网络选择不同的范围。记住，小于`1000`的 ID 值是为系统帐户保留的。

我们在桑巴建立了`sales`团。我们现在需要查询 Winbind 来获取已经分配给`sales`组的 GID，然后我们将更改目录上的组所有权。这些用户和组不存在于普通的 Linux `/etc/passwd`或`/etc/group`文件中，所以我们需要使用 Samba 在访问文件和目录时将使用的 GID。

```sh
$ wbinfo --group-info sales
SAMBA\sales:x:3000010:

```

我们可以看到`wbinfo`已经查询了销售组的组信息，并且 GID 3000010 已经被分配给它。我们将使用这个 GID 来更改组所有权。

```sh
$ sudo chgrp 3000010 /data/staff/sales

```

我们还发现 staff GID 是 3000012，我们将在这里使用它:

```sh
$ sudo chgrp 3000012 /data/staff

```

现在，我们已经在这些目录上设置了权限。我们希望阻止对目录的一般访问，只允许定义的用户和组。

```sh
$ sudo chmod 0750 /data && sudo chmod 2750 /data/staff
&& sudo chmod 2770 –R /data/staff/sales

```

我们现在准备使用我们的 Samba 服务。

### Samba 所需的 iptables 规则

Samba 4 要求在防火墙中打开以下端口:

*   NetBIOS 名称服务端口 137 和 138 上的 UDP 协议
*   用于 NetBIOS 会话的端口 139 上的 TCP 协议
*   Samba 服务器的 Microsoft-dn TCP 端口 445

对于 Ubuntu，我们只需要添加以下命令:

```sh
$ sudo ufw allow samba
$ sudo ufw allow bind9

```

有许多端口正在监听 Samba。最好将您的 ufw 默认策略更改为`deny`，以拒绝对端口的访问，除非明确允许。

```sh
$ sudo ufw default deny

```

这样做时应该小心，因为它可能会阻止其他合法进程侦听主机。

Note

我们在第七章[中讨论了`iptables`](07.html)。

## 在 Linux 上挂载 Samba 共享

Linux 主机也可以使用`mount`命令和`cifs`类型挂载 Windows 共享。你需要安装`cifs-utils`软件包。然而，一些 Linux 发行版不包括读写 NTFS 共享的能力，因为微软认为这样做侵犯了它的专利。这两个发行版都允许挂载 NTFS 和 FAT 文件系统，您可以在`cifs-utils`包中找到它。

您需要创建`/data/sales`目录。要在 Linux 主机上挂载 Samba 共享，您应该执行类似于下面的操作:

```sh
$ sudo mount -t cifs //dc1.samba.example.com/sales /data/sales -o username=jsmith
Password for jsmith@\dc1.samba.example.com\sales:  *****************

```

这将在`/data/sales`目录下挂载远程 Samba 共享`/data/staff/sales`。您传递远程主机和您的用户名。您将被要求提供一个密码，然后共享应该被挂载在`/data`目录下。有关挂载 Samba 共享的更多信息，请阅读`man mount.cifs`页面。

我们可以用我们的`mount`命令看到挂载的共享。

```sh
$ sudo mount
\\dc1.samba.example.com\sales on /data/sales type cifs (rw,relatime,vers=1.0,cache=strict,username=jsmith,domain=SAMBA,uid=0,noforceuid,gid=0,noforcegid,addr=192.168.0.1,unix,posixpaths,serverino,acl,rsize=61440,wsize=65536,actimeo=1)

```

在前面的例子中可以找到`cifs mount`的默认选项，完整的细节可以在`man mount.cifs`页面中找到。你可以看到我们附上的用户名；域名是`SAMBA`。您可以看到`rsize`和`wsize`，它们是可以在主机和 Samba 服务器之间发送的数据的最大字节大小，如果需要，这是可以配置的。`cache=strict`设置缓存策略，支持并遵循 CIF/SMB2 协议；其他选项有`none`和`loosely`。

如果我们想通过`fstab`自动挂载它，我们需要在引导时提供凭证。这些凭证需要在文件系统上的一个文件中以纯文本的形式提供，最好是在用户的主目录中。当然，这是一个安全问题，因为在文件系统上存储纯文本凭证可能会在受损的系统上被窥探，并被用来访问其他系统。但是，如果选择这种方式，您可能希望 Samba 拥有不同于其他系统的单独凭证(这会增加管理负担)。

因此，首先需要在主目录中创建`.smb_credentials`文件。它应包含以下内容:

```sh
username=bsingh
password=C0mpl#xp$sSw0rd

```

您应该通过以下方式保护它:

```sh
$ chmod 0600 .smb_credentials

```

您需要编辑您的`/etc/fstab`文件，并为自动挂载添加以下内容:

```sh
//dc1.samba.example.com/sales /data/sales cifs _netdev,credentials=/home/bsingh/.smb_credentials

```

这对于单一桌面访问很有用，但是如果人们共享开发服务器，这就变得更复杂了。

在许多人共享一台服务器的情况下，您可以使用`multiuser` mount 选项共享对共享目录的访问。用户通过本地用户和共享装载连接获得对这些共享的访问权限。例如，用户`jsmith`和`bsingh`可以通过一个公共的本地用户共享一个公共挂载。

在本例中，组`sales`不需要存在于我们装载共享的本地 Linux 服务器上，但是用户`exbackup`也需要存在。在 Linux 服务器上也有`jsmith`和`bsingh`的本地用户账户。

在 Samba 服务器上，我们将创建一个用户，我们将使用该用户作为一组用于挂载的共享凭证。记得给这个用户一个唯一的复杂密码。

```sh
$ sudo samba-tool user add sharedcreds

```

我们会将他们添加到`sales`组。

```sh
$ sudo samba-tool group addmembers sales sharedcreds

```

当我们正常装载共享时，我们提供用户名和密码，并使用它来管理我们的装载。这允许只安装一个`/data/sales`，并且只有一组用户凭证能够访问它。在共享的`multiuser`环境中，我们可以为一个普通用户挂载共享。从本地 Linux 服务器上的用户会话中，我们可以向内核提供凭据，内核将允许我们使用这些凭据访问共享。

在本地 Linux 服务器上，我们将把`/data/sales`挂载为`sharedcreds`用户(本地 Linux 服务器上不存在的用户)。我们通过`cifscreds`命令这样做:

```sh
$ sudo cifscreds add -u sharedcreds dc1.samba.example.com

```

我们可以使用任何拥有`sudo`访问权限的用户来做这件事。我们提供了`add`参数、用户以及我们想要访问的主机。要删除这些凭证，我们可以发出以下命令:

```sh
$ sudo cifscreds clear –u sharedcreds

```

查看`cifscreds`的`man`页面，了解其他选项。我们现在可以使用以下命令在本地服务器上装载共享:

```sh
$ sudo mount -tcifs //dc1.samba.example.com/sales /data/sales/ -o multiuser,username=sharedcreds, \
uid=exbackup,gid=3000017

```

这将使用`sharedcreds`用户挂载`/data/sales`共享。但是因为没有本地的`sharedcreds`用户，我们没有权限写入`/data/sales`。如果我们从`jsmith`的角度来看，我们可以看到它也无法进入。

```sh
[jsmith@backup]
$ cp text.file /data/sales/
cp: cannot create regular file '/data/sales/text.file': Permission denied
[jsmith@backup ∼]$ ll /data/
ls: cannot access /data/sales: Permission denied
total 20
d?????????? ? ?        ?         ?            ? sales

```

用户`jsmith`甚至看不到`/data/sales`目录上的权限，这就是`????`的原因。我们也需要向内核提供我们的凭证，以便它可以管理我们到那个挂载的会话。

```sh
$ sudo cifscreds add –u jsmith  dc1.samba.example.com

```

`jsmith`用户将需要`sudo`访问`cifscreds`；否则，它将无法执行该命令。现在我们已经将凭证添加到内核中，我们可以列出`sales`目录，并使用`exbackup`和`sales`组权限对其进行读写操作。

```sh
[jsmith@backup ∼]$ ll /data/sales/
total 1405408
-rwxrwx---+ 1 exbackup 3000017     66376 Nov 26 17:14 logo.png
-rwxrwx---+ 1 exbackup 3000017 479678976 Nov 27 13:21 forecast-2016.xls
-rwxrwx---+ 1 exbackup 3000017 479678976 Nov 27 14:04 media.docx

```

现在，`bsingh`也需要访问`sales`目录。我们需要将用户添加到 Samba `sales`组，然后在本地 Linux 服务器上的用户会话中设置他们的 Samba 凭证。因此，在 Samba 服务器上，我们发出以下命令:

```sh
$ sudo samba-tools group addmembers sales bsingh

```

现在，在`bsingh`的本地 Linux 服务器登录中，我们发出以下命令:

```sh
$ sudo cifscreds add -u bsingh dc1.samba.example.com

```

现在`bsingh`也可以访问安装在`/data/sales`上的 Samba 共享。

### 在 macOS 上增加股份

我们将向您展示如何使用图形界面在 macOS 上挂载 Linux Samba 共享。这在 macOS 或 Windows 桌面上是一个简单的过程，并且遵循相同的模式。

我们需要能够解析 Samba 服务器的主机名。如果您无法解析`dc1.samba.exmaple.com`主机名，请检查您的`/etc/resolv.conf`，或者，如果您使用的是 Windows，请检查您的网络设置。

首先，我们使用 Finder 挂载 Samba 共享。一旦应用程序启动，选择去➤连接到服务器，或者你可以按⌘ K，并获得相同的屏幕。

在图 [13-1](#Fig1) 中，我们只需添加我们的服务器地址并点击连接。

![A185439_2_En_13_Fig1_HTML.jpg](A185439_2_En_13_Fig1_HTML.jpg)

图 13-1。

Adding server address

下一步是添加凭证，如图 [13-2](#Fig2) 所示。

![A185439_2_En_13_Fig2_HTML.jpg](A185439_2_En_13_Fig2_HTML.jpg)

图 13-2。

Adding Samba credentials

如果我们想安全地保存这些凭证，我们可以将它们添加到我们的钥匙串中，这是一个加密的凭证保险箱(图 [13-3](#Fig3) )。

![A185439_2_En_13_Fig3_HTML.jpg](A185439_2_En_13_Fig3_HTML.jpg)

图 13-3。

Adding credentials to the keychain

现在我们需要做的就是点击连接(图 [13-4](#Fig4) )。

![A185439_2_En_13_Fig4_HTML.jpg](A185439_2_En_13_Fig4_HTML.jpg)

图 13-4。

Successfully mounted

如图 [13-4](#Fig4) 所示，我们已经成功挂载了`sales`目录。互联网上有大量的指导页面，可以帮助您使用特定版本的软件，或者帮助您解决 Windows 和 macOS 可能出现的不同错误。

网上已经有几个关于为 Windows 主机挂载驱动器的资源，比如这个: [`www.laptopmag.com/articles/map-network-drive-windows-10`](http://www.laptopmag.com/articles/map-network-drive-windows-10) 。我们将把它作为一个练习留给你。该过程类似于我们为 Mac 安装驱动器的过程，也类似于安装其他 Windows 网络驱动器的过程。

### 资源

有关设置 Samba 的更多信息，请参见以下资源:

*   [T2`https://wiki.samba.org/index.php/Main_Page`](https://wiki.samba.org/index.php/Main_Page)
*   [T2`https://www.samba.org/samba/docs/`](https://www.samba.org/samba/docs/)
*   [T2`www.samba.org/samba/docs/man/Samba-HOWTO-Collection/-v3.5`](http://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/-v3.5)

## NFS 分享:Linux 到 Linux

Linux 主机也可以像 Samba 一样相互挂载共享。传统上，这是通过网络文件系统(NFS)在 Linux 和 Unix 主机上实现的。最新版本的 NFS 4 比以前的 NFS 版本有很多优势。也就是说，现在它只需要一个端口，而在此之前它需要几个端口，在此之前，您无法知道它将使用哪些端口！这使得使用防火墙变得不可能，这当然使得许多安全管理员非常乐意否认防火墙在他们的网络上的存在。它已经从中吸取了教训，今天是一个值得尊敬的网络公民。

我们将快速向您展示如何在主机之间共享文件系统，通常称为网络挂载。在 Ubuntu 主机上，你需要安装`nfs-server`包。在 CentOS 主机上，您需要安装`nfs-utils`。

NFS 要求在您的防火墙上打开 TCP 2049 端口。对于 CentOS，您可以这样添加:

```sh
$ sudo firewall-cmd --permanent --zone public --add-service nfs
$ sudo firewall-cmd --reload

```

在 Ubuntu 上，您可以添加以下内容:

```sh
$ sudo ufw allow 2049/tcp

```

现在，让我们确保 NFS 服务器正在我们的主机上运行。如果它没有运行，您可以通过发出以下命令来启动它(在 Ubuntu 上将`nfs-server`替换为`nfs`):

```sh
$ sudo systemctl restart nfs
$ sudo systemctl enable nfs

```

一旦完成，您需要编辑`/etc/exports`文件。

NFS 从`/etc/exports`文件中读取其共享指令。在这里，您可以添加想要共享的目录以及一些关于如何共享它们的选项。您需要使用以下语法:

```sh
directory network(nfs_options),network(nfs_options)

```

您可以选择想要共享的目录、想要共享的网络，然后选择几个 NFS 选项。看一下我们要用的那个:

```sh
/data/staff 192.168.0.2/255.255.255.255(rw,root_squash,fsid=0)

```

这里我们将把`/data/staff`目录共享给位于 192.168.0.2/32 的主机。这个 IP 地址也可以是一个 FQDN，比如`fileserver2.example.com`，或者是一个完整的域名，比如`*.example.com`，如下所示:

```sh
/data/staff 192.168.0(rw,root_squash,fsid=0) *.example.com(rw,root_squash,fsid=0)

```

接下来，我们设置以下选项:`rw,root_squash,fsid=0`。第一个选项(`rw`)允许共享可读写。选项`root_squash`意味着远程主机上的 root 用户将 UID/GID 设置为匿名 UID/GID，这意味着该用户的 root 权限在该共享上有效。这是为了保护网络安装不被远程`root`用户破坏。

`fsid`选项标识 NFS 正在导出的文件系统。这(`fsid=0`)告诉 NFS`/data/staff`是所有导出文件系统的根，而不是`/data`。这意味着当我们发出下面的`mount`命令时:

```sh
$ sudo mount nfs1:/ /path/to/mountpoint

```

只有`/data/staff`和它下面的所有东西可以从`nfs1:/`挂载。这也意味着你不必用你的`mount`命令指定`nfs1:/data/staff`。当你挂载`nfs1:/`时，你也将看不到`/data`目录中的任何其他目录。

还有许多其他选项可以指定，我们建议您阅读导出的`man`页，以获得更多详细信息。要激活这些设置，您需要运行以下命令:

```sh
$ sudo exportfs –a

```

前面的命令将导出或取消导出`/etc/exports`中列出的所有目录。您也可以使用`exportfs –rv`，它也将更新导出的目录并删除未导出的目录。这些选项将导出与`/var/lib/nfs/etab`和 Linux 内核同步。

既然已经定义了新的网络挂载，我们将尝试在远程主机上挂载我们的共享。让我们看看我们的 NFS 山是否有人招待。您可以使用`showmount`命令通过发出以下命令来检查您的 NFS 股票:

```sh
$ sudo showmount -e localhost
Export list for localhost:
/data/staff 192.168.0

```

您可以看到，输出显示了我们的 NFS 装载以及可以连接到它的主机 IP 地址。

在远程主机 192.168.0.2 上，我们需要发出以下命令来将共享`/data/staff`挂载到`/data/remote`(在运行该命令之前需要存在`/data/remote`):

```sh
$ sudo mount -t nfs4 -o rw,intr,hard 192.168.0.1:/data/staff /data/remote

```

这将把`/data/staff`目录挂载到远程主机上的`/data/remote`目录。您会注意到，我们已经指定了共享名`/data/staff`，后面跟着要装载的主机，如设置`192.168.0.1:/data/staff`所示。这是因为我们特别请求在那个远程主机上我们有权访问的目录；然而，如果我们愿意，我们可以指定`/`，我们将挂载我们可以访问的所有共享。

我们使用`mount`命令挂载一个类型为`nfs4`的文件系统。我们在这个挂载上设置了以下选项:读/写、可中断(由`intr`指定)和`hard`。第一种是不言自明的；后两个不是。NFS 传统上有一个怪癖，如果共享文件系统的主机出现问题，它会导致所有加入它的主机受到严重影响，直到服务恢复或主机重启。`intr`或中断，允许在等待服务器响应时中断 NFS 4 操作。`hard`选项意味着文件系统将被视为本地挂载的文件系统。如果它被设置为`soft`，作为`hard`的替代，文件系统将在空闲一段时间后自动卸载。有关安装选项的更多信息，请参见`mount`的`man`页。

要将它设置为在主机重启时自动挂载，我们需要将它添加到`/etc/fstab`文件中:

```sh
192.168.0.1:/ /data/remote nfs4 rw,hard,intr,_netdev 0 0

```

在这里，我们从主机 192.168.0.1 访问 NFS 文件系统，并在`/data/remote`目录下挂载远程共享。我们指定了与之前相同的选项，并增加了一个选项。`_netdev`选项告诉我们的主机在我们的网络设备启动之前不要尝试挂载我们的文件系统。如果未设置此项，主机将无法装载文件系统，并等待很长时间，直到失败且尝试超时。

### NFS 故障排除

众所周知，NFS 很难排除故障，因为它提供有限的日志记录和模糊的错误消息。它正在变得越来越好，您可以通过在`mount`命令中添加`–v`来尝试一些基本的故障排除，这会给您提供更多的信息。

```sh
$ sudo mount -v -tnfs4 192.168.0.30:/data/cows /data/remotes/cows -oro
mount.nfs4: timeout set for Fri Sep 30 03:29:32 2016
mount.nfs4: trying text-based options 'addr=192.168.0.30,clientaddr=192.168.0.1'
mount.nfs4: mount(2): No such file or directory
mount.nfs4: mounting 192.168.0.30:/data/cows failed, reason given by server: No such file or directory

```

作为主流 Linux 操作系统的一部分，内核 NFS 服务器有一个“用户空间”或基于 FUSE 的替代品。它被称为 NFS-甘尼萨，可以在这里找到:

*   [T2`https://github.com/nfs-ganesha/nfs-ganesha/wiki`](https://github.com/nfs-ganesha/nfs-ganesha/wiki)

FUSE 是 UserSpacE 中 Filesystem 的缩写，意思是 NFS 服务器不在内核中执行，而是使用内核模块访问必要的资源，在用户空间中执行(见 [`https://en.wikipedia.org/wiki/Filesystem_in_Userspace`](https://en.wikipedia.org/wiki/Filesystem_in_Userspace) )。

NFS 服务器的设计目的不是在不进行实质性修改的情况下实现高可用性。没有本地的群集概念，他们需要块级设备复制或群集文件系统、浮动 IP 寻址等来扩展。现在是时候向您展示一种替代方案了:分布式网络文件系统。

### 资源

你可以在这里找到更多关于 NFS 的信息:

*   [T2`http://nfs.sourceforge.net/nfs-howto/`](http://nfs.sourceforge.net/nfs-howto/)
*   [T2`https://help.ubuntu.com/community/NFSv4Howto`](https://help.ubuntu.com/community/NFSv4Howto)

## 分布式网络文件系统

分布式网络文件系统(DNFS)是一个使用商用硬件的大型、分布式和可扩展的文件系统。分布式网络文件系统对于处理磁盘映像文件、媒体文件和用于分析处理的可伸缩数据非常有用。与简单的 NFS 相比，DNFS 有几个优点:

*   分布式(丢失一台服务器不会影响服务)
*   可扩展至数 Pb
*   地理分布，能够跨数据中心使用

有几种不同的解决方案可供选择。我们将向您展示如何设置 GlusterFS，但是您也可以根据您的工作量或偏好从几个备选方案中进行选择。

*   cehfs:[`http://ceph.com/`](http://ceph.com/)
*   BeeGFS(原 FhGFS): [`www.beegfs.com/content/`](http://www.beegfs.com/content/)
*   Hadoop (HDFS): [`http://hadoop.apache.org/`](http://hadoop.apache.org/)

对于跨许多服务器共享文件的直接文件系统，您可能不希望 Hadoop HDFS，因为它更适合 Hadoop `map-reduce`工作负载，并且要求您使用 Hadoop API 进行文件系统访问。其他的都提供了 POSIX 兼容的文件系统，您可以在您的服务器上挂载和访问文件和目录。

CephFS 和 GlusterFS 在架构上最相似的地方在于它们都不需要元数据服务器，而 BeeGFS 和 HDFS 的架构相似之处在于它们都需要元数据服务器。Ceph 本身是对象块存储和可靠的自治分布式对象存储(RADOS ),可以支持大量数据。所有这些都可以得到商业支持许可证或创建它们的相关社区的支持。

### 格鲁斯特

GlusterFS 是一个网络文件系统，启动其开发的公司(Gluster Inc .)被 Red Hat 收购。Red Hat 提供了软件的支持模型，如果您有复杂的需求，那么您应该考虑购买它。你可以运行网站上的开源版本( [`https://www.gluster.org/`](https://www.gluster.org/) )。

因为我们要安装分布式服务，所以至少需要三台主机。与所有分布式服务一样，拥有奇数个主机通常是首选，因为这有助于避免“裂脑”在设计集群时，您还可以考虑其他一些事情，例如将物理服务器放在不同的机架或不同的数据中心，以帮助实现数据弹性。

Note

裂脑是指在一个集群中，至少有两台服务于同一应用程序的服务器彼此看不到对方，但仍能响应客户端。在这种情况下，数据完整性和一致性开始偏离，因为两台服务器都继续提供和存储数据，但不再能在彼此之间同步任何数据。

#### GlusterFS 的关键概念

在考虑 GlusterFS 时，有几个关键概念。

*   GlusterFS 网络文件系统是“无元数据”分布式文件系统，这意味着它没有用于处理文件位置数据的专用元数据服务器。相反，它使用确定性散列技术来发现文件位置(参见 DHT [`http://gluster.readthedocs.io/en/latest/Quick-Start-Guide/Architecture/`](http://gluster.readthedocs.io/en/latest/Quick-Start-Guide/Architecture/) )。
*   GlusterFS 导出一个完全符合 POSIX 的文件系统，这基本上意味着您可以从 Unix 和类 Unix 操作系统(比如 Linux)挂载、读取和写入 GlusterFS。
*   GlusterFS 是一个用户空间文件系统，这意味着它不在 Linux 内核中运行，而是使用 FUSE 模块。
*   可信池是在 GlusterFS 集群中运行的服务器网络。每台服务器称为一台对等机。
*   砖块是 GlusterFS 的基本储存单位。它被导出到受信任池中的服务器。
*   卷是砖块的逻辑集合。

有几种方法可以将数据存储在 GlusterFS 中。这些概念类似于 RAID 中的概念。根据您的配置选项，文件可以存储在具有或不具有冗余级别的 Gluster 卷中。

*   分布式卷:默认情况下，如果没有指定分发类型，GlusterFS 会创建一个分布式卷。在这种设置中，文件可以存储在卷中的任何块上，没有冗余。
*   复制卷:在复制卷设置中，您的文件会跨卷中的所有块进行复制。这至少需要两块砖，并提供一定程度的冗余。
*   分布式复制卷:此配置中的文件存储在复制的砖块集合中。这里砖块的数量必须是副本数量的倍数。这是高可用性文件存储的配置。
*   条带卷:对于许多客户端频繁访问的大文件，此配置将大文件存储在块中(块的数量与砖的数量相同)。这种配置提供零冗余。
*   分布式条带卷:在这里，我们将数据条带化(分块)到许多砖块上。砖块的数量必须是条带数量的倍数。这可以提供更快的速度，但仍然不提供冗余。

#### 安装 GlusterFS

幸运的是 GlusterFS 很容易安装。Ubuntu 和 CentOS 都有可用的原生包。但是要在 CentOS 上安装最新的 GlusterFS，我们就要安装 CentOS 特别兴趣小组(SIG 见 [`https://wiki.centos.org/SpecialInterestGroup`](https://wiki.centos.org/SpecialInterestGroup) )。为此，我们将为 GlusterFS 版本 3.7.x 安装 YUM 存储库，如下所示:

```sh
$ sudo yum install centos-release-gluster37
$ sudo yum install –y glusterfs-server

```

对于 Ubuntu，我们将添加 Gluster 团队 PPA(这个 PPA，或个人包存档，并不直接与 Gluster 相关，而是一组 Ubuntu 维护者)。这也将为我们提供最新的 Gluster 3.7 . x 版本。

```sh
$ sudo add-apt-repository ppa:gluster/glusterfs-3.7 && sudo aptitude update
$ sudo aptitude install –y glusterfs-server

```

现在，对于 Ubuntu 和 CentOS，让我们确保服务在引导时启动。在 Ubuntu 上执行此操作:

```sh
$ sudo systemctl enable glusterfs-server

```

为 CentOS 执行此操作:

```sh
$ sudo systemctl enable glusterd glusterfsd

```

现在它们已经安装好了，我们可以配置 GlusterFS 了。

#### 配置 GlusterFS

让我们看看如何设置我们的服务器。我们有三台服务器，每台都有一个 50GB 的驱动器用于存储数据。我们将拥有一台 Ubuntu 和两台 CentOS 服务器。Ubuntu 服务器已经将 50GB 的磁盘连接到`/dev/sdc`，而在 CentOS 上，它连接到`/dev/sdb`。

我们将使用 XFS 文件系统格式化这些驱动器，因为这是推荐的文件系统。考虑到这一点，如果您愿意，可以用 ext4 格式化。我们通过以下方式做到这一点:

```sh
$ sudo mkfs.xfs –L brick1_r1 /dev/sdb
$ sudo mkdir –p /data/brick1_r1 && sudo bash –c 'echo LABEL=brick1_r1  /data/brick1_r1  xfs  defaults  1  2 >> /etc/fstab'
$ sudo mount –a

```

我们已经选择创建带有`brickN_rN`后缀的设备标签和模块，其中`brickN`是一个递增的数字，`_rN`是它们所属的复制集。这允许我们在复制集中添加和替换数据块。给事物命名是困难的，如果你有一个更好的命名方案，没有理由遵循这个。让我们在我们的 Ubuntu 服务器上启动 Gluster 为此，我们执行以下命令:

```sh
$ sudo systemctl start glusterfs-server

```

如果我们选择了 CentOS 服务器，我们将发出以下命令:

```sh
$ sudo systemctl start glusterd && sudo systemctl start glusterfsd

```

当然，我们可以通过发出`sudo systemctl status <service.name>`来检查服务是否正确启动，但是我们将运行其中一个`gluster`命令。如果一切正常，我们应该不会收到错误。

```sh
$ sudo gluster peer status
Number of Peers: 0

```

太棒了。我们已经使用了`gluster`命令来查询 Gluster 集群并检查对等机的状态。我们没有添加任何对等项，因此我们预计在此阶段该值为 0。

您可以通过`gluster`命令实用程序访问和配置 GlusterFS 服务。语法如下所示:

```sh
$ sudo gluster <subcommand> <options> <args...>

```

`gluster help`选项在描述每个指令的子命令、选项和参数时非常有用。表 [13-2](#Tab2) 列出了一些你会用到的常用子命令。

表 13-2。

Gluster CLI Commands

<colgroup><col> <col></colgroup> 
| `volume info` | 显示任何已配置卷的信息 |
| `volume list` | 列出当前卷 |
| `volume create` | 创建卷 |
| `volume delete` | 删除卷 |
| `volume start/stop` | 启动或停止卷 |
| `volume add-brick` | 将砖添加到卷 |
| `volume replace-brick` | 取代砖块 |
| `volume top` | 给出 Gluster 音量指标 |
| `volume set` | 打开或设置音量选项`<key> <value>` |
| `peer status` | 给出集群中对等方的状态 |
| `peer probe` | 探测并添加其他对等方 |
| `pool list` | 列出受信任存储池中的所有节点 |

#### GlusterFS:添加对等点和创建卷

我们选一个主机吧(哪个都无所谓)；我们将开始我们的集群。我们将选择我们的 Ubuntu 服务器，但任何都可以。我们将在这台服务器上执行以下操作:

*   将对等机添加到我们的集群
*   在我们的砖块上创建一个卷目录
*   创建卷

我们将主机命名为`au-mel-dfs-1`到`au-mel-dfs-3`，并将其添加到我们的 DNS 区域。Ubuntu 主机已经分配给`au-mel-dfs-3`。为了将我们的对等体添加到集群中，我们发出以下命令:

```sh
$ sudo gluster peer probe au-mel-dfs-1
peer probe: success.

```

我们对`au-mel-dfs-2`做同样的事情。现在我们可以再次展示我们同伴的状态了。

```sh
$ sudo gluster peer status
Number of Peers: 2

Hostname: au-mel-dfs-1
Uuid: a605a82d-fa77-48dd-8183-95a960547b1f
State: Peer in Cluster (Connected)

Hostname: au-mel-dfs-2
Uuid: 5ceee284-616b-4c2d-87d7-1c44f4cbdca0
State: Peer in Cluster (Connected)

```

我们现在也可以在`gluster`可信存储池中看到这些主机。

```sh
sudo gluster pool list
UUID                                    Hostname        State
a605a82d-fa77-48dd-8183-95a960547b1f    au-mel-dfs-1    Connected
5ceee284-616b-4c2d-87d7-1c44f4cbdca0    au-mel-dfs-2    Connected
30cf104f-00b2-4371-8935-d91719a2e17b    localhost       Connected

```

每个对等体都有一个 UUID，您可以看到主机名和当前状态。只有该列表中的对等体可以探测新的对等体。现在，我们将在所有对等体上创建我们的卷目录。这可以是任何名字，但我们称自己的名字为`vol1`。

```sh
$ sudo mkdir /data/brick1_r1/vol1

```

我们现在将创建我们的 Gluster 卷。我们使用下面的命令来完成这项工作:

```sh
$ sudo gluster volume create vol1 replica 3 \
       au-mel-dfs-1:/data/brick1_r1/vol1 \
       au-mel-dfs-2:/data/brick1_r1/vol1 \
       au-mel-dfs-3:/data/brick1_r1/vol1
volume create: vol1: success: please start the volume to access data

```

我们创建了一个名为`vol1`的新 Gluster 卷。它将在三块砖上复制每个文件。我们正在添加的这些砖块位于我们的三个对等体上，我们之前已经列出了这些对等体。

Note

这里值得注意的是，每个文件有三个副本会使您的存储需求增加至少三倍。

我们现在可以看到与该卷相关的信息；让我们运行以下命令:

```sh
$ sudo gluster volume info
Volume Name: vol1
Type: Replicate
Volume ID: e9964568-feef-4f2f-a61d-14ba643b76e5
Status: Created
Number of Bricks: 1 x 3 = 3
Transport-type: tcp
Bricks:
Brick1: au-mel-dfs-1:/data/brick1_r1/vol1
Brick2: au-mel-dfs-2:/data/brick1_r1/vol1
Brick3: au-mel-dfs-3:/data/brick1_r1/vol1
Options Reconfigured:
performance.readdir-ahead: on

```

我们的 Gluster 卷已经创建，我们可以在前面的行中看到详细信息。我们可以看到类型(`Replicate`)和砖的数量(1 × 3 = 3)。这告诉我们，每个文件将存储在每个砖块上，我们有一组三个砖块，总共三个砖块。

我们可以检查音量的状态。我们可以通过以下方式做到这一点:

```sh
$ sudo gluster volume status
Volume vol1 is not started

```

因此，就像创建卷时的消息一样，它还没有启动，我们必须启动它。现在，让我们使用以下命令来完成这项工作:

```sh
$ sudo gluster volume start vol1
volume start: vol1: success

```

至此，我们已经创建并启动了 Gluster 卷，现在我们准备测试我们可以挂载并写入它。

#### 测试 GlusterFS

在这个测试场景中，我们将把 Gluster 卷安装到另一台服务器上。我们将执行一些写测试。然后我们将执行同样的写测试，并关闭我们装载 Gluster 的服务器。

我们要做的第一件事是安装 Gluster 客户端。现在，如果您打算将 Gluster 与 NFS 或 SMB (Samba)一起使用，您不必这样做。Gluster 客户端确实提供了一个很棒的特性，我们将演示这个特性。

CentOS 需要安装`glusterfs-fuse`包，Ubuntu 需要安装`glusterfs-client`。

现在我们将安装我们的 Gluster 卷。为此，我们发布了以下内容:

```sh
$ mount –t glusterfs au-mel-dfs-1:/vol1 /mnt

```

我们已经将 GlusterFS 卷安装到了我们的`/mnt`目录中。看一看`df`显示如下:

```sh
$ df -h /mnt
Filesystem           Size  Used   Avail  Use%    Mounted on
au-mel-dfs-1:/vol1   50G   33M    50G    1%      /mnt

```

如图所示，我们成功装载了 50GB 的卷。我们可以做一个写测试，看看是否可以向其中写入数据。为此，我们将使用一个`for`循环 bash 一行程序。它将在递增大小的挂载目录中的 100 个文件中写入零。

```sh
$ for a in {1..100} ; do sudo dd if=/dev/zero of=/mnt/datafile${a} bs=4096 count=$a ;done
....
100+0 records in
100+0 records out
409600 bytes (410 kB, 400 KiB) copied, 0.0287382 s, 14.3 MB/s

```

我们可以看到已经创建了测试数据文件，当查看`df`时，我们将看到所有主机都报告了其砖块的相同磁盘使用情况。

```sh
$ df -h /data/brick1_r1/
Filesystem      Size  Used Avail Use% Mounted on
/dev/sdc        50G   62M  50G   1% /data/brick1_r1

```

让我们做另一个练习。当您挂载 GlusterFS 卷时，Gluster FUSE 客户端将从一个对等体接收到一个`volfile`。然后，它将从列出的任何一个对等点装入卷，不一定是我们首先联系的那个对等点。这一次，我们将删除我们在`mount`命令中使用的主机`au-mel-dfs-1`，我们将看到在复制文件的过程中会发生什么。

```sh
$ while true ; do sudo cp /var/log/syslog /mnt/ ; date ; done
....
Sat Sep 17 15:09:05 UTC 2016
Sat Sep 17 15:09:05 UTC 2016
Sat Sep 17 15:09:05 UTC 2016
....

```

前面的命令说，让我们无限期地将`syslog`文件复制到`/mnt`,并在两次复制之间打印当前日期。每次复印后，你都会看到日期在屏幕上快速闪烁。同时，在`au-mel-dfs-1`上输入`reboot`命令。

```sh
$ sudo reboot

```

主机将立即重新启动。当这一切发生时，有两件事可能会发生。

如果我们的主机已经从`au-mel-dfs-1`装载了卷，您将会看到复制暂停。您可以看出我们暂停了，因为日期输出将停止增加。我们需要等待 Gluster 网络 ping 超时，或者主机重启，服务恢复。如果主机没有出现，网络 ping 超时，Gluster 客户端将请求访问`volfile`中的其他对等体之一，并尝试要求它需要的资源(文件锁等；这可能需要一分钟)。网络超时是可配置的，我们将很快向您展示如何更改它。一旦完成，我们将继续复制。

如果我们的主机从其他对等机之一装载卷，不会发生任何令人兴奋的事情，复制将继续。如果是这种情况，当`au-mel-dfs-1`出现时重新启动其他对等机，看看会发生什么。

#### 管理 GlusterFS

在这一节中，我们将向您展示如何管理 GlusterFS 服务器。我们想向您展示以下内容:

*   设置音量选项
*   扩展我们的存储
*   更换砖块

##### 设置配置选项

我们可以更改每个卷的选项设置。从更改`vol1`的集群卷配置开始，我们将把我们的网络 ping 超时从默认的 42 秒设置为 15 秒。这个设置告诉 GlusterFS 客户机，在放弃并从另一个 Gluster 对等体重新获取所有资源之前，应该等待 15 秒。这是一个昂贵的行动，我们真的应该尽可能地推迟这一行动。这里，仅作为演示，我们将向您展示如何更改它。

我们使用`gluster volume`子命令来更改卷上的选项。语法如下:

```sh
$ sudo gluster volume set <volume name> <option> <value>

```

因此，在我们的例子中，我们将发出以下命令来更改`network.ping-timeout`设置:

```sh
$ sudo gluster volume set vol1 network.ping-timeout 15

```

如果我们查看卷信息，我们现在会在`Options Reconfigured`部分看到我们的更改。

```sh
$ sudo gluster volume info
Volume Name: vol1
Type: Replicate
Volume ID: e9964568-feef-4f2f-a61d-14ba643b76e5
Status: Started
Number of Bricks: 1 x 3 = 3
Transport-type: tcp
Bricks:
Brick1: au-mel-dfs-1:/data/brick1_r1/vol1
Brick2: au-mel-dfs-2:/data/brick1_r1/vol1
Brick3: au-mel-dfs-3:/data/brick1_r1/vol1
Options Reconfigured:
network.ping-timeout: 15
performance.readdir-ahead: on

```

使用`volume set`子命令可以改变大量的配置选项；你可以在这里看到它们:

*   [T2`http://gluster.readthedocs.io/en/latest/Administrator%20Guide/Managing%20Volumes/#tuning-options`](http://gluster.readthedocs.io/en/latest/Administrator%20Guide/Managing%20Volumes/#tuning-options)

##### 扩展 GlusterFS 卷存储

当然，有时你需要扩大存储容量，而这正是 Gluster 的优势所在，相比之下，它的替代品就像普通的老 NFS。扩展选项归结为向现有对等体添加新的块，或者向卷中添加新的对等体和块。我们已经为现有的同行添加了一个新的 50GB 硬盘，并且我们将把它们添加到`vol1`卷中。

我们将创建另外三个 50GB 的驱动器，并将它们作为另一组驱动器添加到卷中。这将为我们提供总共 100GB 的可用存储空间，冗余系数为 3。我们将按照相同的说明制作第一块砖。

```sh
$ sudo mkfs.xfs -L brick1_r2 /dev/sdc && sudo mkdir -p /data/brick1_r2 && \
           sudo bash -c 'echo LABEL=brick1_r2 /data/brick1_r2 xfs defaults 1 2 >> /etc/fstab' && sudo mount –a
$ sudo mkdir /data/brick1_r2/vol1

```

在这里，我们创建并装载了新设备(在 CentOS 主机上的`/dev/sdc`),并在新设备上创建了一个`vol1`目录。这就像我们之前做的一样，但是我们已经将命令压缩成两行。现在，我们创建新的副本集，并将其添加到`vol1`卷。

```sh
$ sudo gluster volume add-brick vol1 replica 3  \
          au-mel-dfs-1:/data/brick1_r2/vol1  \
          au-mel-dfs-2:/data/brick1_r2/vol1  \
          au-mel-dfs-3:/data/brick1_r2/vol1
volume add-brick: success

```

我们现在已经将这些新砖块添加到了`vol1`卷中。如果我们运行`volume info`子命令，我们将看到我们有了一个新的副本集。

```sh
$ sudo gluster volume info
Volume Name: vol1
Type: Distributed-Replicate
Volume ID: e9964568-feef-4f2f-a61d-14ba643b76e5
Status: Started
Number of Bricks: 2 x 3 = 6
Transport-type: tcp
Bricks:
Brick1: au-mel-dfs-1:/data/brick1_r1/vol1
Brick2: au-mel-dfs-2:/data/brick1_r1/vol1
Brick3: au-mel-dfs-3:/data/brick1_r1/vol1
Brick4: au-mel-dfs-1:/data/brick1_r2/vol1
Brick5: au-mel-dfs-2:/data/brick1_r2/vol1
Brick6: au-mel-dfs-3:/data/brick1_r2/vol1
Options Reconfigured:
network.ping-timeout: 15
performance.readdir-ahead: on

```

如您所见，我们在卷中添加了三个新模块，即模块 4-6。您还可以看到，我们现在有两组三个磁盘，总共有 6 个磁盘(2 × 3 = 6)。查看我们在测试服务器上挂载的卷，我们可以看到该卷已经增加到 100GB。

```sh
$ df -h /mnt
Filesystem            Size    Used  Avail   Use%   Mounted on
au-mel-dfs-1:/vol1    100G    85M   100G    1%     /mnt

```

##### 更换砖块

我们是愚蠢的。我们刚刚清除了`au-mel-dfs-1`上的`/data/brick1_r2/vol1`目录。这现在将该砖块置于失败状态。我们可以从系统日志和`volume status`子命令中查看。

```sh
$ sudo gluster volume status
Status of volume: vol1
Gluster process                             TCP Port  RDMA Port  Online     Pid
--------------------------------------------------------------------------------
Brick au-mel-dfs-1:/data/brick1_r1/vol1        49152      0         Y       1292
Brick au-mel-dfs-2:/data/brick1_r1/vol1        49152      0         Y       3198
Brick au-mel-dfs-3:/data/brick1_r1/vol1        49152      0         Y       1978
Brick au-mel-dfs-1:/data/brick1_r2/vol1        N/A        N/A       N       N/A
Brick au-mel-dfs-2:/data/brick1_r2/vol1        49153      0         Y       11652
Brick au-mel-dfs-3:/data/brick1_r2/vol1        49153      0         Y       2133

```

如您所见，当前状态显示`au-mel-dfs-1:/data/brick1_r2/vol1`的服务没有监听端口，也没有 PID。我们要换掉它。我们向我们的 50GB 对等设备添加了另一个设备，并像扩展卷时一样对其进行了格式化和装载。

```sh
$ sudo mkfs.xfs  -L brick2_r2 /dev/sdd && sudo mkdir -p /data/brick2_r2 && \
         sudo bash -c 'echo LABEL=brick2_r2 /data/brick2_r2 xfs defaults 1 2 >> /etc/fstab' && \
         sudo mount –a
$ sudo mkdir /data/brick2_r2/vol1

```

现在，为了替换损坏的砖块，我们使用以下命令:

```sh
$ sudo gluster volume replace-brick vol1 au-mel-dfs-1:/data/brick1_r2/vol1 au-mel-dfs-1:/data/brick2_r2/vol1 commit force
volume replace-brick: success: replace-brick commit force operation successful

```

现在，我们可以看到卷状态的运行状况。

```sh
$ sudo gluster volume status
Status of volume: vol1
Gluster process                             TCP Port  RDMA Port  Online     Pid
---------------------------------------------------------------------------------
Brick au-mel-dfs-1:/data/brick1_r1/vol1      49152       0          Y       12252
...
Brick au-mel-dfs-3:/data/brick2_r2/vol1      49154       0          Y       2280

```

砖块已经被替换，我们可以从`df`命令中看到数据已经被同步到其中。

```sh
$ df -h /data/brick2_r2
Filesystem      Size  Used Avail Use% Mounted on
/dev/sde        50G   42M   50G   1% /data/brick2_r2

```

## 管理文档

文件共享是您公司分发文档的重要组成部分。然而，当涉及到跟踪和版本控制文档时，它确实有一定的局限性。如果在编写和检查权限方面没有过多的开销，您就不能很好地控制谁在访问您的文档。此外，您不能锁定正在编辑的文件，因此两个人可以访问同一个文件，分别进行更改，并且当一个用户将其保存回文件共享时，会破坏另一个用户的工作。很明显，仍然需要文件共享，但是有一种更好的方法来管理您企业中的文档。

一个好的文档管理系统(DMS)将理想地为你实现这五件事:

*   与其他员工安全地共享您的文档
*   为文档提供版本控制，这样以前的编辑就不会丢失
*   要求文档被签出，这样两个人就不能同时编辑同一文档
*   设计 DMS 的样式，使其符合您公司创建、审阅和发布文档的工作流程
*   为所有文档共享提供单一入口点，而不必管理多个文件服务器及其文件共享

有了一个好的文档管理系统，您通常会有一个 web 门户，成为所有文档访问的中心点。这可以是安全内部网的一部分，远程办公室通过虚拟专用网络(VPN)链接到您的主办公室来访问它。

### 使用文件管理系统

你的公司不需要成为一个大公司来拥有一个好的文档管理系统。在企业早期设计 DMS 时稍加考虑，随着企业的发展和对文档控制的需求越来越明显，将会为您省去许多问题。一个好的 DMS 不仅有助于工作流程，也有助于保护您的文档。为您的文档添加这种版本控制，您与同事共享的数据将更加安全。

当然，我们有在线文档管理，如 Google Docs、Quip 和 Microsoft360，这些可能正好满足您的需求。在许多情况下，使用这些解决方案非常适合没有基础设施且成本相对较低的小型企业。当然，文档是在线的(或部分在线的),因此可能会受到网络问题的影响，但一般来说，它们是非常安全的，高度可用的，而且成本很低。

有几个开源或部分开源的选择，你可能想试试。

*   alfresco:Community edition lgpl v3 许可证，与商业版相比功能有限
*   logical doc:Community edition lgplv 2 许可证，与商业版相比功能有限
*   OpenKM:社区版 GPLv2，与商业版相比功能有限

这些解决方案都有在线文档，如果需要，您可以购买支持。我们这样做是因为与 Samba 或 NFS 相比，这很可能是更好的文档管理选择。

## 打印服务器

在 CentOS 和 Ubuntu 上设置打印机服务器很容易。两种发行版都使用相同的打印服务器软件来管理打印服务。我们将向您展示如何设置 CUPS 打印机服务器，它是 Linux 发行版的标准，并且在 CentOS 和 Ubuntu 上都有一致的 web 界面。

在许多情况下，为打印设置 CUPS 服务器已经变得多余，因为许多现代打印机现在都有自己的打印服务器，并且可以在网络、Wi-Fi 甚至蓝牙上使用。此外，我们真的希望更少的人需要打印，因为在这个时代有许多其他方式来传输和阅读文件。

如果您仍然需要在网络上设置打印机(例如，您有一台 USB 打印机，并且希望在网络上的主机之间共享它)，您可以将它连接到 Linux 服务器，甚至连接到一个小的 Raspberry Pi 并使用 CUPS 打印服务器。

Note

树莓派有很多用途；其中之一是成为打印服务器。Raspberry Pi 是一种微型计算机，可以通过 USB 连接到打印机，并可以充当打印服务器。它通常带有 Raspberian 操作系统，这是一个基于 Debian 的 Linux 发行版。一个树莓派更适合用来学习！ [`https://www.raspberrypi.org/`见](https://www.raspberrypi.org/)。

### 杯子

首先，我们将向您展示如何配置通过 USB 连接到主机的新打印机。然后，您可以将其与网络中的其他主机共享。为了演示这一点，我们将把打印机连接到客户机。

#### 安装和配置杯子

您可以从命令行通过手动编辑 CUPS 配置文件来配置您的打印机(尽管不推荐这样做)。CUPS 还附带了一个 web UI，我们将使用它来添加和共享我们的打印机。

当您插入打印机时，内核将向 Udev 和硬件抽象层(HAL)管理器发送一个事件通知。Udev 是一个用户空间设备管理应用程序，HAL 为桌面程序提供了一致的接口。这意味着文字处理器等应用程序可以一致地知道如何使用打印机设备，日历可以使用一组一致的定义好的规则与智能设备对话。

让我们看看当我们在 Ubuntu 主机上插入 Epson USB 打印机时会发生什么。为了确保一切正常工作，首先我们在日志上发出`tail`命令，以确保我们的设备已经被内核拾取。

```sh
$ sudo dmesg
[13433828.652994] usb 2-1: new high-speed USB device number 4 using ehci-pci
[13433828.786834] usb 2-1: New USB device found, idVendor=04b8, idProduct=0811
[13433828.786847] usb 2-1: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[13433828.786855] usb 2-1: Product: USB2.0 MFP(Hi-Speed)
[13433828.786860] usb 2-1: Manufacturer: EPSON
[13433828.786865] usb 2-1: SerialNumber: L76010502151505100
[13433828.789721] usblp 2-1:1.1: usblp0: USB Bidirectional printer dev 4 if 1 alt 0 proto 2 vid 0x04B8 pid 0x0811
[13433828.790798] usb-storage 2-1:1.2: USB Mass Storage device detected
[13433828.791051] scsi9 : usb-storage 2-1:1.2
[13433829.790811] scsi 9:0:0:0: Direct-Access     EPSON    Stylus Storage   1.00 PQ: 0 ANSI: 2
[13433829.791627] sd 9:0:0:0: Attached scsi generic sg5 type 0
[13433829.795826] sd 9:0:0:0: [sdf] Attached SCSI removable disk

```

在这里，您可以看到我们的主机已经识别出我们已经连接了一个 USB 打印机，并将该设备注册为`usblp`。我们可以通过发出`ls /dev/usblp`来检查设备是否存在。现在，我们可以满足于我们的设备已被认可，并准备好添加到 CUPS 打印服务的控制之下。

我们首先需要在打印服务器上设置一些东西。我们需要添加一个管理用户来管理我们的打印设备的设置。这可以是任何用户，我们将通过将他们添加到`lpadmin`组来使`bsingh`成为我们的打印机管理员。

```sh
$ usermod –aG lpadmin bsingh

```

接下来，除非这个 CUPS 服务器在本地运行，否则我们将允许它被远程管理访问。

```sh
$ sudo cupsctl --remote-admin

```

现在，我们要确保它可以通过我们的打印服务器主机名到达。我们将编辑`/etc/cups/cupsd.conf`文件并添加以下内容:

```sh
LogLevel warn
PageLogFormat
MaxLogSize 0
Port 631
Listen print-srv.example.com
ServerAlias *

```

这里我们添加了`Listen`指令，允许它监听我们的打印机服务器接口，并添加了一个`ServerAlias *`，这样我们就可以使用`print-srv.example.com`主机名来连接到管理网页。

我们还应该添加主机名`print-srv.example.com`，并将其映射到我们的 DNS 服务器中的 192.168.0.1。

```sh
$ sudo nsupdate –k /etc/bind/dynamic-update-key
> server ns1.example.com
> update add print-srv.example.com 86400 A 192.168.0.1
> send
<ctrl d>

```

这里我们使用了`nsupdate`命令来添加我们的`print-srv.example.com`记录。我们现在应该重启我们的`cups`服务，并确保它在启动时可用。

```sh
$ sudo systemctl enable cups
$ sudo systemctl start cups

```

现在，我们可以转到 web 管理页面并添加我们的打印机。打开网页，进入网址 [`https://print-srv.example.com:631`](https://print-srv.example.com:631) 。由于我们没有安装有效的安全套接字层(SSL)证书，我们将收到该站点不受信任的警告。我们将接受这种风险，这将我们带到如下页面，如图 [13-5](#Fig5) 所示。

![A185439_2_En_13_Fig5_HTML.jpg](A185439_2_En_13_Fig5_HTML.jpg)

图 13-5。

The CUPS home page

在此页面中，我们将在管理员列的 CUPS 下单击添加打印机和类。系统将提示我们输入用户名和密码；我们将使用`bsingh`的证书(图 [13-6](#Fig6) )。

![A185439_2_En_13_Fig6_HTML.jpg](A185439_2_En_13_Fig6_HTML.jpg)

图 13-6。

Using the administrator’s credentials

在这里，我们将使用添加打印机按钮添加一台打印机(图 [13-7](#Fig7) )。

![A185439_2_En_13_Fig7_HTML.jpg](A185439_2_En_13_Fig7_HTML.jpg)

图 13-7。

Administration page for CUPS

单击“添加打印机”按钮会弹出我们的第一个打印机对话框。我们有一台通过 USB 连接到主机的本地 Epson 针式打印机，如图 [13-8](#Fig8) 所示。

![A185439_2_En_13_Fig8_HTML.jpg](A185439_2_En_13_Fig8_HTML.jpg)

图 13-8。

Selecting the USB printer

您还会注意到，我们可以添加其他类型的网络打印机，包括通过 Samba 服务器进行打印。您可以在这里看到如何设置 Samba 打印机共享:

*   [T2`https://wiki.samba.org/index.php/Setup_a_Samba_print_server`](https://wiki.samba.org/index.php/Setup_a_Samba_print_server)

我们现在被问了一系列关于打印机的问题。我们被要求给出打印机的名称、描述和位置。这些可以是对你有意义的任何东西。我们将启用这台打印机的共享并允许色彩管理，如图 [13-9](#Fig9) 所示。

![A185439_2_En_13_Fig9_HTML.jpg](A185439_2_En_13_Fig9_HTML.jpg)

图 13-9。

Printer information

然后我们被询问更多信息，这次是关于打印机的型号。我们将从下拉列表中选择(图 [13-10](#Fig10) )。

![A185439_2_En_13_Fig10_HTML.jpg](A185439_2_En_13_Fig10_HTML.jpg)

图 13-10。

Selecting the printer model

如果找不到打印机型号，我们可以添加一个 PPD 文件。接下来是打印机默认值(图 [13-11](#Fig11) )。

![A185439_2_En_13_Fig11_HTML.jpg](A185439_2_En_13_Fig11_HTML.jpg)

图 13-11。

Editing or selecting defaults

您可以编辑或选择打印机的默认值。我们将只保留默认值(图 [13-12](#Fig12) )。

![A185439_2_En_13_Fig12_HTML.jpg](A185439_2_En_13_Fig12_HTML.jpg)

图 13-12。

Ready and waiting for jobs

我们的打印机现在可以打印了。我们现在将它附加到一个客户端。在我们的 macOS 客户端，我们可以再次选择我们的打印机并添加它(图 [13-13](#Fig13) 和 [13-14](#Fig14) )。

![A185439_2_En_13_Fig14_HTML.jpg](A185439_2_En_13_Fig14_HTML.jpg)

图 13-14。

The printer is installed and ready

![A185439_2_En_13_Fig13_HTML.jpg](A185439_2_En_13_Fig13_HTML.jpg)

图 13-13。

Bonjour finds our print server

现在我们的打印机已经安装好，可以打印了。

## 摘要

在这一章中，我们探讨了 Linux 的文件和打印共享产品。我们展示了文件共享的传统方法是通过 Samba 服务器和 NFS 服务器，这取决于您想要服务的客户端。我们向您展示了如何使用 GlusterFS 建立可以扩展到 Pb 大小的数据存储。我们讨论了传统文件共享的替代解决方案，如文档管理服务(DMS)。与文件共享相比，它们有许多优势，因为它们提供了更细粒度的访问控制和文档版本控制，并且允许您实现公司工作流。最后，您学习了如何设置 CUPS 打印服务。

在本章中，您学习了如何执行以下操作:

*   将 Samba 服务器配置为 AD 域控制器
*   配置 NFS 服务器以在 Linux 主机之间挂载文件系统
*   安装和配置 GlusterFS
*   谈论 DMS
*   配置 CUPS 打印机服务器并将其连接到主机

在下一章中，我们将看看您办公室的备份和恢复。