# 十、维护任务和计划

任何 Linux 系统管理员都会熟悉 Linux 资产所需要的可怕的维护。在本章中，我们将讨论在管理 Linux 资产时应该做的各种维护工作。我们将了解应该完成哪些实际维护工作，应该在何时运行维护作业，以及如何计划维护以使停机时间最少。

本章还将简要介绍如何同步维护任务和官僚任务，以减少日常维护有时会带来的总体痛苦。最后，我们将讨论如何使用自动化来改善所有相关人员的整体维护体验。

## 应该做哪些保养

在 Linux 服务器上应该进行一些检查。有些可能不需要在每个维护周期进行，但有些需要尽可能经常进行。有时你甚至需要运行紧急维护。

Note

为了确定维护是否至关重要，请注意您对潜在问题迹象的监控。这方面的例子可能是磁盘即将被填满。

### 修补

维护的首要原因是打补丁和系统更新。这一过程的重要性怎么强调都不为过，也绝不能忽视。修补不仅包含软件包更新和修复，还提供漏洞补救。

#### 脚手架

在确认当前一轮更新不会破坏任何东西之前，修补您的生产/现场或面向客户的环境从来都不是一个好主意。

这就是为什么应始终采用分阶段修补方法的原因。确定修补环境的顺序，并分阶段进行修补。

图 10-1 是我过去经常使用的配线订单示例。

![](img/518154_1_En_10_Fig1_HTML.jpg)

图 10-1

修补顺序

#### 沙箱

从沙盒类型的环境开始，至少有一个系统运行与您的生产环境相似或接近相同的应用程序。这种环境不应该面向用户，也不需要变更控制批准。整个环境应该是一次性的和自动化的。沙盒是您的环境，用来证明配置不会在其他环境中引起问题。

#### 自动化测试

如果可能，利用自动化测试来证明更新或补丁配置没有破坏测试应用程序的功能。有许多开源和专有的选项可用于自动化应用程序测试。与您组织的开发人员交流，或者联系为您提供应用程序的人员。他们很可能会建议你应该使用什么。

这里有一些选项，你也可以看看，可能会有所帮助:

*   硒

*   加泰罗尼亚工作室

*   Appium(用于移动应用程序)

*   机器人学

#### 自动修补

如果您的修补过程计划得很好，并且平台测试可以自动化，那么就没有什么可以阻止您自动化实际的修补工作。

利用自动化工具，如 Ansible Tower 或 Jenkins 或任何允许您运行阶段或工作流的工具。这样，您可以分阶段运行以下内容:

*   预检

*   确认故障转移已经发生

*   修补操作系统文件

*   重新启动

*   自动化测试

##### 反转

如果检测到问题，管道或工作流工具也可以应用回滚，确保当维护窗口关闭时，不会留下任何有问题的状态。自动化是伟大的，但是内置同样多的风险管理将使您不必解释为什么环境被您的自动化破坏。

Hint

您希望确保尽可能多地降低风险，以确保您的自动化不会因系统停机而受到指责。这让你的生活变得更容易，应该避免反对者。

### 文件系统

如果没有很好地维护，随着时间的推移，有一个领域可能会增长并引起关注，那就是您的文件系统。文件系统不仅存储日志，还存储用户留在主目录中的文件。在文件系统成为问题之前关注它们对于避免可预防的停机至关重要。

#### 清除

在系统维护期间，浏览以下不同的文件系统并检查是否有不再需要的文件绝对是值得的。建议删除这些文件和任何临时文件。

#### 检查错误

一旦您检查了未使用的文件并尽可能地清除了这些文件，那么运行文件系统健康检查就非常值得了。这将有助于识别任何潜在的问题，以免它们成为下一步的问题。

#### 文件系统检查命令

表 10-1 中的命令在运行文件系统维护或通常希望解决磁盘问题时非常有用。

表 10-1

基本文件系统检查命令

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"></colgroup> 
| 

Linux 命令

 | 

描述

 |
| --- | --- |
| `du -k /var/log &#124; sort -n &#124; tail -10` | 检查目录中最大的十个文件 |
| `find . -type f -size +100M -ls` | 在当前目录中查找任何大于 100MB 的文件 |
| `find /var/log -mtime +90 -ls -exec rm {} \;` | 找到任何超过 90 天的文件并删除它们 |
| `tar -zcvf var_log.`date +%Y%m%d`.tar.gz /var/log/*.log` | 在/var/log 目录中创建一个包含所有日志文件的 tar 文件 |

### 防火墙

防火墙检查只是为了确保没有意想不到的新规则进入您的 Linux 系统。从技术上讲，这些应该由配置管理工具来管理，但是在没有运行的 SaltStack 或 Puppet 的情况下，检查防火墙是一项快速而简单的任务。在维护窗口期间这样做只是意味着您可以删除任何不需要的更改，前提是您被任何更改控制所覆盖。

Important

设计平台的内部架构师应该始终推荐防火墙规则。如果出现了任何没有意义的规则，请参考原始设计来确认它们应该存在。

### 备份

这个真的不用说了。对于任何无法通过代码重建的系统，都应该在可接受的时间范围内进行备份。虚拟机可以完整备份，但物理系统需要根据服务器的功能备份特定的目录。

在维护窗口期间，仔细检查所有备份是否都已运行，以及最近的备份是否到位。

Important

在修补系统或对系统进行任何可能会使您处于停机状态的操作之前，请确保您有一个可从中恢复的最新备份。

您的房产应该多久进行一次维护取决于几个因素:

1.  您希望多久修补一次您的环境？

2.  您是否遇到过磁盘已满或磁盘损坏的问题？

3.  您的平台上是否出现了意想不到的配置？

前面两点表明你的房产有比维护更大的问题；在试图解决症状之前，建议先解决这些问题。

### 尽可能经常

应该定期执行的明显任务是打补丁。修补周期取决于组织的策略，可以是每 7 天或每 90 天。在我看来，90 天太长了，应该缩短到至少 30 天，但这也太长了一点。

如果让您来做决定，我会建议尽可能频繁地打补丁。应使用自动化，并通过定期维护帮助减少人为因素。通过运行非常定期的维护和修补程序，您可以降低新发现的漏洞可能带来的任何风险。

#### 没有测试就没有实时修补

定期修补还允许您使用分阶段的方法进行修补，从而减少未经测试的配置或更新可能出现的问题。

#### 结构

通过为每个环境建立一个定期维护窗口，您可以计划和组织如何应用和测试更新。这样做，您就大大降低了您的实际环境中出现问题的可能性，包括错误和漏洞。

## 应该如何进行维护

很简单，自动化维护是当今的发展方向。在我们维护和构建平台的过程中，需要减少人为因素。这是你能真正扩展的唯一方法。让一个人或一个团队来运行维护是疯狂的，更不用说维护是否会像应该做的那样定期进行。

### 自动化

我相信我提到自动化的次数已经足够多了，以至于你们已经厌倦了这个术语，我也相当有信心你们大多数人现在已经在自动化了。

显而易见，自动化维护和自动化构建过程一样重要。以下是您应该自动化的项目:

*   备份

*   修补

*   磁盘清理

*   磁盘检查

*   防火墙和 SELinux 配置

*   软件删除

前面的几项应该由配置管理工具来管理，但是如果您没有使用任何工具，那么您的维护自动化应该会处理它们。

您的自动化也应该按照类似于以下的顺序运行:

1.  检查并确认最近进行了备份。

2.  应用任何系统更新。

3.  运行自动化测试以确认更新没有破坏任何东西。

4.  磁盘清理

5.  配置检查。

6.  如果测试失败，回滚更新。

7.  更新监控或生成报告以反映状态。

### 零停机环境

如果您的环境被认为是关键的，并且能够承受零停机时间，那么您将需要在蓝/绿风格的部署中运行多个数据中心或每个站点的多个环境。

#### 蓝色/绿色

这种方法包括将流量转换为蓝色或绿色，然后修补非实时环境。

如果您愿意，蓝/绿方法确实让您能够直接更新到您的实时环境中，因为从技术上讲，您并没有更新“实时”端。如果您做了所有的尽职调查，并确保您修补的环境在切换回来之前 100%运行，您应该不会遇到宕机。

一旦您完成了一侧的维护，您可以将相同的维护应用到第二侧。因为你已经证明了没有问题，你应该完全可以继续你的第二个网站。

我个人仍然建议采取分阶段的方法，但是如果你时间紧迫，你至少可以切换回第二个环境。

#### 故障切换

运行多个数据中心是减少单点故障的另一种常用方法。将实时流量转移到第二个数据中心将允许在实时流量不停机的情况下进行维护。

在回切到主数据中心和修补辅助站点之前，应该应用相同的维护原则。

## 维护计划

执行和计划一样好。对于任何维护计划，都有一些重要的事情需要考虑。

### 同意维护窗口

为每个环境的维护找到一个固定的时间段。自动化官僚主义的繁文缛节，以确保维护可以在这些定期运行。通过为您的组织寻找和规划一个已知的时间段，您将始终能够应用更新和更改，而无需每次都争论原因。

这并不意味着您必须每次都运行维护，您只需要在需要时自由地进行维护。

如果你已经自动化了这个过程，那就更好了。然后，您的环境可以不断保持最新状态并尽可能平稳地运行，减少不断修复问题的需要，让您有更多时间专注于更令人兴奋的事情。

### 一口大小的块

如果你有大量的维护工作要做，并且还没有自动化这个过程，把你的维护工作分成小块。宁可运行多个小维护窗口，也不要运行一个大窗口。

Remember

疲惫的眼睛对任何人都没有帮助。

#### 评估的艺术

在计算完成一项任务所需的时间时要小心。宁可高估早完成，也不要低估，给自己压力。向其他 Linux 系统管理员寻求帮助，在计划时估算时间。

## 将流程和任务一起自动化

自动化不仅仅是技术任务的实现。今天，在你的组织中自动化“繁文缛节”过程也是可能的。

在系统维护的情况下，这个功能可以很好地与任务自动化结合起来。所有批准都可以自动化，并输入到您的技术自动化平台，以便在维护窗口到来时继续进行。你不仅不必再做手工的技术实现，还可以避免官僚主义的工作。

### 工序自动化

现在有一些不同的产品和项目可以帮助您自动化流程，但是值得一提的是 Red Hat Process Automation Manager，或者 PAM。

#### 红帽子帕姆

Red Hat PAM 提供了自动化业务流程和决策的工具。通过使用高级业务规则和流程引擎，以及复杂的事件处理和案例管理，Red Hat PAM 可以帮助解决复杂的计划和调度问题。PAM 利用 Drools 的全部功能，Drools 是一个强大的、广泛使用的开源规则引擎。通过使用内置的规划求解工具，PAM 甚至可以帮助解决复杂的优化问题。

像大多数其他 Red Hat 产品一样，Red Hat PAM 的上游项目是 jBPM 项目，这是一个完全开源的产品，可以在社区支持下使用。

Warning

Red Hat PAM 是您需要用来开发流程任务的工具，就像您在自动化技术任务时使用 Ansible 一样。

## 摘要

在本章中，向您介绍了以下内容:

*   Linux 系统需要做哪些维护

*   何时应该运行 Linux 维护

*   零停机运行维护的方法

*   如何规划 Linux 维护

*   如何将维护流程和技术任务一起自动化