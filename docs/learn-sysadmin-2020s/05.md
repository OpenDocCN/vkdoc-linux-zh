# 五、自动化

这是第一章，我们将针对一个特定的学科，自动化。

在这一章中，我们将成百上千地钻研操纵系统的黑暗艺术。我们将讨论什么是最好的工具，以及为什么应该使用或避免使用它们。我们将了解这些工具之间的不同之处，以便您能够做出明智的决定，选择最适合您的工具。然后，我们将了解这些产品的市场趋势，以及为什么有些人更喜欢其中一种工具。

本章从总体上讨论自动化，并不关注某个特定的产品。这个想法是为了理解自动化的概念，以及如何以最好的方式应用它们。我们将讨论诸如“什么时候应该自动化，什么时候不应该自动化”之类的话题我们将探索使用自动化技术，以及何时应该这样做。

最后，我们将结束讨论最佳实践和使用 shell 脚本的章节，其中我们将讨论可以使用的不同 shell 脚本语言。

## 理论上的自动化

对于大多数阅读本文的人来说，自动化应该不是什么新鲜事。在我们过去所做的事情中，总是存在某种形式的自动化，无论是定制的 shell 脚本还是一些计划开始一项工作的管理工具。

随着新的工具和自动化平台的开发，自动化在过去十年中有了很大的发展。使用从 cron 作业中执行的定制脚本的日子即将结束，如果不是已经结束的话。复杂的自动化解决方案现在管理着从系统构建到自我修复系统的一切。

自动化也不仅仅是技术性的。大多数组织现在都在寻找自动化业务流程及其技术资产管理的解决方案。建立自动化来创建变更请求或提高支持票越来越成为一种需求，而不是一种奢侈。节省的时间和精力让更多的组织意识到，没有全栈自动化意味着与竞争对手保持同步的灾难。

### 幂等码

所有自动化应该坚持的第一件事是确保编写的代码是等幂的。这实际上意味着，只有当状态与自动化平台要求的状态不匹配时，代码才会做出更改。

这方面的一个例子是更新系统包。如果系统安装了已经是最新版本的软件包，那么除了确认软件包是所请求的版本之外，您不会希望自动化任务做任何事情。除了确认包的状态之外，不做任何事情，系统保持不变。如果软件包需要重新启动服务，软件包的重新安装或更新可能会导致轻微的中断。这可能是一个糟糕的例子，因为句柄也可以用来确保没有中断。

在编写自动化代码时，请始终记住:

"我的代码是幂等的吗？"

### 知道何时以及何时不要自动化

编写自动化代码时，一半的战斗是知道什么应该自动化，什么不应该自动化。我的一般经验是在某个时候自动完成我要重复的任何事情，这在我的工作中是常有的事。

只为可重复的任务编写自动化似乎是显而易见的，但是编写自动化来构建只需要一次的东西呢？如果没有想清楚你为什么这么做，这可能是一件坏事，但也可能是完全有意义的。

“在花了那么多时间让您的自动化工作起来之后，您本可以自己手动安装系统，从而节省大量时间。”

这可能是你的经理在发现你为一个只会构建一次的东西编写代码时会对你说的典型的话。

您应该跟进的论点是，为什么自动化只会使用一次的东西是因为您正在从代码中构建资产，并且您正在为灾难事件中可能的重建做准备。

根据 Gartner 的调查，不进行自动化的组织的客户保持率可能会下降 25%。自动化正在各地迅速发展，如果您或您的组织落后了，您就有被竞争对手超越的风险。

为了充分理解什么时候自动化，什么时候不自动化，让我们看看支持和反对自动化的一些理由。

#### 自动化的理由

今天，自动化应该是默认的；不过，如果你需要理由，这里有几个值得一提:

*   可重复和可预测的构建

*   基础设施作为代码

*   代码作为文档

*   节省时间和成本

*   组织文化变革

*   降低风险

*   鼓励创新

#### 不自动化的原因

今天很难想出不自动化任何东西的理由，但有时有理由，即使不是很好的理由:

*   一个永远不会重复的任务。即便如此，也有理由实现自动化。

*   组织尚未成熟到接受自动化。

*   没有可用的技能或培训时间。

以上这些都不是很好的理由，只是我个人认为更多的借口。财产管理和财产建设的世界正在迅速变化，不应该选择自动化。作为 Linux 系统管理员，不管我们喜欢与否，我们的工作已经发生了变化。我们不再是 Linux 系统管理员，我们现在是自动化工程师。

### 状态管理

了解不同自动化平台的另一个非常重要的事情是它们管理系统状态的能力。一些平台仅在为特定任务执行代码时检查状态，而其他平台不断检查它们管理的系统的当前状态，以查看是否有任何改变。当检测到状态改变时，配置被更新以匹配自动化平台的期望状态。

Tip

使用基于期望状态不断检查系统状态的平台将确保您运行一个保持标准的环境。当不同的人可能会对系统进行可能导致系统中断的更改时，这非常有用。这种方法也将减少配置漂移的机会。

## 自动化工具

我们都同意自动化不会很快消失，为了不落后，了解您应该使用什么工具是很重要的。采用自动化实践将需要一套您需要学习的工具和开发语言；使用哪一种将需要您做出明智的决定。

在接下来的几页中，我们将讨论目前可供您使用的不同选项，并讨论它们的优缺点。

### 自动化脚本语言

在我们开始研究不同的工具之前，有必要了解可用于编写自动化代码的不同类型的自动化脚本语言:YAML、Ruby、Python 和 shell 脚本。

#### 亚姆

“YAML 不是标记语言”是 Ansible 和 SaltStack 等自动化平台使用的主要语言。YAML 是最容易学习的脚本语言之一，因为大部分语法都很容易理解和记忆。

#### 这些不是你要找的空间

YAML 因抱怨格式化而臭名昭著，当人们第一次学习用 YAML 编码时，格式化是一个令人烦恼的领域。缩进需要 100%正确，否则你的代码不会运行。

YAML 不喜欢使用制表符，只接受缩进的标准空格字符。大多数编辑器中的制表符被替换为相应数量的空格，以使这个过程看起来像使用了制表符值。

#### YAML 在行动

下面两个例子使用了流行的自动化平台 Ansible 和 SaltStack。两个示例提供了相同的结果，即安装“httpd”包。

##### 安塞波

```sh
---
- name: "Build Linux Web server"
  hosts: webservers
  become: true

  tasks:
  - name: "Install latest apache httpd package"
    ansible.builtin.yum:
      name: httpd
      state: latest

```

##### 盐堆

```sh
websetup:
   pkg:
      - installed
      - pkgs:
         - apache2

```

这些示例使用相似的格式，并且缩进方式非常相似。从这些例子中，逻辑很容易理解，也很容易操作来安装其他包。这些例子使用了提供的一个基本的包模块，但是还可以使用许多其他模块来做更多的事情。快速的谷歌搜索通常会让你找到最新的文档。

#### 红宝石

Ruby 是一种高级通用编程语言，被设计成真正的面向对象语言。Ruby 在处理实例变量的方式上与 Perl 和 Python 类似。Ruby 将这些变量保持为类私有，只通过像“attr_writer”或“attr_reader”这样的访问器方法来公开它们

下面是 Ruby 代码的一个基本例子。除非你需要写一个新的函数或者类似的东西，否则你很少会为自动化任务写 Ruby 代码:

```sh
#!/usr/bin/ruby
def build(opt1 = "Linux", opt2 = "Windows")
   puts "The system that will be built is #{opt1}"
   puts "The system that will be built is  #{opt2}"
end
build

```

下面是一个木偶模块代码的例子。Puppet 包括两个用于编写定制函数的 Ruby APIs。puppet 模块的内容远不止以下这些，但为了让您对代码有一个基本的了解，我认为值得看一个示例:

```sh
class helloworld (
  $file_path = undef
){
  notify { "Hello world!": message => "I am in the ${environment} environment"}
  unless $file_path == undef {
    file{ $file_path :
      ensure    => file,
      content  => "I am in the ${environment} environment",
    }
  }
}

```

#### 计算机编程语言

Python 以几种方式用于自动化任务。您可以使用 Python 编写自己的脚本，就像编写 Ruby 或任何其他脚本语言一样。然而，Python 倾向于主要用于 Ansible 和 SaltStack 之类的模块或函数。下面是一些基本 Python 代码的片段。

```sh
# Python Module example
def add(x, y):
   """This application returns the result of x + y"""

   result = x + y
   return result

print("The value of my python function is", add(3,4))

```

#### Shell 脚本

Shell 脚本可以用于自动化，但不推荐使用，主要是因为其他自动化语言和工具有如此丰富的模块，可以通过它们的 API 连接到大多数平台。

默认情况下，Shell 脚本作为一种幂等脚本语言并不能很好地工作。实现幂等性意味着相当多的额外编码。

Note

如今，通常编写的大多数自动化代码都是针对 Ansible 和 SaltStack 等平台的 YAML。其他变体是 Ruby 类型的木偶和厨师代码。埋头写 Ruby 或 Python 模块并不常见。

## 自动化平台

有了自动化脚本语言的基本概念后，现在有必要讨论一下您可以使用的一些自动化工具，这些工具利用了前面讨论过的脚本语言。

### 财产管理工具的自动化

在第 [4](04.html) 章中，我们谈到了 Linux 平台管理工具，我提到了一些内置的自动化工具。过去，在大多数情况下，自动化设施未能提供足够的功能，因此不能被视为完全的自动化平台。现在有例外，更新的管理工具，如 Uyuni，包括使用 SaltStack。SaltStack 的多少功能还有待测试。

然而，要解决像 Red Hat Satellite 这样的遗产管理工具可能缺少自动化功能的问题，建议您考虑使用一个自动化平台，专门管理您所有的遗产自动化需求。这些平台应该包括所有的功能，让你完全自动化你的遗产。

#### 使用理由

*   已经到位

*   没有其他工具的预算

*   技能已经到位

*   节省时间

*   有一个很好的集成自动化工具，有足够的特性可以开始使用

#### 不使用的理由

*   有限的功能

*   增加了复杂性

*   要求与 RBAC 分离

### Ansible 自动化平台

Ansible 毫无疑问是市场领先的自动化工具的有力证明，至少在我写这本书的时候是这样。Ansible 在过去几年的发展令人印象深刻，每天都受到越来越多的用户和组织的欢迎。社区的发展和供应商们为 Ansible 创建模块的广泛采用继续证明了为什么许多人选择 Ansible 作为自动化工具的选择。

不去预测未来，我坚信 Ansible 还会存在一段时间。我这样说的原因有几个:

1.  2015 年 10 月收购 Ansible 的红帽完全支持 Ansible 及其开发。每时每刻都在不断改进，显然他们对未来有着宏伟的计划。

2.  Ansible 的学习曲线比同一领域的其他产品要宽容得多。人们只是更喜欢用一些不需要硕士学位就能理解的东西。

3.  随着越来越多的供应商不断提供新的模块，社区的采用几乎与日俱增。

#### 无代理

Ansible 不需要任何代理来管理其客户端系统。在基于 Linux 或 Unix 的系统上，通过 ssh 与客户端系统建立连接；如果连接到 Windows 系统，则通过 WinRM 建立连接。可以通过在执行 Ansible 时输入系统密码或使用 ssh 密钥来进行身份验证。大多数 Linux 系统管理员倾向于使用 ssh 选项，主要是因为到 Linux 或 Unix 系统的连接是无缝的，不会提示输入密码。如果您在一百个系统上运行剧本，这可能是一个大麻烦。

如果 ssh 密钥不可行，那么可以使用其他选项，但是这需要所有系统在一个中心位置进行身份验证。否则你将不得不为不同的系统输入不同的密码。

#### 潜在的安全漏洞

如果 ssh 密钥没有得到正确的管理，那么 Ansible 环境中的资产可能会存在一个很大的安全漏洞。例如，如果一个 Linux sysadmin 在他们的系统上有 ssh 密钥，可以访问资产中的任何系统，那么如果有人未经授权访问他们的系统，就有可能出现大问题。因此，需要非常小心地确保该系统的安全性。例如，使用系统库可以降低这种风险。

#### 使用 Ansible

Ansible 有企业版和社区版。企业和社区产品都有两种可以安装的 Ansible。有可以使用的图形界面和命令行版本。

##### 命令行

在第 2 章中，我们简要讨论了如何安装和使用 Ansible 命令行工具。我们讨论了与通过 pip 安装相比，使用像 Yum 这样的包管理系统安装有哪些额外的好处。我们还讨论了如何运行一些基本命令。

Ansible 命令行通常被称为 Ansible Core，但是命名可能会改变，如果还没有改变的话。Red Hat 一直在努力让 Ansible 变得更好，并一直在研究如何使用 Ansible 或将其与其他产品集成；出于这个原因，名称可能会改变以适应使用。

有一点要记住:如果你选择只使用 Ansible 的命令行版本，从功能的角度来看，使用社区版还是企业版并没有太大的关系。据我所知，这两种产品的功能是一样的。如果你需要帮助，最大的问题是支持。

Recommendation

使用 Ansible 的图形化工具是推荐的方法，主要是因为您在功能上不容易用命令行工具复制。

#### 图形用户界面

Ansible 吸引新用户的似乎是可以与 Ansible 自动化平台一起使用的图形用户界面。和任何流行的东西一样，开发人员关注用例并根据需求进行调整。因此，Ansible 的新版本更有可能是由图形工具驱动的，而不是命令行。因此，当前的 Ansible Tower 工具是第一次学习 Ansible 时推荐的方法。

##### 使用 Ansible 的理由

*   易于学习和入门

*   拥有大量可用代码资源的不断增长的社区

*   优秀的文档和示例

*   能够管理任何可以打开远程连接的内容

*   灵活的

*   可攀登的

*   企业支持

*   正在开发的新功能可能无法在 AWX 上市

##### 不使用 Ansible 的理由

*   如果你不需要企业级产品，这个可能不适合你。

*   如果您用很少的预算监控数千个系统，Ansible Tower 许可费用可能会很高。

*   如果您要管理的系统数量较少，则可能不需要。

*   SSH 密钥安全相关问题。

*   在执行任务之前缺乏对系统状态的了解。

#### 经编毛圈提花布

红帽收购 Ansible 的时候，Ansible Tower 还没有开源。为了纠正这一点，Red Hat 开发人员和工程师尽快开发了开源的 Ansible Tower。由此产生的产品是 AWX 项目。

除了一些企业功能外，AWX 几乎与它的企业对等物(Ansible Tower)相同。一个例子是基于角色的认证已经从社区版本中排除。如果用户需要这些功能，他们需要购买一个 Ansible Tower 许可证。

##### 使用 AWX 的理由

*   易于学习和入门

*   拥有大量可用代码资源的不断增长的社区

*   优秀的文档和示例

*   能够管理任何可以打开远程连接的内容

*   免费的社区产品

*   灵活的

##### 不使用 AWX 的理由

*   如果您需要企业功能，您将需要考虑 Ansible 自动化平台或其他产品。

*   在 AWX 上做的测试和工作比在安塞布尔塔上做的要少。

*   不建议用于生产环境。

*   并不是 AWX 所有的安全设施都像安西布尔塔一样通过了安全检查。

*   不支持版本之间的直接就地升级。

*   SSH 密钥安全相关问题。

*   在执行任务之前缺乏对系统状态的了解。

#### 盐堆

另一个可以使用的基于 python 的配置管理工具是 SaltStack。SaltStack 有社区版本和企业支持版本。

#### 服务器到客户端的通信

与 Ansible 不同，SaltStack 可以配置为在连接到它管理的系统时以几种方式运行:

*   直接 SSH

*   代理和服务器

*   只有代理，没有管理服务器

#### 远程执行

与 Ansible 连接到系统并运行特定命令的方式类似，SaltStack 能够执行远程执行命令。这种功能与卫星服务器目前的功能和太空行走服务器过去的功能非常相似。

#### 结构管理

SaltStack 在配置管理方面比过去更传统一些。在 SaltStack 主服务器上管理配置，并将其推送到已更改或需要更新配置的系统。SaltStack 主系统通过了解系统需要的状态和主系统正在监控的附属系统上已经触发的事件来控制其管理的客户端(附属系统)的状态。如果有任何不应该更改的内容，盐栈主服务器会恢复未经授权的更改。

#### 使用消息总线

Salt 使用了不同于其他产品的方法，因为它使用了消息总线 ZeroMQ。当客户端系统或附属程序触发事件时，会在消息总线上创建一条消息，供主服务器在准备就绪时执行。这种使用消息总线的方法允许一个主机管理大量的系统。

##### 使用 SaltStack 的理由

*   不那么陡峭的学习曲线。

*   模块化方法。

*   非常灵活。

*   可扩展。

*   在规模上表现良好。数以千计的奴才可以同时管理，效率相当高。

*   事件驱动的配置管理。

*   比其他产品更安全。

*   功能丰富。

##### 不使用盐堆的理由

*   由于较慢的发布周期，它可能不适合快速移动的环境。

*   过去曾有过模块不能管理自己的依赖关系的问题。要求用户运行单独的虚拟环境。

*   不是对非 Linux 系统最好的支持。

*   安装和配置可能更具挑战性。

*   文档可能难以理解和使用。

#### 木偶

Puppet 是一个基于 Ruby 的配置管理系统，在引入 Ansible 之前使用得比较多。

##### 红帽和木偶

Satellite 6.x 首先使用 Puppet 进行配置管理，但后来引入了使用 Ansible 的选项。puppet 还没有被移除，对于那些投入大量时间开发 Puppet 模块的用户来说仍然可用，但是不应该想当然地认为 Puppet 在 Satellite 中的可用性会永远存在。

##### 基于服务器代理

Puppet 需要一个傀儡主人来管理它所管理的所有系统的状态。所有的客户端都需要有一个代理运行，以检查傀儡主人。

##### 潜在的低采用率

像 Ansible 和 SaltStack 这样的产品为用户带来了不太陡峭的学习曲线，并对像 Puppet 和 Chef 这样的产品构成了强大的威胁。更糟糕的是，Red Hat 已经开始在尽可能多的产品中引入 Ansible，以进一步推动 Ansible 的普及。SaltStack 也包含在 SUSE 和 Ubuntu 使用的新版太空行走克隆中。这些发行版和它们各自的管理软件的流行对 Puppet 来说不是好兆头。

##### 企业和社区

Puppet 有社区和企业两个版本，可以满足所有用户的需求。企业支持适用于出于合规性或法规原因需要支持协议的企业组织，也有适用于不需要支持的用户的社区版本。

##### 使用木偶的理由

*   基于状态的配置管理。客户端不断地向 Puppet masters 登记配置更改。

*   出色的社区支持。现成的示例代码。

*   安装是无痛和简单的。

*   几乎可以在所有操作系统上运行。

*   幂等平台。

##### 不使用木偶的理由

*   Ruby 支持在下降。

*   基于 Ruby 的命令行界面。

*   陡峭的学习曲线开发定制木偶模块。

*   代码可能很复杂，令人费解。

*   比其他产品更少的控制。

#### 厨师

大概 Puppet 后面配置管理使用最广泛的产品之一就是 Chef 了。Chef 是一个类似 Puppet 的基于 Ruby 的产品，在服务器代理架构中工作。Chef 最初是专有组件和开源组件的混合体；然而，自 2019 年 4 月以来，Chef 宣布他们将开放 Chef 的所有资源。忠于他们的工作，今天在撰写本文时，Chef 有一个社区版本的配置管理工具可供下载和使用。

##### 使用 Chef 的方法

Chef 目前有三种方式供用户使用他们的自动化平台。

###### 托管服务

Chef 为不希望构建任何内部系统的组织或小型企业提供托管服务。任何托管服务都会涉及额外的成本。

###### 内部部署

对于拥有封闭网络或希望完全从内部管理其资产的组织，Chef 确实提供了自行下载和安装基础架构的能力。如果您需要支持，则需要额外的成本，并且定价模式已经从系统价格转变为每月管理的每个节点的价格。

###### 社区

由于 Chef 现在是开源的，Chef 的社区开源版本可供下载和使用，但带有不支持的标准警告。

##### 使用 Chef 的理由

*   与 Git 的良好集成

*   网上有大量的社区模块和食谱

*   灵活的

*   减少安装复杂性的可用工具

*   类似 Puppet 的基于状态的配置管理

##### 不使用 Chef 的理由

*   Ruby 支持在下降。

*   新用户的陡峭学习曲线。

*   没有推送功能。

*   文档不如其他产品好。

*   如果使用大型资产，企业支持和内部成本可能会增加。

*   不适合拥有小房产的组织。

### 做决定

如果您是自动化的新手，决定使用什么自动化工具可能会很困难。以下是一些你可以用来做出正确决定的建议。

#### 市场趋势

观察市场或竞争对手的当前趋势可以帮助你做出更明智的决定。我并不主张你从众，不管是好是坏，我建议你看看什么对别人有用，什么没用。市场趋势不会告诉您在设置环境方面付出了多少努力，也不会向您展示投资回报，但它确实会让您更好地了解一种产品是否比另一种产品使用得更多。你最不想做的事情就是把时间投入到将在 6-12 个月内被取代的东西上。

#### 亲自看

如果你不确定哪个产品适合你，我建议你自己安装和测试每个平台。我的建议是采用一个简单的用例，比如构建一个 web 服务器。不是安装操作系统，而是简单地安装和启动服务，将系统变成 web 服务器。这些任务很简单，应该很容易在每个不同产品的官方文档中找到。这种方法可以让你看到产品之间的比较。然后你可以比较一些东西，比如

*   文件。

*   平台安装起来有多容易？

*   编写和运行的代码有多简单？

*   入门的学习曲线有多陡？

这些要点将有助于您向组织的持有人展示您的发现，并证明在试用不同产品上花费的时间是合理的。

#### 企业对社区对成本

您需要企业产品还是可以使用社区产品？对于一些组织来说，这个问题通常会在提出这个问题后的几毫秒内得到回答，这主要是由于法规遵从性要求或其他类似原因。无论使用哪种产品的原因是什么，还有一个非常重要的方面需要考虑。

产品将带来的真实成本。这并不总是来自供应商的许可或订阅成本，而是使平台对您的组织有效的努力成本。许多人被基于好例子和预构建用例的供应商出售产品。这些供应商可能会忽略解释所需的培训或让所有东西都处于可用状态所需的时间。这可能会误导新用户，让他们认为平台是开箱即用的，几乎总是以平台未被使用而告终。当您花费时间测试和试用产品时，请确保您考虑了使您的组织能够尽可能有效地使用产品所需的努力。

#### 产品寿命周期

关于产品的路线图信息几乎和产品本身一样重要。该产品可以提供所有最强大的功能，并且看起来非常吸引人，但是如果您选择的产品只有很短的生命周期，并且不会有任何新版本发布，那么您就是在浪费您的时间，甚至可能是您组织的金钱。在承诺任何产品之前，确保路线图看起来是健康的。

## 借助管理工具实现自动化

为了更好地使用各种管理工具附带的自动化工具，让我们讨论一下您可以做些什么来改进您的资产管理。

### 国家管理

您希望自动化平台或遗产管理工具提供的一个非常重要的功能是保持遗产状态可控的能力。您希望配置您的资产管理或自动化平台工具，以监控和纠正可能出现的任何配置偏差。无论是出于意外还是恶意，您都希望确保下次系统重启时不会出现令人讨厌的意外。控制所有系统的状态将确保您的系统完全按照首次构建和测试时的状态运行。这对于进一步减少消防工作至关重要。

### 企业产品

不幸的是，提供最佳标准操作环境配置功能的资产管理工具通常是企业产品。Red Hat 的“卫星服务器”产品或 SUSE 的“SUSE 管理器”产品是当今 Linux 产业的最佳选择之一。两者都将包括木偶或盐栈。这些产品非常适合让您管理您的资产中系统的“状态”。它们的实现非常不同，需要一些提升技能的时间。不过积极的一面是文档非常好，而且由于您是付费服务，如果您需要任何帮助，也可以获得支持。在某种程度上，大多数支持公司都会尽力提供帮助。企业支持并不意味着供应商将免费提供专业服务，但他们会尽最大努力让您满意。最终，你是在为一个产品买单，你继续使用它符合他们的利益。

### 用例示例

要理解为什么使用某物很重要，看一个例子通常会有帮助。这是一个标准操作环境可以防止以后出现重大问题的基本示例。

#### 平台工具

在本例中，我们使用的是 Red Hat 资产管理工具“Satellite server 6.x”。这是 Red Hat 正在开发的卫星系统的最新版本。如果您愿意，这个示例也可以使用 SaltStack。只需在您的脑海中相应地调整命名和功能。

#### 平台工具配置

Red Hat Satellite 6 能够用特定的 Puppet 模块配置内容视图。这些模块可以进一步增强智能参数，帮助管理您的资产配置。

在这个例子中，一个主要的 Linux sysadmin 非常聪明地包含了一个 puppet 模块，它控制资产的标准 ssh_config 文件的配置。这使得整个资产以这样一种方式配置，即任何人都不能以 root 用户身份登录。

庄园中的所有系统都被配置为运行傀儡代理，这些代理定期向傀儡主人报告。

#### 错误

这个用例有趣的地方是当一个简单的错误发生时。

一个新的 Linux sysadmin 被分配了一项任务，在资产中的一个预生产系统上调试登录问题。在调试过程中，ssh_config 文件中偶然出现了一个简单的打字错误。不幸的是，如果输入错误，可能会导致 sshd 服务在重启时失败。由于 Linux sysadmin 不知道 ssh_config 文件的这一变化，他们不会重启任何服务，因为他们不相信有任何变化。他们为什么要重启服务，尤其是如果他们不想引起任何不必要的停机，不管停机的程度有多小。

#### 躺在阴影中等待

如果不选中，Linux sysadmin 所做的不需要的更改将在下一个维护窗口中应用。通常，在这些维护窗口期间，通常会应用更新或补丁。在大多数情况下，系统会重新启动。由于这个以前未被发现的错别字隐藏在阴影中等待着，因此在这个阶段，当时沉睡的问题将被唤醒，抬起它丑陋的头。如果在系统重新启动之前没有采取任何措施来纠正这个问题，那么 ssh 守护进程在重新启动之后将处于失效状态，不允许任何人通过 ssh 登录。

#### 安全网

由于组织足够聪明，有一个配置管理工具来监听不需要的配置更改，所以系统管理员的输入错误从来没有成为问题。

在 Linux sysadmin 输入错误后不久，受害者系统的本地 Puppet 代理在 Red Hat Satellite 服务器上向 Puppet master 登记，并将配置恢复到为环境配置 Puppet 时被认为是正确的配置。

如果没有安全网，一个简单的错误(如打字错误)可能会导致问题产生后可能发生的任何停机的调试延迟。如果这是一个生产系统，并且由于草率的工作而导致停机时间延长，那么对于不幸的 Linux 系统管理员来说，可能会有更大的影响。

是的，这个例子有办法通过登录到一个控制台来解决这个问题，但是如果这个配置比 grub 配置更严重呢？这意味着系统在预定的重新启动后可能没有启动，这实际上造成了一个本不应该出现的问题。

### 建立一个国有企业

为了避免与所解释的用例类似的问题，管理资产配置状态是至关重要的。要配置成功的 SOE 平台，您需要确保按照良好实践配置您的资产管理工具。这需要适当的计划、准备，在某些情况下还需要组织文化的改变。

#### 根据标准构建

要构建将由 SOE 环境管理的系统，您需要确保做到以下几点:

*   从标准系统构建模板/映像或 kickstart 文件构建。

*   新系统应该构建有所有必需的代理或服务，以便将新系统注册到您的配置管理平台。

*   确保您的系统注册到正确的环境中，并让配置管理将配置保持一致。

*   更新了配置漂移，以反映配置的当前状态。这样，如果有任何变化，您将有一个事件日志。

#### 源代码管理

任何管理遗产的代码都应该经过适当的代码开发过程。这意味着应该发生以下情况:

*   任何自动化的所有代码都应该存储在一个源代码控制平台中，比如 Git。

*   所有代码都应该通过林挺系统来检查基本的格式和语法问题。

*   应该通过拉请求或合并请求来完成更改。

*   两个不同的人应该参与代码评审。

*   如果没有经过分阶段的测试过程，就不应该将代码推入生产环境。

#### 分阶段测试

分阶段测试是在进入生产环境之前，通过不同的环境测试您的自动化和配置管理的过程。该方法应该类似于以下内容。

##### 代码开发

*   在沙盒环境中开发和测试的代码。

*   应该为新的配置管理制定一个测试计划，解释配置更改的情况以及如何对其进行验证。

##### 代码测试和同行评审

*   新代码被提交到一个本地 Git 存储库，该存储库具有 webhooks 或类似的管道工具，该工具运行基本的限制或语法测试。如果代码通过了测试，那么只有在那时才会打开一个新的合并或拉取请求以供同行评审。

*   第二个人应该对代码进行同行评审，并批准任何合并或拉取请求。

##### 代码升级

*   然后，代码可以被提升到第一个现场测试环境中。通常，这是一个开发环境或类似的环境。请记住，开发环境仍然是活跃的，因为它们上面有用户，所以建议谨慎。如果可能，避免理想情况下不能有停机时间的环境。

*   现在应该遵循设定的测试计划，以确保没有任何东西被破坏或导致任何问题。

*   如果一切都如预期的那样工作，并且变更已经被签署为成功的，那么将代码提升到您的下一个环境中。

## 自动化自动化

一旦您有了您的自动化平台，并且您熟悉自动化实践，您将想要开始发展您的实践，以包括更多的自动化途径。

### 自愈

让您的平台完全自动化是一个了不起的成就，任何 Linux 系统管理员都应该为此感到骄傲。采取下一步措施会把你的价值提升到一个全新的水平。

构建一个在灾难来袭时能够自我修复的平台是所有 Linux 系统管理员应该开始做的下一个主要进步。在过去，让您的平台能够识别系统故障并应用解决方案，而无需动动手指，这只有科幻电影才能做到。今天，您可以使用一系列工具或自行开发的技术来实现这一点。

#### 自我修复层

有几个层次可以发生自愈。有一个硬件层，“平台”层，最后是应用层。

每一层都有自己的失败区域和自己的恢复方法。如果我们从底层开始，我们来看看硬件层。

##### 消除所有单点故障

如果没有冗余，硬件可能很难自我修复。如果一个物理磁盘或主板出现故障，如果没有备用系统可供故障转移，再多的自动化或智能工具也救不了你。你总是做的第一件事是查看你的单点失败。因此，您需要为您的资产中运行的所有东西准备备份硬件。听起来很贵，对吧？是的，但是您倾向于只为无法承受停机时间的组织进行这种级别的智能资产恢复。

Ken’s Law 1

如果因停机而损失的金额超过了冗余硬件的成本，那么金钱就不应该是一个考虑因素。

##### 硬件层自我修复

大多数组织不在一套硬件设备上运行，或者至少不应该在一套硬件设备上运行。通常有第二个或第三个设备可供故障切换使用。

巧妙之处在于如何识别硬件故障，以及如何从故障硬件切换到健康硬件。

您需要聪明的逻辑，这需要关注平台监控和日志工具。这些工具可以让您的自我修复平台关注警报、事件和日志。不仅所有硬件都应该报告其自身组件的健康状况，硬件还应该寻找与它最接近的硬件的性能线索。

在硬件故障的情况下，自我修复系统应该有自动化的决策点来运行特定的操作。在发生完全未知的情况时，应该触发故障安全选项，这可能很简单，只需标记重大事故并让人员参与即可。从这些事件中吸取教训，会让你的平台得到提升，所以在你还在完善平台的时候，不要心灰意冷。不可能预测每一种可能的情况。

硬件自动化修复的基本流程应该如下所示。

###### 报告

1.  监控和日志记录系统应该接收到硬件未签入的事件。

2.  可疑的硬件故障也应通知财产管理工具。

###### 确保平台可用性

1.  故障转移应该自动发生，以确保停机时间有限或没有停机时间。

2.  如果故障转移失败，该过程将会中断。重大事件要提出来，要有人叫出来。

###### 自动恢复

1.  一旦发生故障转移，就可以开始自动恢复。

2.  应触发自动调查的第一轮。也就是说，离系统最近的任何其他硬件可以到达故障系统吗？

3.  如果已确定硬件出现故障，则应开始第一次尝试恢复。这可能是访问控制硬件的电源管理 API，并执行冷重启以查看硬件是否恢复。

4.  经过一段时间后，应触发第二轮调查，以查看故障硬件是否已开始响应。

5.  如果硬件已经恢复，应该运行一整套自动化测试来确认系统的健康状况。如果通过，平台可以回切到之前怀疑的硬件故障。

6.  如果硬件仍然没有响应，则逻辑应该做出决定，要么通过关闭当前硬件并从备用硬件供应新系统来废弃当前硬件，要么重建故障系统。
    1.  如果选择重建当前系统，则需要进行一项检查，以确定重启后是否可以通过网络启动选项访问失效的硬件。如果可以通过网络引导访问系统，则可以开始自动重建过程。

    2.  如果决定废弃故障硬件，自动自愈平台将需要联系电源管理 API 并引导备用硬件。需要完成操作系统的网络构建，然后按照资产配置进行配置，以使系统恢复在线工作负载。

7.  无论从步骤 6 中选择哪个选项，恢复的系统都需要重新加入任何群集，并将系统标记为可进行回切。

##### 平台层自我修复

鉴于硬件自我修复的复杂性，您可能不会惊讶于平台层往往具有一定程度的自我修复能力。“平台”通常是编排层，如 OpenShift 或 Tanzu(如果您使用容器),或者是虚拟化平台，如 VMware 或 Red Hat 虚拟化。这些平台旨在通过允许工作负载从停止响应的节点进行故障转移，自然确保工作负载继续工作。这与负载平衡器和冗余网络相结合，应该允许平台保持相当的弹性。

这是这些平台自我修复的终点。让整个平台恢复正常工作取决于您聪明的资产自我修复逻辑。在硬件自我修复部分，我们谈到了将硬件重新加入集群。这就是你的智能逻辑发挥作用的地方。与硬件自我修复一样，应该有一系列自动执行的步骤来确保平台自我修复:

1.  检查硬件可用性。应当有可供使用的系统的记录。这是您的重建系统或新建系统应该报告它们可用的地方。对于熟悉 OpenStack 的人来说，这就像一个报告可用性状态的裸机服务器列表。

2.  移除故障系统。在添加新硬件之前，应将标记为失效的系统从集群中删除，并完成所有清理工作。

3.  添加到集群。然后，应该将可用系统配置为新的节点或主机。配置应该包括将系统添加到集群并测试工作负载。如果全部通过，可以在节点或主机上重新安排工作负载。

##### 应用层自我修复

应用程序的自我修复通常应该由承载应用程序的应用服务器来完成，但是如果您更多地考虑应用程序的内部工作方式，也可以完成额外的自我修复。

可以通过自动化来控制应用程序数据健康或数据库连接的改善。如果数据库服务器变得不可用，可以进行重建并复制数据库。有相当多的事情可以做，但理想情况下，如果您的应用程序足够简单，所有需要做的就是重新部署和重定向流量。

对于更复杂的应用程序，开发人员需要内置应用程序从故障中恢复的功能。这个问题最好留给开发者。

### 何时自愈

构建您的自动化和自我修复平台应该基于您希望自我修复何时发生。您是希望只在出现故障时才注意，还是希望观察问题内在的迹象？

你想主动还是被动？

我相信你会同意，在问题变成更大的问题之前抓住它要好得多。通过积极主动，您可以让您的自我修复系统以一种更少干扰的方式解决问题。这可以让您的一个或多个系统正常关闭并重建。当流量减少时，可以安排故障转移，然后可以优雅地而不是强制地排空节点。通过允许以受控的方式进行重建，可以安排停机来适应组织过程，如适当的变更控制。有了这个流程，一切都可以自动化，包括获得平台变更批准的管理工作。

### 如何实现自我修复

从理论上讲，谈论自我修复是很简单的，但是你如何为你的产业实施这样的解决方案呢？为了充分讨论自我修复技术并做到公正，我们肯定需要另一本完整的书。但是，让我们简单地看一下如何从一些面包屑开始，以便进一步研究。

#### 盖茨

就像你需要闸门来控制运河中的水流一样，你也需要闸门来控制你的自我修复环境。这些门应该是验证刚刚发生的事情的停止点。如果没有首先检查一个简单的解决方案，您不会想要开始一个冗长的补救过程。也就是说，重启有效吗？

Gates 也不一定是技术配置。一个高度监管的组织可能不希望聪明的逻辑在未经批准的情况下重建系统。为此，您可以引入一个变更控制门。主动自我修复平台可以识别潜在问题并提出变更请求。如果变更请求获得批准，补救措施将在规定的变更窗口内继续进行。

另一个有用的方法是，在故障系统重建后，在故障流量返回之前暂停，以防未检测到潜在问题。

一般来说，在开发自我修复平台时，门应该是您首先要构建的东西。当你证明你的逻辑有效时，把它们看作是诊断停止。

#### 工具:自动化和状态管理

使用状态管理工具和自动化平台的组合，您应该能够将足够的逻辑串联起来，进行一些有趣的自我修复。您将需要解决如何解析日志中的重要信息。拥有一个像 Splunk 这样不断被清理的日志收集系统将允许您建立一个潜在问题的数据库。如果您的自我修复逻辑与任何可能的问题相匹配，那么您可以向消息总线报告问题。然后，您的自我修复资产的另一大部分可以监控消息总线，寻找需要自我修复作业运行的不同类型的作业。

一起运行的配置和应用程序可能会很快变得过于复杂。在开始构建之前，花足够的时间来设计您的方法，看看这是否是您的最佳选择。

#### 机器学习

开发你自己的自我修复平台的另一种方法是教它理解在特定条件下该做什么。为此，你需要建立一个场景的神经网络。这可能包括查看日志、警报和事件。然后，您的自我修复逻辑应该权衡与触发一系列自动化任务的条件相匹配的数据的百分比。然后可以从资产管理工具和自动化平台运行任务。目前可用的大多数工具还能够与服务台平台集成以提出事件，甚至能够启动与备用工程师的通信。

然而，机器学习是一个陡峭的学习曲线，需要一定的资质才能掌握。如果这是你感兴趣的东西，花些时间玩几个基本的例子，然后从那里开始。互联网是一个学习的好地方，到处都是你可以尝试的好例子。

关于开始机器学习的一个重要注意事项是，你将需要一些庞大的数字处理硬件来编译你的机器学习程序。如果你有幸拥有一个不错的 GPU，你可以从它开始。添加更多的 GPU 将减少你的编译时间，但随着 GPU 的普遍短缺，你可能会面临一场艰苦的斗争。

Tip

不要害怕二手硬件；当你开始使用时，使用别人不喜欢的旧硬件可能仍然会对你有所帮助，也会为你节省一些钱。

#### 现成的产品

如果您有预算，但没有时间或耐心来构建自己的平台，您可以考虑一些“现成的”选项。

这些产品可以提供相当多的功能，但可能无法满足您的所有需求。请密切注意开箱即用的内容以及您自己需要配置的内容。它可能是一个美化了的自动化引擎，仍然需要你写逻辑，或者更糟。购买一些组织的专业服务来为你构建逻辑。

##### 动态跟踪

我过去听说过的一种产品是 Dynatrace。我对该产品知之甚少，因为我以前从未使用过它，也不会根据我所知提出任何建议，所以我将让您自己研究和检查。我只记得 Dynatrace，因为几年前我参加了波士顿红帽峰会的一次演讲。

在演示过程中，演示者解释了他们如何使用 Dynatrace 来管理自己的资产，而在演示过程中，他们的一台 web 服务器发生了中断(可能是故意为之)。Dynatrace 平台基本上启动并开始运行其诊断和潜在的补救工作。然而，它确实通知了演示者有问题，我想任何监控平台都可以这样做。

我得到的印象是，Dynatrace 可以做一些聪明的事情，可能是一个很好的选择。就像我提到的，在开始之前做好自己的检查和测试。

## 自动化最佳实践

说到房产自动化，最终没有一份你可以遵循的最佳实践清单。在这方面，最好的建议是了解您决定使用的自动化平台的所有最佳实践。熟悉配置文件的位置以及应该如何配置它们。

### 不要再重复发明轮子了…

这是一个很多人都失败的领域，我相信你已经厌倦了我提到它，因为我已经说过至少几次了。这是很多人一直在做的事情，包括我自己，所以我希望在这本书结束时，通过一直提到它，它会如此深入你的内心，以至于你再也不会尝试重新发明任何东西。

永远不要试图从头开始开发任何东西，尤其是如果你能从网上得到与你想要的东西相似或不相同的东西。真的没有理由花时间在已经存在的东西上。尽一切办法，获取代码并调整它以适应您想要做的事情，但不要每次都从头开始开发。我知道有时候写一个角色或者木偶模块可能会更快，但是要诚实地问自己。

“这要写多久？”

如果答案超过五分钟，你就知道你在不必要的地方花了时间。您最好花额外的时间来测试和完善您的平台配置。

#### 代码库

大多数(如果不是所有的话)主要自动化平台都有大量的在线示例和代码库可供下载。如果您的第一步是决定使用哪个自动化平台，那么您的下一步应该是找到等价的在线代码或模块库。

##### 安塞波

在神秘世界里，你可以利用神秘星系。Ansible Galaxy 有大量不同的 Ansible 角色，你可以通过人们与它们相关联的标签来搜索和使用。

[`https://galaxy.ansible.com/`](https://galaxy.ansible.com/)

##### 木偶

和 Ansible 一样，Puppet 也有一个很棒的类似 Ansible Galaxy 的库，叫做 Puppet Forge。

[`https://forge.puppet.com/`](https://forge.puppet.com/)

##### 盐堆

SaltStack 没有完全相同的设置，但是有一个名为 SaltStack formulas 的 GitHub 位置，里面有大量的内容。

[`https://github.com/saltstack-formulas`](https://github.com/saltstack-formulas)

Note

Ansible 是我个人的选择；这就是为什么我经常用它作为例子。我尽量不直接推荐任何东西，因为我想避免偏向某个特定的供应商或产品。始终根据明智的意见做出自己的决定。

#### [计]元数据

一旦你有机会向你选择追随的社区贡献代码，确保你了解如何格式化和构建你的代码，以便正确的元数据可以用于编目你的工作。没有什么比提供没人能找到或使用的代码更令人沮丧的了。

使用您选择的提供商提供的示例可以帮助您入门。下载一个示例，并从那里“借用”代码。

### 要避免的事情

无论您决定使用什么平台，自动化时都要避免一些事情。

### Shell 脚本

如果可能，使用您选择的自动化工具提供的模块和代码。例如，Ansible 有丰富的 Ansible 模块库。不是所有的东西都是默认安装的，但是可以和 Ansible 集合一起安装。类似的方法也可用于其他平台。在使用 shell 脚本之前，一定要研究运行任务的最佳方式。

Shell 脚本往往是非等幂的，需要更多的代码来确保它们是等幂的。使用一个与平台 API 或类似的东西对话的预构建模块将为您处理所有额外的编码，并留给您整洁干净的代码。

### 不需要时重新启动服务

如果您的自动化代码有一个服务重启任务，千万不要为了重启而重启。使用控制代码检查服务是否确实需要重新启动。即使这可能是服务的轻微下降，但如果配置不正确，它会带来风险。一些服务可能会拒绝启动，最终导致停机。

### 使用旧版本

这似乎是显而易见的，但是请确保您使用的是您所选择的自动化工具的最新版本。如果您编写的代码将被弃用，文档可能不会总是更新。

### 正确版本文档

阅读最新的文档，或者至少是与您正在使用的自动化工具版本相匹配的文档。代码变更和模块被弃用，所以当您以后需要重构代码时，遵循旧的示例或旧的知识库文章会让您受到阻碍。

### 良好做法

因为在编写自动化代码时，有些事情你应该避免，所以在你的工作方法中也应该包含一些好的实践。

#### 排除故障

记住删除添加到代码中的额外调试步骤或任务。当你测试和开发你的代码时，它可能是有用的，但是在生产中使用时，它可能看起来不整洁。这也可能会让你遇到一些不必要的问题，这些问题来自那些不理解为什么在执行你的自动化任务时到处都有红线的人。

#### 不要忘记自述文件

当你不是独自工作时，记录你的代码供他人使用是非常重要的。自动化的全部意义在于节省时间；花时间向别人解释如何使用你的代码是违反直觉的。当您通过不同的共享门户在线共享代码时，这也是非常值得推荐的。开始时就习惯做，是继续做下去的最好方法。

#### 源代码管理

将你的代码提交给 GitHub/GitLab 或者任何你喜欢的 git 提供者，但是要经常这样做，并且总是在你一天停止工作之前。你的代码不仅是安全的，而且允许你建立一个作品集供他人使用。

## 摘要

在本章中，我们讨论了以下内容:

*   该理论围绕着自动化，什么时候自动化，什么时候不自动化。

*   开发幂等的代码意味着什么。

*   当今可用的各种自动化平台。为什么你会用它们，为什么你不会用它们。

*   什么是标准操作环境，以及如何将您的资产配置为标准操作环境。

*   如何配置硬件、系统平台和应用程序进行自我修复。

*   自动化最佳实践和应该避免的事情。