# 八、日志记录

在这一章中，我们将重点讨论一个我们作为 Linux 系统管理员花费大部分时间进行故障诊断的主题:日志。

我们将探索您可以使用的不同日志记录系统，如何读取日志，如何增加我们从日志中获得的信息，以及如何保护我们的系统，使日志不会给我们带来更多问题。最后，我们将探索日志应该如何以简洁和安全的方式卸载到外部日志记录系统。

## Linux 日志系统

有几个不同的选项可用于系统和应用程序日志。默认情况下，所有 Linux 系统都安装了 syslog 来管理本地日志。有一些 syslog 的替代品可以使用，或者您可以选择开发自己的系统。

我们将简要介绍的两个日志系统是 Rsyslog 和 Fluentd。

### rsyslog(rsyslog)

Rsyslog 默认安装在所有 Linux 系统上，并且几乎总是被使用，它是一个非常快速的日志记录系统，能够从运行在 Linux 平台上的几乎所有系统接收日志。Rsyslog 不仅可以从任何地方接收日志，还可以将日志从文件卸载到 MongoDB。

#### 模块化的

Rsyslog 以模块化的方式设计，允许用户选择他们想要使用 rsyslog 的内容。目前有许多可用的模块，从 snmp 陷阱配置到内核日志。有关您可以使用的所有不同模块的完整列表，请访问 rsyslog 官方网站:

[`www.rsyslog.com/doc/v8-stable/configuration/modules/index.html`](http://www.rsyslog.com/doc/v8-stable/configuration/modules/index.html)

#### 装置

如果由于某种非常奇怪的原因，rsyslog 没有被默认安装，您可以从您的标准包管理系统安装，比如 dnf 或 apt:

```sh
# dnf install rsyslog

```

如果您选择将 rsyslog 容器用作中央日志记录系统，也可以运行它。需要围绕存储和连接进行更多思考。

#### 服务

默认情况下，rsyslog 服务处于启用和启动状态，但可以通过标准的 systemd 方式停止或禁用:

```sh
# systemctl status rsyslog

```

#### 配置文件

rsyslog 的配置文件通过两个配置位置进行处理:

*   整体中央配置文件"`/etc/rsyslog.conf`"

*   的”。d "要存储的自定义配置文件的目录"`/etc/rsyslog.d/`"

您需要熟悉 Rsyslog 配置的三个主要部分:

*   全球指令

*   模板

*   规则和操作

##### 全球指令

rsyslog 的通用全局配置。示例包括启用和禁用附加模块和库位置。

##### 模板

模板使您能够格式化记录日志的方式，并允许动态生成文件名。如果您正在构建一个中央 rsyslog 系统，并且想要记录发送日志的系统的主机名，那么这是一个非常有用的配置。

##### 规则

规则由选择器和操作组成。这些字段设置了将记录的内容以及日志将发送到的位置。

###### 选择器字段

选择器字段由两部分组成，设施和优先级。这两部分由“.”分开性格。

以下条目是有效的工具类型:auth、authpriv、cron、daemon、kern、lpr、mail、news、syslog、user、uucp 和 local0 到 local7。

以下条目是可以使用的有效优先级:调试、信息、通知、警告、错误、关键、警报、紧急。

通配符“*”可用于替换区段字段的设施和优先级中的一个或两个。

选择器字段的示例可以是“`*.*`”、“`auth.*`”和“`auth.debug`”。

##### 行动领域

动作字段通常由日志文件的位置组成。但是，如果您愿意，其他操作也可以应用于特定的选择器。例如，写入数据库或将日志文件发送到远程日志系统。

行动也可以相当灵活；可以配置不同的协议、端口和接口来向远程系统发送日志。如果您运行一个专用的日志记录网络而不影响生产网络，这是很有用的。

Tip

利用不同的选择器来监控系统中不同文件中的关键错误。然后，这些日志可以导出到远程系统，以便在仪表板上立即发出警报。

## 流利

Fluentd 是一个开源项目，最初由一家名为 Treasure Data 的公司创建。

### 基于插件

Fluentd 是用 C 和 Ruby 编写的，它让用户能够灵活地使用 Fluentd。Fluentd 拥有超过 125 个用于输入和输出的插件，几乎可以用于任何可用的系统或云提供商。

### 大规模使用

使用 Fluentd 运行大规模环境是完全可能的，用户案例报告称 Fluentd 可以处理超过 50，000 个发送数据的系统。

### 装置

Fluentd 可以通过几种方式安装:标准包安装、从源代码安装或从容器运行。

#### 先决条件

安装 Fluentd 之前，需要满足几个先决条件:

*   配置 NTP。

*   将最大文件描述符增加到 65535。

*   针对性能敏感型环境优化网络内核参数。

*   使用粘滞位符号链接/硬链接保护。

关于这些先决条件的更多信息可以在 Fluentd 的官方安装文档中找到。

#### 手动安装

根据您的系统，可以通过运行与您的发行版匹配的脚本或安装所需的 Ruby gems 来安装 Fluentd。对于不受支持的平台，建议使用 gem 安装；对于受支持的平台，如 RHEL，建议使用 Fluentd 提供的脚本进行安装。

详细步骤应始终遵循官方文档。

#### 集装箱部署

Fluentd 也可以作为容器来部署，并且经常以这种方式部署。官方文档详细强调了成功部署需要遵循的所有步骤。

基本的高级步骤如下:

1.  从可靠或可信的来源获取 Fluentd 容器映像。

2.  创建一个基本的 fluentd.conf 配置文件。

3.  运行容器并发送日志。

Note

除了前面的步骤，还会有更多的步骤。此外，不要忘记你的防火墙。

### 配置

Fluentd 的主要配置文件是 fluentd.conf 文件。可以在官方在线文档或手册页中找到配置参数。基本配置文件如下所示:

```sh
<source>
  @type http
  port 9880
  bind 0.0.0.0
</source>
<match **>
  @type stdout
</match>

```

## 理解日志

让日志可用是发现或防止问题的第一步。理解日志实际告诉你的是另一个非常重要的步骤。

### 日志文件在哪里

在所有主要的企业级 Linux 发行版中，日志文件通常存储在“`/var/log`”目录中。这个目录通常应该安装在一个单独的磁盘分区上，以避免根文件系统在发生任何失控的日志记录时被填满。

Tip

如果您遵循任何强化准则，则/var/log 应该始终位于单独的分区上。

### 如何读取日志文件

可以使用安装在 Linux 发行版上的各种工具来查看日志。在普通系统上，您至少可以使用“`vi`”工具，但是您可以安装和使用任何您更喜欢的文本编辑器。

Warning

不要在生产系统上使用 vim 之类的工具打开几千兆字节大小的大型日志文件。文件内容将消耗大量内存，并可能导致您的问题。将大型日志复制到不同的系统以避免任何问题。

### 基础设施日志

告诉您关于 Linux 系统的事件、服务和系统的所有信息的日志是您的基础设施日志。这些日志是在 rsyslog.conf 配置文件中配置的标准日志，告诉您系统在后台正在做什么。这些日志将用于对任何系统问题进行故障排除，并可用于在问题发生前查找问题。

#### 重要日志

应该监控系统问题的日志如下。

##### /var/日志/消息

该日志用于存储有关系统的所有一般事件和信息。其他发行版如 Ubuntu 或 Debian 使用一个名为 syslog 的日志文件。如果您需要对任何问题进行故障诊断，该日志应该始终是您首先检查的地方之一。它可能没有所有的信息，但当你不知道从哪里开始时，它可以让你开始。

##### /var/log/secure

该日志文件用于身份验证事件。这个日志或 Ubuntu 和 Debian 中的/var/log/auth.log 是解决认证失败或登录尝试的最佳起点。

##### /var/log/boot.log

这一个的目的相当简单。这用于解决与引导相关的问题。这是一个非常有用的日志，可以用来查看系统停机的时间。

##### dmesg 日志所在位置

这用于记录有关系统硬件更改和故障的信息。如果您在检测添加或删除新硬件时遇到问题，这将非常有用。

##### (登录中)

如果使用 yum 作为软件包管理系统的发行版，您可以看到所有添加、更新或删除的软件包的历史记录。

##### 在哪里登录/cron

这是一个简单的日志，用于捕获所有成功或失败的 cron 相关任务。

### 应用程序日志

根据您的应用程序或您使用的应用服务器，日志文件可以存储在任何地方。应用程序开发人员需要确保记录重要信息，以便解决问题或跟踪事件。增加或减少冗长的能力也应该包括在内。

#### 良好实践

应用程序日志记录的一些良好实践应该包括以下内容。

##### 对日志使用/var/log 目录

确保所有日志都在/var/log 目录中，最好是在应用程序专用的子目录下。如果应用程序无法调整日志的发送位置，则可以将它们的目录符号链接到/var/log 目录。

##### 安全

在保存长期历史记录时，应该保护包含敏感信息的日志。日志目录的权限应该锁定给有权读取日志的用户和组。ACL 的使用有助于保持日志的安全。

##### 警告或以上

生产中的日志绝不能处于调试模式。日志应仅设置为警告或错误。这将使日志保持较小，并且仅在出现问题或报告错误时才进行报告。将日志级别设置得太低会导致/var/log 磁盘被填满。

Warning

在生产中调试从来都不是一个好主意。如果经常需要这样做，那么您的应用程序没有得到正确的测试，应该建议您不要部署新版本，除非经过严格的测试。

### 增加冗长度

当问题发生时，可能需要获得比已经提供的更多的信息。

#### 日志详细级别

编写良好的应用程序或平台都倾向于能够增加或减少日志的详细程度。在设置日志记录级别时，用户通常可以使用以下日志级别:

*   致命的

*   错误

*   警告

*   信息

*   调试

*   微量

生产应用程序或平台的默认设置通常应该设置为“警告”或“错误”如前所述，不建议在生产中调试，原因有二:

1.  打开调试通常需要重启应用程序或平台，当平台上有实时流量时，这并不容易做到。

2.  调试将增加磁盘使用量，并增加系统的额外负载。如果应用程序或平台出现重大问题，调试日志可能会快速增长，并可能会填满所有日志磁盘。

然而，当出现非常罕见的需求时，将日志详细度设置为“Debug”肯定会记录更多的信息，但会被限制为应用程序或平台认为是调试消息的信息。要得到你需要的信息，最好是从“警告”开始，一直到“追踪”，直到得到你需要的信息。一旦完成，总是将日志级别设置回“警告”或“错误”

## 日志维护

一个好的 Linux 系统管理员会确保所有的日志在不被使用的时候被循环使用和归档。一个优秀的 Linux 系统管理员将日志维护内置到所有的系统配置自动化中，再也不用担心这个问题了。

如果您以前从未管理过日志，则以下情况很可能是真的:

*   到目前为止，你很幸运。

*   您支持的平台没有记录足够的信息，因此不会成为问题。

*   日志被转发到由其他人管理的专用日志平台。

### 日志管理工具

#### Logrotate

对于任何 Linux 系统管理员来说，进行日志维护的第一步是配置 Logrotate。Logrotate 可以旋转、压缩和邮寄日志文件。Logrotate 由以下配置文件和目录管理:

*   /etc/logrotate.conf 文件
    *   用于全局配置

*   /etc/logrotate.d
    *   自定义配置文件

##### 装置

缺省情况下，Logrotate 安装在所有 enterprise Linux 发行版和大多数社区发行版上。

Logrotate 通过其手册页提供文档，为您提供足够的入门信息，包括示例。

## 日志转发

日志转发是当今大多数人的首选。像 Fluentd 这样的企业工具是将本地日志转移到一个中心位置的好方法。它消除了本地系统长期保留日志的需要，并减少了磁盘占用空间。

### 中央测井系统

现在有一些可以使用的中央日志记录系统，既有专有的也有开源的。在过去十年中，中央日志领域的知名公司有 Splunk、网络安全管理软件产品、Rsyslog、ElasticStack 和 Fluentd。最后三个是开源的，值得花时间去了解。

#### 弹性堆叠

也称为 ELK stack，由表 8-1 中列出的四种工具组成。

表 8-1

弹性堆叠工具

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"></colgroup> 
| 

工具

 | 

描述

 |
| --- | --- |
| `Elasticsearch` | 用于日志分析和搜索 |
| `Kibana` | 弹性搜索的用户界面 |
| `Logstash` | 用于日志摄取 |
| `Beats` | 用于向 Logstash 发送日志记录信息的代理 |

#### 流利

正如本章前面所讨论的，Fluentd 可以用作本地日志记录的替代品，也可以用作集中式日志记录平台。要将 Fluentd 用作中央日志记录平台，您的网络中需要有两个元素。

##### 日志转发器

日志转发器监控本地系统上的日志，筛选所需的信息，然后将信息发送到中央系统。对于 Fluentd，这将是一个日志聚合器。

Fluentd 有一个名为 Fluent Bit 的日志转发器，Fluentd 推荐使用。

Fluentd 转发器配置的示例如下所示:

```sh
<source>
  @type forward
  port 24224
</source>
<source>
  @type http
  port 8888
</source>
<match example.**>
  @type forward
  <server>
    host 192.168.100.1
    port 24224
  </server>
  <buffer>
    flush_interval 60s
  </buffer>
</match>

```

##### 日志聚合器

日志转发器的目的地是日志聚合器。它们由不断运行并接受日志信息进行存储的守护程序组成。然后，可以将日志导出或迁移到云环境中进行异地存储。

Fluentd 日志聚合配置示例可能类似于以下内容:

```sh
<source>
  @type forward
  port 24224
</source>
# Output
<match example.**>
  # Do some stuff with the log information
</match>

```

#### rsyslog(rsyslog)

如果您不想使用标准 enterprise Linux 发行版之外的任何东西，您可以坚持使用 Rsyslog 进行集中日志记录。

##### Rsyslog 聚合器

与 Fluentd 配置为使用日志转发器和聚合器非常相似，Rsyslog 也可以配置为使用日志转发器和聚合器。Rsyslog 可以配置为通过 tcp 或 udp 发送和接收日志。Rsyslog 也可以配置为使用证书安全地发送和接收日志。

作为 Rsyslog 服务器作为中央日志记录系统接收日志的最低要求，您需要确保具备以下条件:

1.  防火墙被禁用或配置为允许 tcp/udp 端口 514 或 6514，这取决于您是否使用转发日志的证书方法。

2.  如果启用了 SELinux，您将需要配置 SELinux 以允许 rsyslog 流量将消息记录到您的中央系统:

    ```sh
    semanage -a -t syslogd_port_t -p tcp 514
    semanage -a -t syslogd_port_t -p udp 514

    ```

3.  配置 NTP。

4.  配置 rsyslog.conf 使模块能够接收日志:

    ```sh
    $ModLoad imtcp
    $InputTCPServerRun 514

    ```

5.  重新启动 rsyslog 服务。

##### Rsyslog 货运代理

要将日志发送到中央 Rsyslog 服务器，还需要在 Linux 客户机系统上配置 rsyslog.conf 文件，以便将日志发送到中央服务器。使用 tcp 集中发送所有日志的简单配置如下:

```sh
*.*  @@192.168.0.1:514

```

Note

一个@用于 udp，而两个@@用于通过 tcp 发送。

与中央 Rsyslog 服务器一样，一旦更新了配置文件 rsyslog.conf，就需要重新启动 rsyslog 服务:

```sh
# systemctl restart rsyslog

```

## 摘要

在本章中，向您介绍了以下内容:

*   不同的 Linux 日志系统，包括 rsyslog 如何被 Fluentd 取代

*   如何理解日志以及在哪里可以找到它们

*   Linux 系统中的重要日志是什么，这些日志有什么用途

*   日志维护以及可以使用什么工具来防止日志填满您的 Linux 系统

*   可以使用什么将日志发送到中央日志记录系统