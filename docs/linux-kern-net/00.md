前言

这本书引导你深入了解当前的 Linux 内核网络实现及其背后的理论。近十年来，没有关于 Linux 网络的新书问世。十年动态和快节奏的 Linux 内核开发是一段相当长的时间。有一些重要的内核网络子系统没有在任何其他书中描述；例如，IPv6、IPsec、无线(IEEE 802.11)、IEEE 802.15.4、NFC、InfiniBand 等等。关于这些子系统的实现细节，网上的信息也很少。出于所有这些原因，我写了这本书。

大约十年前，我迈出了内核编程的第一步。我是一家初创公司的开发人员，参与了一个基于 Linux 的机顶盒(STB)的 VoIP 项目。一些 USB 摄像头的 USB 堆栈出现崩溃，我们不得不钻研代码来试图找到解决方案，因为该机顶盒的供应商不想花时间来解决问题。事实上，他们并不是不想做，而是不知道怎么做。在那些日子里，几乎没有关于 USB 堆栈的文档。当年 O'Reilly 出的 *Linux 设备驱动*书只有第二版(第三版才加了 USB 一章)。作为一家初创公司，该项目的成功对我们来说至关重要。在解决 USB 崩溃的过程中，我学到了很多关于内核编程的知识。后来，我们有一个项目需要 NAT 穿越解决方案。用户空间解决方案太重，以至于设备很快就崩溃了。当我提出一个内核解决方案时，我的经理非常怀疑，但他们确实让我尝试了。事实证明，内核解决方案非常稳定，占用的 CPU 比用户空间解决方案少得多。从那以后，我参加了许多内核网络项目。这本书是我多年开发和研究的成果。

这本书是给谁的

本书面向从事网络相关项目的计算机专业人员，包括开发人员、软件架构师、设计人员、项目经理和首席技术官。这些项目可能涉及广泛的专业领域，如通信、数据中心、嵌入式设备、虚拟化、安全等。此外，处理网络项目或网络研究或操作系统研究的学生和学院研究人员和理论家将在本书中找到大量帮助。

这本书的结构

在第 1 章中，你会看到 Linux 内核和 Linux 网络栈的概述。本章的其他主题包括网络设备的实现、套接字缓冲区以及 Rx 和 Tx 路径。[第 1 章](01.html)以一个关于 Linux 内核网络开发模型的部分结束。

在第 2 章中，您将了解 netlink 套接字，它提供了用户空间和内核之间的双向通信机制，网络子系统和其他子系统都使用它。你还会在本章中找到一个关于通用 netlink 套接字的部分，它可以被视为高级 netlink 套接字，你会在[第 12 章](12.html)和浏览内核网络源代码时遇到。

在[第 3 章](03.html)中，您将了解 ICMP 协议，它通过发送有关网络层(L3)的错误和控制消息来帮助保持系统正常运行。您将了解 ICMP 协议在 IPv4 和 IPv6 中的实现。

[第 4 章](04.html)深入探讨 IPv4 协议——互联网和现代生活离不开它。您将了解 IPv4 报头的结构、Rx 和 Tx 路径、IP 选项、碎片和碎片整理及其必要性，以及转发数据包，这是 IPv4 的重要任务之一。

第 5 章和第 6 章[专门讨论 IPv4 路由子系统。在](06.html)[第 5 章](05.html)中，您将了解路由子系统中的查找是如何执行的，路由表是如何组织的，IPv4 路由子系统中使用了哪些优化，以及 IPv4 路由缓存的移除。第 6 章讨论高级路由主题，如多播路由、策略路由和多路径路由。

第 7 章试图解释邻近的子系统。您将了解 IPv4 中使用的 ARP 协议，IPv6 中使用的 NDISC 协议，以及这两种协议之间的一些差异。您还将了解 IPv6 中的重复地址检测(DAD)机制。

[第八章](08.html)讨论 IPv6 协议，这似乎是解决 IPv4 地址短缺的必然方案。本章介绍了 IPv6 的实施，并讨论了 IPv6 地址、IPv6 报头和扩展报头、IPv6 中的自动配置、Rx 路径和转发等主题。它还描述了 MLD 协议。

第 9 章讲述了 netfilter 子系统。您将了解 netfilter 挂钩及其注册方式、连接跟踪、IP 表和网络地址转换(NAT)以及连接跟踪和 NAT 使用的回调。

第 10 章讨论 IPsec，它是最复杂的网络子系统之一。像 ike 协议(在用户空间中实现)和 IPsec 的加密方面的主题被简单地讨论了(完整的讨论超出了本书的范围)。您将了解 XFRM 框架，它是 Linux IPsec 子系统的基础，以及它的两个最重要的结构:XFRM 策略和 XFRM 状态。简要介绍了 ESP 协议，以及传输模式下的 IPsec Rx 路径和 Tx 路径。这一章以 XFRM 查找的一节和 NAT 穿越的一小段结束。

第 11 章描述了四种第 4 层协议，从最常用的协议 UDP 和 TCP 开始，以两种较新的协议 SCTP 和 DCCP 结束。

第 12 章讨论 Linux (IEEE 802.11)中的无线技术。您将了解 mac80211 子系统及其实现、各种无线网络拓扑、节能模式以及 IEEE 802.11n 和数据包聚合。本章中还有一节专门讨论无线网状网络。

[第 13 章](13.html)深入探讨 InfiniBand 子系统，这是一项在数据中心越来越受欢迎的技术。您将了解 RDMA 堆栈组织、InfiniBand 中的寻址、InfiniBand 数据包的组织以及 RDMA API。

[第 14 章](14.html)以对高级主题的讨论结束了这本书，例如 Linux 名称空间，特别是网络名称空间、忙轮询套接字、蓝牙子系统、IEEE 802.15.4 子系统、近场通信(NFC)子系统、PCI 子系统等等。

附录 A“Linux API”和 C，“词汇表”，为书中讨论的许多主题提供了完整的参考信息。附录 B“网络管理”提供了使用 Linux 内核网络时需要的各种工具的信息。

约定

在整本书中，我保持了一贯的风格。所有代码片段，无论是在文本段落内还是在它们自己的行上，连同库路径、shell 命令、URL 和其他与代码相关的元素，都以等宽字体设置，就像这样。新术语用*斜体*表示，其他强调可能用**粗体**表示。